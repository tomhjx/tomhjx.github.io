<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>AMQP协议</title>
    <url>/2020/10/18/AMQP%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h1 id="解决了什么问题？"><a href="#解决了什么问题？" class="headerlink" title="解决了什么问题？"></a>解决了什么问题？</h1><h2 id="如何降低发送者和接收者的耦合度？"><a href="#如何降低发送者和接收者的耦合度？" class="headerlink" title="如何降低发送者和接收者的耦合度？"></a>如何降低发送者和接收者的耦合度？</h2><ul>
<li>发送者与接受者没有直接关系，发送者只与中转服务交互，中转服务通过交换机以不同的策略转发消息到接受者所定义的消息队列</li>
</ul>
<h2 id="如何有效的将数据发送到相关的接收者？也就是说将接收者subscribe-不同的数据，如何做有效的filter。"><a href="#如何有效的将数据发送到相关的接收者？也就是说将接收者subscribe-不同的数据，如何做有效的filter。" class="headerlink" title="如何有效的将数据发送到相关的接收者？也就是说将接收者subscribe 不同的数据，如何做有效的filter。"></a>如何有效的将数据发送到相关的接收者？也就是说将接收者subscribe 不同的数据，如何做有效的filter。</h2><ul>
<li>消息队列与交换机通过路由规则绑定</li>
<li>用户可以控制消息队列和交换器的绑定规则，而不是依赖中间件自身的代码</li>
</ul>
<h2 id="权限控制？"><a href="#权限控制？" class="headerlink" title="权限控制？"></a>权限控制？</h2><p>虚拟主机(Virtual Hosts)</p>
<p>虚拟主机是服务器内的数据分区, 它为在共享基础设施上的管理带来了方便．<br>一个虚拟主机包括其命名空间，一组交换器，消息队列以及所有相关对象. 每个连接必须关联一个单个虚拟主机.<br>在认证后，客户端可在Connection.Open方法中选择虚拟主机. 这意味着，服务器上的认证方案可在此服务器上的所有虚拟主机上共享. 然而，对于每个虚拟主机来说，也可以独特的认证方案. 对于每个虚拟主机需要不同的身份验证方案的管理员应该使用单独的服务器。<br>连接中的所有通道都在同一个虚拟主机上工作.在同一个连接中，没有与不同虚拟主机通信的方式， 也没有在不断开连接重新开始的情况下，切换到其它虚拟主机的可能性.</p>
<h2 id="消费者如何通过自身的能力，对消息做流控？"><a href="#消费者如何通过自身的能力，对消息做流控？" class="headerlink" title="消费者如何通过自身的能力，对消息做流控？"></a>消费者如何通过自身的能力，对消息做流控？</h2><p>qos</p>
<h2 id="如何做到可扩展，甚至将这个通信模块发到cluster上？"><a href="#如何做到可扩展，甚至将这个通信模块发到cluster上？" class="headerlink" title="如何做到可扩展，甚至将这个通信模块发到cluster上？"></a>如何做到可扩展，甚至将这个通信模块发到cluster上？</h2><p>AMQP协议是一个二进制协议，具有一些现代特性：多通道（multi-channel），可协商（negotiated），异步、安全、便携、语言中立、高效的。其协议主要分成两层：</p>
<p><img src="https://pic4.zhimg.com/v2-631190d8c82a28c9e45e2a73ac59257b_b.jpg"></p>
<p><img src="https://pic4.zhimg.com/80/v2-631190d8c82a28c9e45e2a73ac59257b_720w.jpg"></p>
<p><strong>功能层（Functional Layer）：</strong>定义了一系列的命令</p>
<p><strong>传输层（Transport Layer）：</strong>携带了从应用 → 服务端的方法，用于处理多路复用、分帧、编码、心跳、data-representation、错误处理。</p>
<p>这样分层之后，可以把传输层替换为其它传输协议，而不需要修改功能层。同样，也可以使用同样的传输层，基于此实现不同的上层协议。可能RabbitMQ也是因为类似的原因，能够比较容易的支持MQTT、STOMP等协议的吧。</p>
<h2 id="如何让Priority高的接收者先接到数据？"><a href="#如何让Priority高的接收者先接到数据？" class="headerlink" title="如何让Priority高的接收者先接到数据？"></a>如何让Priority高的接收者先接到数据？</h2><p>消费者优先级允许你确保高优先级消费者活动（非阻塞）的时候接收消息，低优先消费者只有在高优先级消费者阻塞的时候接收消息。</p>
<p>通常，连接到队列上的活动消费者以循环的方式从队列接收消息。当消费者使用优先级，如果多个活动消费者存在，且具有相同的优先级，则消息轮流传递。</p>
<p>设置x-priority参数给basic.consume方法，值是一个整数值。未指定值的消费者默认是0，数字越大优先级越高，可以使用正数和负数。</p>
<h2 id="信息的发送者和接收者如何维持这个连接，如果一方的连接中断，这期间的数据是以什么方式丢失？"><a href="#信息的发送者和接收者如何维持这个连接，如果一方的连接中断，这期间的数据是以什么方式丢失？" class="headerlink" title="信息的发送者和接收者如何维持这个连接，如果一方的连接中断，这期间的数据是以什么方式丢失？"></a>信息的发送者和接收者如何维持这个连接，如果一方的连接中断，这期间的数据是以什么方式丢失？</h2><ul>
<li><p>服务端收到消息，交换器（大部分情况）把消息路由到若干个该服务器上的消息队列中。如果这个消息找不到路由，则会丢弃或者退回给生产者（生产者可自行决定）。</p>
</li>
<li><p>消息到达消息队列。消息队列会立即尝试通过AMQP将其传递给消费者。 如果做不到，消息队列将消息存储（按生产者的要求存储在内存中或磁盘上），并等待消费者准备就绪。 如果没有消费者，则消息队列可以通过AMQP将消息返回给生产者（同样，如果生产者要求这样做）。</p>
</li>
<li><p>当消息队列可以将消息传递给消费者时，它将消息从其内部缓冲区中删除。 可以立即删除，也可以在使用者确认其已成功处理消息之后删除(ack)。 由消费者选择“确认”消息的方式和时间。消费者也可以拒绝消息（否定确认）。</p>
</li>
<li><p><strong>持久化消息队列</strong>：由很多消费者共享。当消费者都退出后，队列依然存在，并会继续收集消息。</p>
</li>
<li><p><strong>临时消息队列：</strong>临时消息队列对于消费者是私有和绑定的。当消费者断开连接，则消息队列被删除。</p>
</li>
</ul>
<h2 id="如何做到Load-Balance？有效均衡接收者的负载？"><a href="#如何做到Load-Balance？有效均衡接收者的负载？" class="headerlink" title="如何做到Load Balance？有效均衡接收者的负载？"></a>如何做到Load Balance？有效均衡接收者的负载？</h2><ul>
<li>AMQP实现了Topic订阅的分发模型。这可以让订阅在合作的订阅者间进行负载均衡</li>
</ul>
<h2 id="如何保证接收者接收到了完整，正确的数据？"><a href="#如何保证接收者接收到了完整，正确的数据？" class="headerlink" title="如何保证接收者接收到了完整，正确的数据？"></a>如何保证接收者接收到了完整，正确的数据？</h2><h3 id="分帧方式"><a href="#分帧方式" class="headerlink" title="分帧方式"></a>分帧方式</h3><p>客户端连接时，和服务端协商可接受的配置。当两个节点达成一致后，连接才能继续使用。通过协商，可以让我们断言假设和前提条件。主要协商这几方面的信息</p>
<ul>
<li>  实现的协议和版本。服务端可能会在同一端口提供多种协议的支持</li>
<li>  加密参数和验证</li>
<li>  最大帧尺寸、Channel的数量、某些操作的限制。</li>
</ul>
<p>如果协商达成一致，双方会根据协商预分配缓冲区避免死锁。传入的帧如果满足协商条件，则认为其实安全的。如果超过了，那么另一方必须断开连接。</p>
<h3 id="帧细节"><a href="#帧细节" class="headerlink" title="帧细节"></a>帧细节</h3><p>帧头包括：帧类型、通道、尺寸。帧尾包含错误检测信息。</p>
<p><img src="https://pic1.zhimg.com/v2-22dc06024428c024d7c645726fb6f08c_b.png"></p>
<p><img src="https://pic1.zhimg.com/80/v2-22dc06024428c024d7c645726fb6f08c_720w.png"></p>
<p>处理一个帧的步骤：</p>
<ol>
<li> 读帧头，检查帧类型和Channel</li>
<li> 根据帧类型，读取payload并处理</li>
<li> 读帧尾校验</li>
</ol>
<h3 id="消费者ack机制"><a href="#消费者ack机制" class="headerlink" title="消费者ack机制"></a>消费者ack机制</h3><h1 id="存在什么问题？"><a href="#存在什么问题？" class="headerlink" title="存在什么问题？"></a>存在什么问题？</h1><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><p><a href="https://zhuanlan.zhihu.com/p/147675691">AMQP协议学习</a></p>
</li>
<li><p><a href="https://www.rabbitmq.com/protocol.html">AMQP 0-9-1 Protocol Specification</a></p>
</li>
<li><p><a href="http://www.blogjava.net/qbna350816/archive/2016/08/12/431554.html">AMQP 0.9.1 完整的中文翻译</a></p>
</li>
<li><p><a href="https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf">AMQP 0.9.1 规范</a></p>
</li>
<li><p><a href="https://www.rabbitmq.com/amqp-0-9-1-errata.html">RabbitMQ 对于 AMQP 0.9.1 的勘误</a></p>
</li>
<li><p><a href="https://www.rabbitmq.com/extensions.html">RabbitMQ 对与 AMQP 0.9.1 的扩展</a></p>
</li>
<li><p><a href="https://www.amqp.org/specification/1.0/amqp-org-download">AMQP 1.0 最终版</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>开发</category>
        <category>中间件</category>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>消息队列</tag>
      </tags>
  </entry>
  <entry>
    <title>GIT SSH keys</title>
    <url>/2016/03/20/GIT-SSH-keys/</url>
    <content><![CDATA[<p>生成key</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;tomhjx&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查key内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/id_rsa.pub</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>版本管理</category>
        <category>GIT</category>
      </categories>
      <tags>
        <tag>GIT</tag>
      </tags>
  </entry>
  <entry>
    <title>GIT命令</title>
    <url>/2016/03/20/GIT%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="简单理解命令"><a href="#简单理解命令" class="headerlink" title="简单理解命令"></a>简单理解命令</h2><p><a href="http://zhuanlan.zhihu.com/FrontendMagazine/19845650">http://zhuanlan.zhihu.com/FrontendMagazine/19845650</a></p>
<p><a href="http://www.open-open.com/lib/view/open1335879873983.html">http://www.open-open.com/lib/view/open1335879873983.html</a></p>
<h2 id="速查"><a href="#速查" class="headerlink" title="速查"></a>速查</h2><p><a href="http://www.jb51.net/article/55442.htm">http://www.jb51.net/article/55442.htm</a></p>
<p><a href="http://www.codeceo.com/article/git-command-guide.html">http://www.codeceo.com/article/git-command-guide.html</a></p>
<p><a href="http://www.codeceo.com/article/git-command-list.html">http://www.codeceo.com/article/git-command-list.html</a></p>
<h3 id="创建版本库"><a href="#创建版本库" class="headerlink" title="创建版本库"></a>创建版本库</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">git clone &lt;url&gt;                                           #克隆远程的版本库 </span><br><span class="line">git init                                                        #初始化本地版本库 </span><br><span class="line">git checkout -b 本地分支名 远程分支名        #获取远程分支的代码 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="修改和提交"><a href="#修改和提交" class="headerlink" title="修改和提交"></a>修改和提交</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git status                                                   #查看状态 </span><br><span class="line">git diff                                                      #查看变更内容 </span><br><span class="line">git add                                                      #跟踪所有改动过的文件 </span><br><span class="line">git add &lt;file&gt;                                           #跟踪指定的文件 </span><br><span class="line">git mv &lt;old&gt; &lt;new&gt;                                #文件改名 </span><br><span class="line">git rm &lt;file&gt;                                             #删除文件 </span><br><span class="line">git rm --cached &lt;file&gt;                              #停止跟踪文件但不删除 </span><br><span class="line">git commit -m &quot;commit message&quot;            #提交所有更新过的文件 </span><br><span class="line">git commit --amend                                #修改最后一次提交 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看提交历史"><a href="#查看提交历史" class="headerlink" title="查看提交历史"></a>查看提交历史</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log                                                    #查看提交的历史 </span><br><span class="line">git log -p &lt;file&gt;                                     #查看指定文件的提交历史 </span><br><span class="line">git blame &lt;file&gt;                                     #以列表方式查看指定文件的提交历史 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="撤消"><a href="#撤消" class="headerlink" title="撤消"></a>撤消</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">git reset --hard HEAD                          #撤消工作目录中所有未提交文件的修改内容 </span><br><span class="line">git checkout HEAD &lt;file&gt;                   #撤消指定的未提交文件的修改内容 </span><br><span class="line">git revert &lt;commit&gt;                           #撤消指定的提交</span><br><span class="line">git reset --hard HEAD                         #放弃暂存区B和工作目录C的所有修改，恢复最近一次提交状态 （A -&gt;C 所有文件) </span><br><span class="line">git checkout -- &lt;file_name&gt;              #恢复某文件到最近一次提交状态，放弃checkout后的修改 (A -&gt; C 指定文件) </span><br><span class="line">git revert HEAD                                 #撤消最近的一个提交 （针对已经的commit，跟B和C无关） </span><br><span class="line">git revert HEAD^                              # 撤消上次”(next-to-last)的提交 （^ 个数可以递增）</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="分支与标签"><a href="#分支与标签" class="headerlink" title="分支与标签"></a>分支与标签</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git branch                                                     #显示所有本地分支 </span><br><span class="line">git branch &lt;branchName&gt;                           #创建新分支 </span><br><span class="line">git checkout &lt;branchName/tagName&gt;        #切换到指定分支或标签 </span><br><span class="line">git checkout -b &lt;branchName&gt;                   #创建新分支并切换到该分支</span><br><span class="line">git branch -d &lt;branchName&gt;                      #删除本地分支</span><br><span class="line">git branch -D &lt;branchName&gt;                     #强制删除本地分支 </span><br><span class="line">git tag                                                         #列出所有本地标签 </span><br><span class="line">git tag &lt;tagname&gt;                                     #基于最新提交创建标签 </span><br><span class="line">git tag -d &lt;tagname&gt;                                #删除标签 </span><br><span class="line"></span><br><span class="line">git checkout [options] [&lt;branchName&gt;] -- &lt;file&gt;... #复制文件到指定分支</span><br><span class="line">git diff &lt;branch&gt; --stat                                           #比较branch分支与当前分支差异 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="合并与衍合"><a href="#合并与衍合" class="headerlink" title="合并与衍合"></a>合并与衍合</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git merge &lt;branch&gt;                       #合并指定分支到当前分支 </span><br><span class="line">git rebase &lt;branch&gt;                      #衍合指定分支到当前分支 </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="远程操作"><a href="#远程操作" class="headerlink" title="远程操作"></a>远程操作</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git remote -v                                          #查看远程版本库信息 </span><br><span class="line">git remote show &lt;remote&gt;                    #查看指定远程版本库信息 </span><br><span class="line">git remote add &lt;remote&gt; &lt;url&gt;            #添加远程版本库 </span><br><span class="line">git fetch &lt;remote&gt;                                #从远程库获取代码 </span><br><span class="line">git pull &lt;remote&gt; &lt;branchName&gt;         #下载代码及快速合并 </span><br><span class="line">git push &lt;remote&gt; &lt;branchName&gt;       #上传代码及快速合并 </span><br><span class="line">git push &lt;remote&gt; : &lt;branchName/tag-name&gt;    #删除远程分支或标签 </span><br><span class="line">git push --tag                           #上传所有标签</span><br><span class="line">git branch -r                            #查看远程分支</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git rm --cached readme.txt # 文件放弃跟踪，但是还是保留在工作目录中。 没有--cached 选项，就完全删除文件 </span><br><span class="line">git rm filename            #直接删除文件</span><br><span class="line">通过“git rm --cached README.txt”命令，可以将文件状态还原为未暂存状态，即回到“Untracked files”文件状态。 </span><br><span class="line">通过“git add README.txt”命令将已修改文件更新到暂存区域中，如果想撤销修改，可以使用“git checkout -- README.txt”命令。 </span><br><span class="line">通过git reset HEAD &lt;file&gt;取消暂存 </span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>版本管理</category>
        <category>GIT</category>
      </categories>
      <tags>
        <tag>GIT</tag>
      </tags>
  </entry>
  <entry>
    <title>HTML to PDF</title>
    <url>/2020/05/18/HTML-to-PDF/</url>
    <content><![CDATA[<p><a href="https://www.sejda.com/html-to-pdf">https://www.sejda.com/html-to-pdf</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>High Quality Gifs with FFMPEG</title>
    <url>/2020/03/01/High-Quality-Gifs-with-FFMPEG/</url>
    <content><![CDATA[<p>After getting FFMPEG installed, let’s try it out on a MOV downloaded from my google photos account:</p>
<p>ffmpeg -i MVI_6654.MOV firsttry.gif</p>
<p>We’re calling the ffmpeg program and telling it that MVI_6654.MOV is our input file with the -i flag. the filename at the end defines the conversion and creates the new file, resulting in:</p>
<p><img src="https://miro.medium.com/freeze/max/60/1*VDw1ZRa5oeGyp8FgJcBPDQ.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*VDw1ZRa5oeGyp8FgJcBPDQ.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*VDw1ZRa5oeGyp8FgJcBPDQ.gif"></p>
<p>Pretty cool. But I bet I can make it loop nicely by just using the first few seconds, so we use the duration flag, -t and specify the duration in seconds.</p>
<p>ffmpeg -t 2 -i MVI_6654.MOV secondtry.gif</p>
<p><img src="https://miro.medium.com/freeze/max/60/1*RTZ2pIIqherofg_LG5vwEw.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*RTZ2pIIqherofg_LG5vwEw.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*RTZ2pIIqherofg_LG5vwEw.gif"></p>
<p>So it loops! kinda slow tho, maybe we can drop every other frame? A-ha. Thanks to the -r flag, we can choose a frame rate for the output (note that these options do different things based on their order. -t is used before the -i input, -r is used after the input, so it affects the output.)</p>
<p>ffmpeg -t 2 -i MVI_6654.MOV -r “15” thirdtry.gif</p>
<p><img src="https://miro.medium.com/freeze/max/60/1*FsdQXYxpB-EI2ZhHSCLZkw.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*FsdQXYxpB-EI2ZhHSCLZkw.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*FsdQXYxpB-EI2ZhHSCLZkw.gif"></p>
<p>That’s more like it. As an added benefit, the file is now 2 megabytes instead of 8 megabytes. I’ve got another one to convert that has kind of a long input video, so I’m going to specify a time to start the gif as well as the duration. The -ss flag defines the starting point. Oh yeah, and your seconds can be decimals. If you have a longer video and want to define the starting position in hours, minutes, seconds, you can use “hh:mm:ss” format, like “00:00:03” instead of “3”</p>
<p>ffmpeg -t 3 -ss 0.5 -i MVI_6663.MOV -r “15” fourthtry.gif</p>
<p><img src="https://miro.medium.com/freeze/max/60/1*Oh2K7GYaKkGvPWbHFRIX1g.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*Oh2K7GYaKkGvPWbHFRIX1g.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*Oh2K7GYaKkGvPWbHFRIX1g.gif"></p>
<p>This has been pretty simple, but I know I’ve seen better looking gifs. Let’s find out how to make it look more like a video…</p>
<p>Learned a lot from <a href="http://blog.pkh.me/p/21-high-quality-gif-with-ffmpeg.html">this blog</a> about the color palette algorithms.</p>
<p>Found a relatively simple example on <a href="http://superuser.com/questions/556029/how-do-i-convert-a-video-to-gif-using-ffmpeg-with-reasonable-quality">stackoverflow</a>.</p>
<p>We have to generate a custom color palette so we don’t waste space storing colors we don’t use (the gif file format is limited to 256 colors):</p>
<p>ffmpeg -ss 2.6 -t 1.3 -i MVI_7035.MOV -vf \ fps=15,scale=320:-1:flags=lanczos,palettegen palette.png</p>
<p>You should recognize what -ss, -t, and -i do here, -vf is a way to invoke filters on our video. so we can describe fps and scale here. Hm. I’ll admit I don’t know what -1 does. But the flags describe what algorithm to use, more info in <a href="http://blog.pkh.me/p/21-high-quality-gif-with-ffmpeg.html">that blog.</a> So that generates palette.png which we can use in our 2nd line in terminal (by the way, the backslash at the end of the line is if you run out of space and need to keep typing, hit backslash and return and you can keep going on a new line before hitting return to complete the command.)</p>
<p>ffmpeg -ss 2.6 -t 1.3 -i MVI_7035.MOV -i palette.png \<br>-filter_complex “fps=15,scale=400:-1:flags=lanczos[x];[x][1:v]paletteuse” sixthtry.gif</p>
<p>This uses our .MOV as an input but has a second -i flag to use palette.png as a 2nd input. Then, ok, I copy pasted the rest of it, but I’m happy enough with what this produces that I’ll stop asking questions :D</p>
<p>Let me know if there’s anything I can explain in more detail, but don’t ask me for help installing things, just google it!</p>
<p><img src="https://miro.medium.com/freeze/max/60/1*gC4a2M0vjVwC11AXLWCDlw.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*gC4a2M0vjVwC11AXLWCDlw.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*gC4a2M0vjVwC11AXLWCDlw.gif"></p>
<p><img src="https://miro.medium.com/freeze/max/60/1*MlhOASp3JnURJINT7dFCfA.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/500/1*MlhOASp3JnURJINT7dFCfA.gif"></p>
<p><img src="https://miro.medium.com/max/1000/1*MlhOASp3JnURJINT7dFCfA.gif"></p>
<p><img src="https://miro.medium.com/freeze/max/60/1*Oh2K7GYaKkGvPWbHFRIX1g.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*Oh2K7GYaKkGvPWbHFRIX1g.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*Oh2K7GYaKkGvPWbHFRIX1g.gif"></p>
<p><img src="https://miro.medium.com/freeze/max/60/1*rAjGjHJF0qd-KZLetlLt9A.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/500/1*rAjGjHJF0qd-KZLetlLt9A.gif"></p>
<p><img src="https://miro.medium.com/max/1000/1*rAjGjHJF0qd-KZLetlLt9A.gif"></p>
<p><img src="https://miro.medium.com/freeze/max/60/1*FsdQXYxpB-EI2ZhHSCLZkw.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/640/1*FsdQXYxpB-EI2ZhHSCLZkw.gif"></p>
<p><img src="https://miro.medium.com/max/1280/1*FsdQXYxpB-EI2ZhHSCLZkw.gif"></p>
<p><img src="https://miro.medium.com/freeze/max/60/1*L7SV27tMNds0K1BE5o5u-g.gif?q=20"></p>
<p><img src="https://miro.medium.com/max/500/1*L7SV27tMNds0K1BE5o5u-g.gif"></p>
<p><img src="https://miro.medium.com/max/1000/1*L7SV27tMNds0K1BE5o5u-g.gif"></p>
<p>Side by side comparison of easy, default color palettes and head-scratching custom color palettes</p>
<p>I’d like to revisit this with more general advice and showing off other aspects of ffmpeg, but in the meantime here’s articles that others’ found helpful.</p>
<p><a href="https://rigor.com/blog/2015/12/optimizing-animated-gifs-with-html5-video">Optimizing Animated GIFs by Converting to HTML5 Video - Rigor</a></p>
]]></content>
      <categories>
        <category>多媒体</category>
        <category>ffmpeg</category>
      </categories>
      <tags>
        <tag>ffmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>How to Set or Change Hostname in CentOS 7</title>
    <url>/2020/05/25/How-to-Set-or-Change-Hostname-in-CentOS-7/</url>
    <content><![CDATA[<p>A computer hostname represents a unique name that gets assigned to a computer in a network in order to uniquely identify that computer in that specific network. A computer hostname can be set to any name you like, but you should keep in mind the following rules:</p>
<ul>
<li>  hostnames can contain letters (from a to z).</li>
<li>  hostnames can contain digits (from 0 to 9).</li>
<li>  hostnames can contain only the hyphen character <code>( – )</code> as special character.</li>
<li>  hostnames can contains the dot special character <code>( . )</code>.</li>
<li>  hostnames can contain a combination of all three rules but must start and end with a letter or a number.</li>
<li>  hostnames letters are case-insensitive.</li>
<li>  hostnames must contains between 2 and 63 characters long.</li>
<li>  hostnames should be descriptive (to ease identifying the computer purpose, location, geographical area, etc on the network).</li>
</ul>
<p>In order to display a computer name in <strong>CentOS 7</strong> and <strong>RHEL 7</strong> systems via console, issue the following command. The <code>-s</code> flag displayed the computer short name (hostname only) and the <code>-f</code> flag displays the computer FQDN in the network (only if the computer is a part of a domain or realm and the FQDN is set).</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hostname</span></span><br><span class="line"><span class="comment"># hostname -s</span></span><br><span class="line"><span class="comment"># hostname -f</span></span><br></pre></td></tr></table></figure>

<p>[<img src="https://www.tecmint.com/wp-content/uploads/2017/12/Check-Hostname-in-CentOS-7.png" alt="Check Hostname in CentOS 7"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Check-Hostname-in-CentOS-7.png" alt="Check Hostname in CentOS 7"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Check-Hostname-in-CentOS-7.png" alt="Check Hostname in CentOS 7"></p>
<p>Check Hostname in CentOS 7</p>
<p>You can also display a Linux system hostname by inspecting the content of <strong>/etc/hostname</strong> file using the <a href="https://www.tecmint.com/13-basic-cat-command-examples-in-linux/">cat command</a>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/hostname</span></span><br></pre></td></tr></table></figure>

<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Display-CentOS-7-Hostname.png" alt="Display CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Display-CentOS-7-Hostname.png" alt="Display CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Display-CentOS-7-Hostname.png" alt="Check Hostname in CentOS 7"></p>
<p>Display CentOS 7 Hostname</p>
<p>In order to change or set a <strong>CentOS 7</strong> machine hostname, use the <strong>hostnamectl</strong> command as shown in the below command excerpt.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hostnamectl set-hostname your-new-hostname</span></span><br></pre></td></tr></table></figure>

<p>In addition to <strong>hostname</strong> command you can also use <strong>hostnamectl</strong> command to display a Linux machine hostname.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hostnamectl</span></span><br></pre></td></tr></table></figure>

<p>In order to apply the new hostname, a system <strong>reboot</strong> is required, issue one of the below commands in order to reboot a CentOS 7 machine.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># init 6</span></span><br><span class="line"><span class="comment"># systemctl reboot</span></span><br><span class="line"><span class="comment"># shutdown \-r</span></span><br></pre></td></tr></table></figure>

<p>[<img src="https://www.tecmint.com/wp-content/uploads/2017/12/Set-CentOS-7-Hostname.png" alt="Set CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Set-CentOS-7-Hostname.png" alt="Set CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Set-CentOS-7-Hostname.png" alt="Set CentOS 7 Hostname"></p>
<p>Set CentOS 7 Hostname</p>
<p>A second method to setup a <strong>CentOS 7</strong> machine hostname is to manually edit the <strong>/etc/hostname</strong> file and type your new hostname. Also, a system reboot is necessary in order to apply the new machine name.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/hostname</span></span><br></pre></td></tr></table></figure>

<p>A third method that can be used to change a <strong>CentOS 7</strong> machine hostname is by using Linux <strong>sysctl</strong> interface. However, using this method to change machine name results in setting-up the machine transient hostname.</p>
<p>The transient hostname is a special hostname initialized and maintained only by the Linux kernel as an auxiliary machine name in addition to he static hostname and doesn’t survive reboots.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sysctl kernel.hostname</span></span><br><span class="line"><span class="comment"># sysctl kernel.hostname=new-hostname</span></span><br><span class="line"><span class="comment"># sysctl -w kernel.hostname=new-hostname</span></span><br></pre></td></tr></table></figure>

<p>To display machine transient hostname issue the below commands.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sysctl kernel.hostname</span></span><br><span class="line"><span class="comment"># hostnamectl</span></span><br></pre></td></tr></table></figure>

<p>[<img src="https://www.tecmint.com/wp-content/uploads/2017/12/Change-CentOS-7-Hostname.png" alt="Change CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Change-CentOS-7-Hostname.png" alt="Change CentOS 7 Hostname"></p>
<p><img src="https://www.tecmint.com/wp-content/uploads/2017/12/Change-CentOS-7-Hostname.png" alt="Change CentOS 7 Hostname"></p>
<p>Change CentOS 7 Hostname</p>
<p>Finally, the <strong>hostnamectl</strong> command can be used to achieve the following hostname setups: <strong>–pretty</strong>, <strong>–static</strong>, and <strong>–transient</strong>.</p>
<p>Although, there are other more specific ways to <a href="https://www.tecmint.com/set-hostname-permanently-in-linux/">change a Linux machine hostname</a>, such as issuing <strong>nmtui command</strong> or manually editing some configuration files specific to each Linux distribution (<strong>/etc/sysconfig/network-scripts/ifcfg-ethX</strong> for CentOS), the above rules are general available regardless of the used Linux distribution.</p>
]]></content>
      <categories>
        <category>操作系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下如何查找某文件夹下最近1小时内修改过的文件</title>
    <url>/2016/11/05/Linux%E4%B8%8B%E5%A6%82%E4%BD%95%E6%9F%A5%E6%89%BE%E6%9F%90%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%8B%E6%9C%80%E8%BF%911%E5%B0%8F%E6%97%B6%E5%86%85%E4%BF%AE%E6%94%B9%E8%BF%87%E7%9A%84%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">find /home/user -type f -cmin -60</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux的inode是什么</title>
    <url>/2016/06/04/Linux%E7%9A%84inode%E6%98%AF%E4%BB%80%E4%B9%88/</url>
    <content><![CDATA[<p>转自：<br><a href="http://www.ruanyifeng.com/blog/2011/12/inode.html">http://www.ruanyifeng.com/blog/2011/12/inode.html</a><br><a href="http://blog.s135.com/post/295/">http://blog.s135.com/post/295/</a><br><a href="http://hi.baidu.com/leejun_2005/blog/item/d9aa13a53b3af6e99152ee7e.html">http://hi.baidu.com/leejun_2005/blog/item/d9aa13a53b3af6e99152ee7e.html</a> </p>
<p>一、inode是什么？</p>
<p>理解inode，要从文件储存说起。<br>文件储存在硬盘上，硬盘的最小存储单位叫做”扇区”（Sector）。每个扇区储存512字节（相当于0.5KB）。</p>
<p>操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个”块”（block）。这种由多个扇区组成的”块”，是文件存取的最小单位。”块”的大小，最常见的是4KB，即连续八个 sector组成一个 block。</p>
<p>文件数据都储存在”块”中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做inode，中文译名为”索引节点”。</p>
<p>二、inode的内容<br>inode包含文件的元信息，具体来说有以下内容：<br>　　* 文件的字节数<br>　　* 文件拥有者的User ID<br>　　* 文件的Group ID<br>　　* 文件的读、写、执行权限<br>　　* 文件的时间戳，共有三个：ctime指inode上一次变动的时间，mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。<br>　　* 链接数，即有多少文件名指向这个inode<br>　　* 文件数据block的位置</p>
<p>可以用stat命令，查看某个文件的inode信息：<br>stat example.txt</p>
<p>总之，除了文件名以外的所有文件信息，都存在inode之中。至于为什么没有文件名，下文会有详细解释。</p>
<p>三、inode的大小<br>inode也会消耗硬盘空间，所以硬盘格式化的时候，操作系统自动将硬盘分成两个区域。一个是数据区，存放文件数据；另一个是inode区（inode table），存放inode所包含的信息。<br>每个inode节点的大小，一般是128字节或256字节。inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。假定在一块1GB的硬盘中，每个inode节点的大小为128字节，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。</p>
<p>查看每个硬盘分区的inode总数和已经使用的数量，可以使用df命令。<br>df -i<br>查看每个inode节点的大小，可以用如下命令：<br>sudo dumpe2fs -h /dev/hda | grep “Inode size”<br>由于每个文件都必须有一个inode，因此有可能发生inode已经用光，但是硬盘还未存满的情况。这时，就无法在硬盘上创建新文件。</p>
<p>四、inode号码<br>每个inode都有一个号码，操作系统用inode号码来识别不同的文件。</p>
<p>这里值得重复一遍，Unix/Linux系统内部不使用文件名，而使用inode号码来识别文件。对于系统来说，文件名只是inode号码便于识别的别称或者绰号。表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：首先，系统找到这个文件名对应的inode号码；其次，通过inode号码，获取inode信息；最后，根据inode信息，找到文件数据所在的block，读出数据。</p>
<p>使用ls -i命令，可以看到文件名对应的inode号码：</p>
<p>ls -i example.txt</p>
<p>五、目录文件<br>Unix/Linux系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。</p>
<p>目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的inode号码。</p>
<p>ls命令只列出目录文件中的所有文件名：<br>ls /etc<br>ls -i命令列出整个目录文件，即文件名和inode号码：<br>ls -i /etc<br>如果要查看文件的详细信息，就必须根据inode号码，访问inode节点，读取信息。ls -l命令列出文件的详细信息。<br>ls -l /etc</p>
<p>六、硬链接<br>一般情况下，文件名和inode号码是”一一对应”关系，每个inode号码对应一个文件名。但是，Unix/Linux系统允许，多个文件名指向同一个inode号码。这意味着，可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名；但是，删除一个文件名，不影响另一个文件名的访问。这种情况就被称为”硬链接”（hard link）。</p>
<p>ln命令可以创建硬链接：</p>
<p>ln 源文件 目标文件<br>运行上面这条命令以后，源文件与目标文件的inode号码相同，都指向同一个inode。inode信息中有一项叫做”链接数”，记录指向该inode的文件名总数，这时就会增加1。反过来，删除一个文件名，就会使得inode节点中的”链接数”减1。当这个值减到0，表明没有文件名指向这个inode，系统就会回收这个inode号码，以及其所对应block区域。</p>
<p>这里顺便说一下目录文件的”链接数”。创建目录时，默认会生成两个目录项：”.”和”..”。前者的inode号码就是当前目录的inode号码，等同于当前目录的”硬链接”；后者的inode号码就是当前目录的父目录的inode号码，等同于父目录的”硬链接”。所以，任何一个目录的”硬链接”总数，总是等于2加上它的子目录总数（含隐藏目录）,这里的2是父目录对其的“硬链接”和当前目录下的”.硬链接“。</p>
<p>七、软链接<br>除了硬链接以外，还有一种特殊情况。文件A和文件B的inode号码虽然不一样，但是文件A的内容是文件B的路径。读取文件A时，系统会自动将访问者导向文件B。因此，无论打开哪一个文件，最终读取的都是文件B。这时，文件A就称为文件B的”软链接”（soft link）或者”符号链接（symbolic link）。</p>
<p>这意味着，文件A依赖于文件B而存在，如果删除了文件B，打开文件A就会报错：”No such file or directory”。这是软链接与硬链接最大的不同：文件A指向文件B的文件名，而不是文件B的inode号码，文件B的inode”链接数”不会因此发生变化。</p>
<p>ln -s命令可以创建软链接。<br>ln -s 源文文件或目录 目标文件或目录</p>
<p>八、inode的特殊作用<br>由于inode号码与文件名分离，这种机制导致了一些Unix/Linux系统特有的现象。<br>　　1. 有时，文件名包含特殊字符，无法正常删除。这时，直接删除inode节点，就能起到删除文件的作用。<br>　　2. 移动文件或重命名文件，只是改变文件名，不影响inode号码。<br>　　3. 打开一个文件以后，系统就以inode号码来识别这个文件，不再考虑文件名。因此，通常来说，系统无法从inode号码得知文件名。<br>      第3点使得软件更新变得简单，可以在不关闭软件的情况下进行更新，不需要重启。因为系统通过inode号码，识别运行中的文件，不通过文件名。更新的时候，新版文件以同样的文件名，生成一个新的inode，不会影响到运行中的文件。等到下一次运行这个软件的时候，文件名就自动指向新版文件，旧版文件的inode则被回收。</p>
<p>九 实际问题</p>
<p>在一台配置较低的Linux服务器（内存、硬盘比较小）的/data分区内创建文件时，系统提示磁盘空间不足，用df -h命令查看了一下磁盘使用情况，发现/data分区只使用了66%，还有12G的剩余空间，按理说不会出现这种问题。 后来用df -i查看了一下/data分区的索引节点(inode)，发现已经用满(IUsed=100%)，导致系统无法创建新目录和文件。 </p>
<p>查找原因：<br>　　/data/cache目录中存在数量非常多的小字节缓存文件，占用的Block不多，但是占用了大量的inode。 </p>
<p>解决方案：<br>　　1、删除/data/cache目录中的部分文件，释放出/data分区的一部分inode。<br>　　2、用软连接将空闲分区/opt中的newcache目录连接到/data/cache，使用/opt分区的inode来缓解/data分区inode不足的问题：<br>　　ln -s /opt/newcache /data/cache 
 </p>
]]></content>
      <categories>
        <category>系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MYSQL索引失效的各种情形总结</title>
    <url>/2016/01/03/MYSQL%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E7%9A%84%E5%90%84%E7%A7%8D%E6%83%85%E5%BD%A2%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<ul>
<li>没有查询条件，或者查询条件没有建立索引 </li>
<li>在查询条件上没有使用引导列 </li>
<li>查询的数量是大表的大部分，应该是30％以上。 </li>
<li>索引本身失效</li>
<li>查询条件使用函数在索引列上，或者对索引列进行运算，运算包括(+，-，*，/，! 等) 错误的例子：select * from test where id-1=9; 正确的例子：select * from test where id=10; </li>
<li>对小表查询 </li>
<li>提示不使用索引</li>
<li>统计数据不真实 </li>
<li>CBO计算走索引花费过大的情况。其实也包含了上面的情况，这里指的是表占有的block要比索引小。 </li>
<li>隐式转换导致索引失效.这一点应当引起重视.也是开发中经常会犯的错误. 由于表的字段tu_mdn定义为varchar2(20),但在查询时把该字段作为number类型以where条件传给Oracle,这样会导致索引失效. 错误的例子：select * from test where tu_mdn=13333333333; 正确的例子：select * from test where tu_mdn=’13333333333’; </li>
<li>&lt;&gt;  </li>
<li>like “%_” 百分号在前. </li>
<li>表没分析. </li>
<li>单独引用复合索引里非第一位置的索引列. </li>
<li>字符型字段为数字时在where条件里不添加引号. </li>
<li>对索引列进行运算.需要建立函数索引. </li>
<li>not in ,not exist. </li>
<li>当变量采用的是times变量，而表的字段采用的是date变量时.或相反情况。 </li>
<li>B-tree索引 is null不会走,is not null会走,位图索引 is null,is not null 都会走 </li>
<li>联合索引 is not null 只要在建立的索引列（不分先后）都会走, in null时 必须要和建立索引第一列一起使用,当建立索引第一位置条件是is null 时,其他建立索引的列可以是is null（但必须在所有列 都满足is null的时候）,或者=一个值； 当建立索引的第一位置是=一个值时,其他索引列可以是任何情况（包括is null =一个值）,以上两种情况索引都会走。其他情况不会走。</li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>MySQL索引</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac连不上WIFI</title>
    <url>/2020/05/05/Mac%E8%BF%9E%E4%B8%8D%E4%B8%8AWIFI/</url>
    <content><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><ul>
<li>Mac连接不上wifi，但是手机可以连上</li>
<li>Mac连接手机热点不稳定</li>
</ul>
<h2 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h2><ul>
<li>拔掉USB</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.zhihu.com/question/28422159">为什么 Wi-Fi 和 USB 3.0 会互相干扰？</a></li>
<li><a href="https://support.apple.com/zh-cn/HT201542">解决由无线干扰引起的 Wi-Fi 和蓝牙问题</a></li>
</ul>
]]></content>
      <categories>
        <category>笔记本电脑</category>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>笔记本电脑</tag>
        <tag>Mac</tag>
        <tag>Q&amp;A</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL server has gone away报错原因分析</title>
    <url>/2016/01/03/MySQL-server-has-gone-away%E6%8A%A5%E9%94%99%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="MySQL-服务宕了"><a href="#MySQL-服务宕了" class="headerlink" title="MySQL 服务宕了"></a>MySQL 服务宕了</h3><p>判断是否属于这个原因的方法很简单，执行以下命令，查看mysql的运行时长</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ mysql -uroot -p -e <span class="string">&quot;show global status like &#x27;uptime&#x27;;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Uptime        | 68928 |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.04 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者查看MySQL的报错日志，看看有没有重启的信息</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ tail /var/<span class="built_in">log</span>/mysql/error.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">130101 22:22:30 InnoDB: Initializing buffer pool, size = 256.0M</span><br><span class="line">130101 22:22:30 InnoDB: Completed initialization of buffer pool</span><br><span class="line">130101 22:22:30 InnoDB: highest supported file format is Barracuda.</span><br><span class="line">130101 22:22:30 InnoDB: 1.1.8 started; log sequence number 63444325509</span><br><span class="line">130101 22:22:30 [Note] Server hostname (bind-address): &#x27;127.0.0.1&#x27;; port: 3306</span><br><span class="line">130101 22:22:30 [Note]   - &#x27;127.0.0.1&#x27; resolves to &#x27;127.0.0.1&#x27;;</span><br><span class="line">130101 22:22:30 [Note] Server socket created on IP: &#x27;127.0.0.1&#x27;.</span><br><span class="line">130101 22:22:30 [Note] Event Scheduler: Loaded 0 events</span><br><span class="line">130101 22:22:30 [Note] /usr/sbin/mysqld: ready for connections.</span><br><span class="line">Version: &#x27;5.5.28-cll&#x27;  socket: &#x27;/var/lib/mysql/mysql.sock&#x27;  port: 3306  MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>如果uptime数值很大，表明mysql服务运行了很久了。说明最近服务没有重启过。</p>
<p>如果日志没有相关信息，也表名mysql服务最近没有重启过，可以继续检查下面几项内容。</p>
<h3 id="连接超时"><a href="#连接超时" class="headerlink" title="连接超时"></a>连接超时</h3><p>如果程序使用的是长连接，则这种情况的可能性会比较大。</p>
<p>即，某个长连接很久没有新的请求发起，达到了server端的timeout，被server强行关闭。</p>
<p>此后再通过这个connection发起查询的时候，就会报错server has gone away</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ mysql -uroot -p -e <span class="string">&quot;show global variables like &#x27;%timeout&#x27;;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----------------------------+----------+</span><br><span class="line">| Variable_name              | Value    |</span><br><span class="line">+----------------------------+----------+</span><br><span class="line">| connect_timeout            | 30       |</span><br><span class="line">| delayed_insert_timeout     | 300      |</span><br><span class="line">| innodb_lock_wait_timeout   | 50       |</span><br><span class="line">| innodb_rollback_on_timeout | OFF      |</span><br><span class="line">| interactive_timeout        | 28800    |</span><br><span class="line">| lock_wait_timeout          | 31536000 |</span><br><span class="line">| net_read_timeout           | 30       |</span><br><span class="line">| net_write_timeout          | 60       |</span><br><span class="line">| slave_net_timeout          | 3600     |</span><br><span class="line">| wait_timeout               | 28800    |</span><br><span class="line">+----------------------------+----------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> SESSION wait_timeout<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Wait <span class="number">10</span> seconds</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> NOW();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    132361</span><br><span class="line">Current database: *** NONE ***</span><br><span class="line"></span><br><span class="line">+---------------------+</span><br><span class="line">| NOW()               |</span><br><span class="line">+---------------------+</span><br><span class="line">| 2013-01-02 11:31:15 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="进程在server端被主动kill"><a href="#进程在server端被主动kill" class="headerlink" title="进程在server端被主动kill"></a>进程在server端被主动kill</h3><p>这种情况和情况2相似，只是发起者是DBA或者其他job。发现有长时间的慢查询执行kill xxx导致。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ mysql -uroot -p -e <span class="string">&quot;show global status like &#x27;com_kill&#x27;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Com_kill      | 0     |</span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="Your-SQL-statement-was-too-large"><a href="#Your-SQL-statement-was-too-large" class="headerlink" title="Your SQL statement was too large."></a>Your SQL statement was too large.</h3><p>当查询的结果集超过 max_allowed_packet 也会出现这样的报错。定位方法是打出相关报错的语句。</p>
<p>用select * into outfile 的方式导出到文件，查看文件大小是否超过 max_allowed_packet ，如果超过则需要调整参数，或者优化语句。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;max_allowed_packet&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------+---------+</span><br><span class="line">| Variable_name      | Value   |</span><br><span class="line">+--------------------+---------+</span><br><span class="line">| max_allowed_packet | 1048576 |</span><br><span class="line">+--------------------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改参数：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> max_allowed_packet<span class="operator">=</span><span class="number">1024</span><span class="operator">*</span><span class="number">1024</span><span class="operator">*</span><span class="number">16</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;max_allowed_packet&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------------------+----------+</span><br><span class="line">| Variable_name      | Value    |</span><br><span class="line">+--------------------+----------+</span><br><span class="line">| max_allowed_packet | 16777216 |</span><br><span class="line">+--------------------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>故障问题</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL行级锁,表级锁,页级锁详解</title>
    <url>/2016/01/03/MySQL%E8%A1%8C%E7%BA%A7%E9%94%81-%E8%A1%A8%E7%BA%A7%E9%94%81-%E9%A1%B5%E7%BA%A7%E9%94%81%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="行级锁-表级锁-页级锁"><a href="#行级锁-表级锁-页级锁" class="headerlink" title="行级锁,表级锁,页级锁"></a>行级锁,表级锁,页级锁</h2><p>页级:引擎 BDB。<br>表级:引擎 MyISAM ， 理解为锁住整个表，可以同时读，写不行<br>行级:引擎 INNODB ， 单独的一行记录加锁</p>
<p>表级，直接锁定整张表，在你锁定期间，其它进程无法对该表进行写操作。如果你是写锁，则其它进程则读也不允许<br>行级,，仅对指定的记录进行加锁，这样其它进程还是可以对同一个表中的其它记录进行操作。<br>页级，表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。 </p>
<p>MySQL 5.1支持对MyISAM和MEMORY表进行表级锁定，对BDB表进行页级锁定，对InnoDB表进行行级锁定。<br>对WRITE，MySQL使用的表锁定方法原理如下：<br>如果在表上没有锁，在它上面放一个写锁。<br>否则，把锁定请求放在写锁定队列中。 </p>
<p>对READ，MySQL使用的锁定方法原理如下：<br>如果在表上没有写锁定，把一个读锁定放在它上面<br>否则，把锁请求放在读锁定队列中。 </p>
<p>InnoDB使用行锁定，BDB使用页锁定。对于这两种存储引擎，都可能存在死锁。这是因为，在SQL语句处理期间，InnoDB自动获得行锁定和BDB获得页锁定，而不是在事务启动时获得。  </p>
<p>行级锁定的优点：</p>
<ul>
<li><pre><code>   当在许多线程中访问不同的行时只存在少量锁定冲突。
</code></pre>
</li>
<li><pre><code>   回滚时只有少量的更改。
</code></pre>
</li>
<li><pre><code>   可以长时间锁定单一的行。
</code></pre>
</li>
</ul>
<p>行级锁定的缺点：</p>
<ul>
<li><pre><code>    比页级或表级锁定占用更多的内存。
</code></pre>
</li>
<li><pre><code>    当在表的大部分中使用时，比页级或表级锁定速度慢，因为你必须获取更多的锁。
</code></pre>
</li>
<li><pre><code>    如果你在大部分数据上经常进行GROUP BY操作或者必须经常扫描整个表，比其它锁定明显慢很多。
</code></pre>
</li>
<li><pre><code>    用高级别锁定，通过支持不同的类型锁定，你也可以很容易地调节应用程序，因为其锁成本小于行级锁定。
</code></pre>
</li>
</ul>
<p>在以下情况下，表锁定优先于页级或行级锁定：</p>
<ul>
<li><pre><code>    表的大部分语句用于读取。
</code></pre>
</li>
<li><pre><code>    对严格的关键字进行读取和更新，你可以更新或删除可以用单一的读取的关键字来提取的一行：
</code></pre>
</li>
<li><pre><code>    UPDATE tbl_name SET column=value WHERE unique_key_col=key_value;
</code></pre>
</li>
<li><pre><code>    DELETE FROM tbl_name WHERE unique_key_col=key_value;
</code></pre>
</li>
<li><pre><code>    SELECT 结合并行的INSERT语句，并且只有很少的UPDATE或DELETE语句。
</code></pre>
</li>
<li><pre><code>    在整个表上有许多扫描或GROUP BY操作，没有任何写操作。
</code></pre>
</li>
</ul>
<h2 id="mysql-锁表类型和解锁语句"><a href="#mysql-锁表类型和解锁语句" class="headerlink" title="mysql 锁表类型和解锁语句"></a>mysql 锁表类型和解锁语句</h2><p>如果想要在一个表上做大量的 INSERT 和 SELECT 操作，但是并行的插入却不可能时，可以将记录插入到临时表中，然后定期将临时表中的数据更新到实际的表里。可以用以下命令实现：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> LOCK TABLES real_table WRITE, insert_table WRITE;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> real_table <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> insert_table;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> insert_table;</span><br><span class="line">mysql<span class="operator">&gt;</span> UNLOCK TABLES;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>行级锁的优点有：<br>    在很多线程请求不同记录时减少冲突锁。<br>    事务回滚时减少改变数据。<br>    使长时间对单独的一行记录加锁成为可能。</p>
<p>行级锁的缺点有：<br>    比页级锁和表级锁消耗更多的内存。<br>    锁是计算机协调多个进程或线程并发访问某一资源的机制，不同的数据库的锁机制大同小异。由于数据库资源是一种供许多用户共享的资源，所以如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。了解锁机制不仅可以使我们更有效的开发利用数据库资源，也使我们能够更好地维护数据库，从而提高数据库的性能。</p>
<p>MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。</p>
<p>例如，MyISAM和MEMORY存储引擎采用的是表级锁（table-level-locking）；BDB存储引擎采用的是页面锁（page-level-locking），同时也支持表级锁；InnoDB存储引擎既支持行级锁，也支持表级锁，默认情况下是采用行级锁。</p>
<p>上述三种锁的特性可大致归纳如下：<br>1） 表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。<br>2） 行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。<br>3） 页面锁：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</p>
<pre><code> 三种锁各有各的特点，若仅从锁的角度来说，表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如WEB应用；行级锁更适合于有大量按索引条件并发更新少量不同数据，同时又有并发查询的应用，如一些在线事务处理（OLTP）系统。

 MySQL表级锁有两种模式：表共享读锁（Table Read Lock）和表独占写锁（Table Write Lock）。什么意思呢，就是说对MyISAM表进行读操作时，它不会阻塞其他用户对同一表的读请求，但会阻塞 对同一表的写操作；而对MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作。

 MyISAM表的读和写是串行的，即在进行读操作时不能进行写操作，反之也是一样。但在一定条件下MyISAM表也支持查询和插入的操作的并发进行，其机制是通过控制一个系统变量（concurrent_insert）来进行的，当其值设置为0时，不允许并发插入；当其值设置为1 时，如果MyISAM表中没有空洞（即表中没有被删除的行），MyISAM允许在一个进程读表的同时，另一个进程从表尾插入记录；当其值设置为2时，无论MyISAM表中有没有空洞，都允许在表尾并发插入记录。

 MyISAM锁调度是如何实现的呢，这也是一个很关键的问题。例如，当一个进程请求某个MyISAM表的读锁，同时另一个进程也请求同一表的写锁，此时MySQL将会如优先处理进程呢？通过研究表明，写进程将先获得锁（即使读请求先到锁等待队列）。但这也造成一个很大的缺陷，即大量的写操作会造成查询操作很难获得读锁，从而可能造成永远阻塞。所幸我们可以通过一些设置来调节MyISAM的调度行为。我们可通过指定参数low-priority-updates，使MyISAM默认引擎给予读请求以优先的权利，设置其值为1（set low_priority_updates=1),使优先级降低。

 InnoDB锁与MyISAM锁的最大不同在于：一是支持事务（TRANCSACTION），二是采用了行级锁。我们知道事务是由一组SQL语句组成的逻辑处理单元，其有四个属性（简称ACID属性），分别为：
</code></pre>
<p>原子性（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全部执行，要么全都不执行；<br>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态；<br>隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行；<br>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</p>
<p>InnoDB有两种模式的行锁：</p>
<p>1）共享锁：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。<br>    ( Select * from table_name where ……lock in share mode)</p>
<p>2）排他锁：允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和  排他写锁。(select * from table_name where…..for update)<br>    为了允许行锁和表锁共存，实现多粒度锁机制；同时还有两种内部使用的意向锁（都是表锁），分别为意向共享锁和意向排他锁。<br>    InnoDB行锁是通过给索引项加锁来实现的，即只有通过索引条件检索数据，InnoDB才使用行级锁，否则将使用表锁！</p>
<p>另外：插入，更新性能优化的几个重要参数</p>
<p>bulk_insert_buffer_size<br>批量插入缓存大小, 这个参数是针对MyISAM存储引擎来说的.适用于在一次性插入100-1000+条记录时, 提高效率.默认值是8M.可以针对数据量的大小,翻倍增加.</p>
<p>concurrent_insert<br>并发插入, 当表没有空洞(删除过记录), 在某进程获取读锁的情况下,其他进程可以在表尾部进行插入.</p>
<p>值可以设0不允许并发插入, 1当表没有空洞时, 执行并发插入, 2不管是否有空洞都执行并发插入.<br>默认是1 针对表的删除频率来设置.</p>
<p>delay_key_write<br>针对MyISAM存储引擎,延迟更新索引.意思是说,update记录时,先将数据up到磁盘,但不up索引,将索引存在内存里,当表关闭时,将内存索引,写到磁盘. 值为 0不开启, 1开启. 默认开启.</p>
<p>delayed_insert_limit, delayed_insert_timeout, delayed_queue_size<br>延迟插入, 将数据先交给内存队列, 然后慢慢地插入.但是这些配置,不是所有的存储引擎都支持, 目前来看, 常用的InnoDB不支持, MyISAM支持. 根据实际情况调大, 一般默认够用了</p>
<h2 id="MySQL-InnoDB-锁表与锁行"><a href="#MySQL-InnoDB-锁表与锁行" class="headerlink" title="MySQL InnoDB 锁表与锁行"></a>MySQL InnoDB 锁表与锁行</h2><p>由于InnoDB预设是Row-Level Lock，所以只有「明确」的指定主键，MySQL才会执行Row lock (只锁住被选取的资料例) ，否则MySQL将会执行Table Lock (将整个资料表单给锁住)。</p>
<p>举个例子: 假设有个表单products ，里面有id跟name二个栏位，id是主键。</p>
<p>例1: (明确指定主键，并且有此笔资料，row lock)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;3&#x27;</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;3&#x27;</span> <span class="keyword">and</span> type<span class="operator">=</span><span class="number">1</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例2: (明确指定主键，若查无此笔资料，无lock)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;-1&#x27;</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例3: (无主键，table lock)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> name<span class="operator">=</span><span class="string">&#x27;Mouse&#x27;</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例4: (主键不明确，table lock)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id<span class="operator">&lt;&gt;</span><span class="string">&#x27;3&#x27;</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例5: (主键不明确，table lock)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="keyword">LIKE</span> <span class="string">&#x27;3&#x27;</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注1: FOR UPDATE仅适用于InnoDB，且必须在交易区块(BEGIN/COMMIT)中才能生效。<br>注2: 要测试锁定的状况，可以利用MySQL的Command Mode ，开二个视窗来做测试。</p>
<p>在MySql 5.0中测试确实是这样的<br>另外：MyAsim 只支持表级锁，InnerDB支持行级锁<br>添加了(行级锁/表级锁)锁的数据不能被其它事务再锁定，也不被其它事务修改（修改、删除）<br>是表级锁时，不管是否查询到记录，都会锁定表<br>此外，如果A与B都对表id进行查询但查询不到记录，则A与B在查询上不会进行row锁，但A与B都会获取排它锁，此时A再插入一条记录的话则会因为B已经有锁而处于等待中，此时B再插入一条同样的数据则会抛出Deadlock found when trying to get lock; try restarting transaction然后释放锁，此时A就获得了锁而插入成功</p>
]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP如何释放内存之UNSET销毁变量并释放内存详解</title>
    <url>/2016/01/03/PHP%E5%A6%82%E4%BD%95%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98%E4%B9%8BUNSET%E9%94%80%E6%AF%81%E5%8F%98%E9%87%8F%E5%B9%B6%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p>PHP的unset()函数用来清除、销毁变量，不用的变量，我们可以用unset()将它销毁。但是某些时候，用unset()却无法达到销毁变量占用的内存！我们先看一个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$s</span> = str_repeat(<span class="string">&#x27;1&#x27;</span>,<span class="number">255</span>);       <span class="comment">//产生由255个1组成的字符串</span></span><br><span class="line"><span class="variable">$m</span> = memory_get_usage();        <span class="comment">//获取当前占用内存</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>);</span><br><span class="line"><span class="variable">$mm</span> = memory_get_usage();       <span class="comment">//unset()后再查看当前占用内存</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$m</span>-<span class="variable">$mm</span>;</span><br></pre></td></tr></table></figure>

<p>最后输出unset()之前占用内存减去unset()之后占用内存，如果是正数，那么说明unset($s)已经将$s从内存中销毁(或者 说，unset()之后内存占用减少了)，可是我在PHP5和windows平台下，得到的结果是：-48。这是否可以说明，unset($s)并没有起 到销毁变量$s所占用内存的作用呢？我们再作下面的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$s</span> = str_repeat(<span class="string">&#x27;1&#x27;</span>,<span class="number">256</span>);       <span class="comment">//产生由256个1组成的字符串</span></span><br><span class="line"><span class="variable">$m</span> = memory_get_usage();        <span class="comment">//获取当前占用内存</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>);</span><br><span class="line"><span class="variable">$mm</span> = memory_get_usage();       <span class="comment">//unset()后再查看当前占用内存</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$m</span>-<span class="variable">$mm</span>;</span><br></pre></td></tr></table></figure>

<p>这个例子，和上面的例子几乎相同，唯一的不同是，$s由256个1组成，即比第一个例子多了一个1，得到结果是：224。这是否可以说明，unset($s)已经将$s所占用的内存销毁了？<br>通过上面两个例子，我们可以得出以下结论：<br>结论一、unset()函数只能在变量值占用内存空间超过256字节时才会释放内存空间。<br>那么是不是只要变量值超过256，使用unset就可以释放内存空间呢？我们再通过一个例子来测试一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$s</span> = str_repeat(<span class="string">&#x27;1&#x27;</span>,<span class="number">256</span>);               <span class="comment">//这和第二个例子完全相同</span></span><br><span class="line"><span class="variable">$p</span> = &amp;<span class="variable">$s</span>;</span><br><span class="line"><span class="variable">$m</span> = memory_get_usage();</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>);                                              <span class="comment">//销毁$s</span></span><br><span class="line"><span class="variable">$mm</span> = memory_get_usage();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$p</span> . <span class="string">&#x27;&lt;br /&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$m</span>-<span class="variable">$mm</span>;</span><br></pre></td></tr></table></figure>

<p>刷新页面，我们看到第一行有256个1，第二行是-48，按理说我们已经销毁了$s，而$p只是引用$s的变量，应该是没有内容了，另外，unset($s)后内存占用却比unset()前增加了！现在我们再做以下的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$s</span> = str_repeat(<span class="string">&#x27;1&#x27;</span>, <span class="number">256</span>);              <span class="comment">//这和第二个例子完全相同</span></span><br><span class="line"><span class="variable">$p</span> = &amp;<span class="variable">$s</span>;</span><br><span class="line"><span class="variable">$m</span> = memory_get_usage();</span><br><span class="line"><span class="variable">$s</span> = <span class="literal">null</span>;                                              <span class="comment">//设置$s为null</span></span><br><span class="line"><span class="variable">$mm</span> = memory_get_usage();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$p</span> . <span class="string">&#x27;&lt;br /&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$m</span>-<span class="variable">$mm</span>;</span><br></pre></td></tr></table></figure>

<p>现在刷新页面，我们看到，输出$p已经是没有内容了，unset()前后内存占用量之差是224，即已经清除了变量占用的内存。本例中的$s=null也可以换成unset()，如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$s</span> = str_repeat(<span class="string">&#x27;1&#x27;</span>, <span class="number">256</span>);              <span class="comment">//这和第二个例子完全相同</span></span><br><span class="line"><span class="variable">$p</span> = &amp;<span class="variable">$s</span>;</span><br><span class="line"><span class="variable">$m</span> = memory_get_usage();</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>);                                              <span class="comment">//销毁$s</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$p</span>);</span><br><span class="line"><span class="variable">$mm</span> = memory_get_usage();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$p</span> . <span class="string">&#x27;&lt;br /&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$m</span>-<span class="variable">$mm</span>;</span><br></pre></td></tr></table></figure>


<p>我们将$s和$p都使用unset()销毁，这时再看内存占用量之差也是224，说明这样也可以释放内存。那么，我们可以得到另外一条结论：<br>结论二、只有当指向该变量的所有变量（如引用变量）都被销毁后，才会释放内存。<br>相信经过本文的例子后，大家应该对unset()有所了解了，最起码，本人用unset()也是为了在变量不起作用时，释放内存。</p>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP内存释放</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP扩展安装</title>
    <url>/2016/01/03/PHP%E6%89%A9%E5%B1%95%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h3 id="PECL扩展库"><a href="#PECL扩展库" class="headerlink" title="PECL扩展库"></a>PECL扩展库</h3><p>PECL 的全称是 The PHP Extension Community Library ，是一个开放的并通过 PEAR(PHP Extension and Application Repository，PHP 扩展和应用仓库)打包格式来打包安装的 PHP扩展库仓库。通过 PEAR 的 Package Manager 的安装管理方式，可以对 PECL 模块进行下载和安装。</p>
<p><a href="http://pecl.php.net/">http://pecl.php.net/</a></p>
<p>可跑命令：</p>
<p>pecl install {package}</p>
<h3 id="扩展通用编译流程"><a href="#扩展通用编译流程" class="headerlink" title="扩展通用编译流程"></a>扩展通用编译流程</h3><p>1: 到软件的官方(如 memcached)或 pecl.php.net 去寻找扩展源码并下载解压</p>
<p>2: 进入到 path/memcache 目录</p>
<p>3: 根据当前的 php 版本动态的创建扩展的 configure 文件<br>#/xxx/path/php/bin/phpize <br>–with-php-config=/xxx/path/php/bin/php-config</p>
<p>4: ./configure<br>-with-php-config=/xxx/path/php/bin/php-config</p>
<p>5: make &amp;&amp; make install</p>
<p>6:把生成的.so 扩展, 在 php.ini 里引入.</p>
<p>7：重启web服务器</p>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP扩展</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ</title>
    <url>/2020/10/18/RabbitMQ/</url>
    <content><![CDATA[<h1 id="解决了什么问题？"><a href="#解决了什么问题？" class="headerlink" title="解决了什么问题？"></a>解决了什么问题？</h1><h2 id="缺乏并行化架构，单机上做并行化优化局限性大，难以扩容"><a href="#缺乏并行化架构，单机上做并行化优化局限性大，难以扩容" class="headerlink" title="缺乏并行化架构，单机上做并行化优化局限性大，难以扩容"></a>缺乏并行化架构，单机上做并行化优化局限性大，难以扩容</h2><ul>
<li>提供构建并行化架构</li>
</ul>
<h2 id="流量突涨，系统不稳定"><a href="#流量突涨，系统不稳定" class="headerlink" title="流量突涨，系统不稳定"></a>流量突涨，系统不稳定</h2><ul>
<li>异步，前端服务资源先响应，后端服务资源可按需排队、可并行处理，削峰</li>
</ul>
<h2 id="系统耦合度高"><a href="#系统耦合度高" class="headerlink" title="系统耦合度高"></a>系统耦合度高</h2><ul>
<li>通过中间件拆分隔离服务相互弱依赖的上下文</li>
</ul>
<h2 id="消费的收发可靠性没有保障"><a href="#消费的收发可靠性没有保障" class="headerlink" title="消费的收发可靠性没有保障"></a>消费的收发可靠性没有保障</h2><p><a href="https://www.rabbitmq.com/confirms.html">Consumer Acknowledgements and Publisher Confirms</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><a href="/2020/10/18/AMQP%E5%8D%8F%E8%AE%AE/" title="AMQP协议">AMQP协议</a>


<h1 id="存在什么问题？"><a href="#存在什么问题？" class="headerlink" title="存在什么问题？"></a>存在什么问题？</h1><h2 id="消息有丢失的可能"><a href="#消息有丢失的可能" class="headerlink" title="消息有丢失的可能"></a>消息有丢失的可能</h2><p>A RabbitMQ node can lose persistent messages if it fails before said messages are written to disk. For instance, consider this scenario:</p>
<ol>
<li> a client publishes a persistent message to a durable queue</li>
<li> a client consumes the message from the queue (noting that the message is persistent and the queue durable), but confirms are not active,</li>
<li> the broker node fails and is restarted, and</li>
<li> the client reconnects and starts consuming messages</li>
</ol>
<p>At this point, the client could reasonably assume that the message will be delivered again. This is not the case: the restart has caused the broker to lose the message. In order to guarantee persistence, a client should use confirms. If the publisher’s channel had been in confirm mode, the publisher would <em>not</em> have received an ack for the lost message (since the message hadn’t been written to disk yet).</p>
<h1 id="实践工具"><a href="#实践工具" class="headerlink" title="实践工具"></a>实践工具</h1><ul>
<li><a href="http://tryrabbitmq.com/">RabbitMQ Simulator</a></li>
</ul>
]]></content>
      <categories>
        <category>开发</category>
        <category>中间件</category>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>消息队列</tag>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Rook Ceph部署</title>
    <url>/2020/06/11/Rook-Ceph%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><ul>
<li>rook v1.3</li>
</ul>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><ul>
<li> <a href="https://rook.io/docs/rook/v1.3/k8s-pre-reqs.html">https://rook.io/docs/rook/v1.3/k8s-pre-reqs.html</a></li>
<li> 添加空磁盘（不挂载）</li>
</ul>
<h2 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h2><ul>
<li><a href="https://rook.io/docs/rook/v1.3/ceph-quickstart.html">https://rook.io/docs/rook/v1.3/ceph-quickstart.html</a></li>
</ul>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="failed-for-volume-pvc-…-An-operation-with-the-givin-Volume-ID-already-exists"><a href="#failed-for-volume-pvc-…-An-operation-with-the-givin-Volume-ID-already-exists" class="headerlink" title="failed for volume pvc-… An operation with the givin Volume ID already exists"></a>failed for volume pvc-… An operation with the givin Volume ID already exists</h2><p>ceph 集群部署失败，需要检查部署环境是否完成前置条件</p>
]]></content>
      <categories>
        <category>存储</category>
      </categories>
      <tags>
        <tag>存储</tag>
        <tag>云原生</tag>
      </tags>
  </entry>
  <entry>
    <title>TCP连接的半打开和半关闭</title>
    <url>/2020/11/29/TCP%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%8D%8A%E6%89%93%E5%BC%80%E5%92%8C%E5%8D%8A%E5%85%B3%E9%97%AD/</url>
    <content><![CDATA[<p>一、半开连接</p>
<p>        从协议定义的角度来说，TCP的半开连接是指TCP连接的一端异常崩溃，或者在未通知对端的情况下关闭连接，这种情况下不可以正常收发数据，否则会产生RST(后面内容我们在介绍RST)。比如一个常见的情况是TCP连接的一端异常断电，就会导致TCP的半开连接。如果没有数据传输，对端就不会知道本端的异常而一直处于ESTABLISHED状态(TCP有存活检测机制，后面内容我们会进行介绍)。</p>
<p>        另外从linux实现的角度来说，因为linux内部有个半连接队列，TCP半开连接是指发送了TCP连接请求，等待对方应答的状态，此时连接并没有完全建立起来,双方还无法进行通信交互的状态，此时就称为半连接。由于一个完整的TCP连接需要经过三次握手才能完成,这里把三次握手之前的连接都称之为半连接。</p>
<p>二、半关连接</p>
<p>TCP的半关连接是指TCP连接只有一方发送了FIN，另一方没有发出FIN包，仍然可以在一个方向上正常发送数据。这种场景并不常见，一般来说Berkeley sockets API调用shutdown()接口时候就会进入半关闭状态(调用常规的close()一般是期待完整的双向关闭这个TCP连接)，shutdown()接口相当指示程序，本端已经没有数据待发送，所以我发送一个FIN到对端，但是我仍然想要从对端接收数据，直到对端发送一个FIN指示关闭连接为止。如下图所示，在红色背景文本框标注的数据传输场景下就是TCP的半关连接</p>
<p><img src="https://images2015.cnblogs.com/blog/740952/201611/740952-20161107133341092-1088495812.png"></p>
<p>三、wireshrk抓包示例</p>
<p>首先注意半开连接是不能正常传输数据的，而半关连接是可以在其中的一个方向上传输数据的。下面简单附一下wireshark的抓包图示，限于篇幅仅作简要介绍，详细请参考对应的wireshark抓包文件</p>
<p>1.TCP半开</p>
<p>通过单台笔记本的双无线网卡测试tcp连接的半开，步骤如下</p>
<ul>
<li><p>  server绑定网卡A的地址</p>
</li>
<li><p>  client绑定网卡B的地址并连接server 对应截图中的No 1--No 3包</p>
</li>
<li><p>  client发送”hello”消息 对应截图中的No 4包</p>
</li>
<li><p>  server正常接收到后”hello”消息后 拔掉网卡A</p>
</li>
<li><p>  kill掉server进程 使server的FIN消息不能发送到client</p>
</li>
<li><p>  插上网卡A  注意在路由器中绑定IP地址和MAC地址，使得网卡A的地址和之前是一致的,此时client和server即处于半开连接状态</p>
</li>
<li><p>  client向server发送”world”消息   对应截图中的No 6包</p>
</li>
<li><p>  server回复rst消息</p>
</li>
</ul>
<p><a href="http://images2015.cnblogs.com/blog/740952/201611/740952-20161107133343795-1911242012.png"><img src="https://images2015.cnblogs.com/blog/740952/201611/740952-20161107133343795-1911242012.png"></a></p>
<p>2.TCP半关</p>
<p>正常建立连接后，client首先发送”hello”消息给server，然后server发送FIN给client，关闭了server到client方向的数据传输，但是client仍然可以向server传输数据，此时client和server之间的连接即处于半关连接的状态，接下来client向server发送”world”消息，然后发送FIN给server关闭client到server方向的数据传输。</p>
<p><a href="http://images2015.cnblogs.com/blog/740952/201611/740952-20161107133348077-790799891.png"><img src="https://images2015.cnblogs.com/blog/740952/201611/740952-20161107133348077-790799891.png"></a></p>
<p>补充说明：</p>
<p>1.目前linux最新的实现已经没有半连接队列了，连接请求的pseudo sock已经插入ehash(e代表establish，ehash即已连接hash队列)中了  详情<a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/net/ipv4/?id=079096f103faca2dd87342cca6f23d4b34da8871&amp;context=3&amp;ignorews=0&amp;dt=1">https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/net/ipv4/?id=079096f103faca2dd87342cca6f23d4b34da8871&amp;context=3&amp;ignorews=0&amp;dt=1</a></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>网络</category>
        <category>TCP</category>
      </categories>
      <tags>
        <tag>TCP</tag>
      </tags>
  </entry>
  <entry>
    <title>Zookeeper集群脑裂问题</title>
    <url>/2021/01/06/Zookeeper%E9%9B%86%E7%BE%A4%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>关于集群中的”脑裂”问题，之前已经<a href="https://www.cnblogs.com/kevingrace/p/7205846.html">在这里</a> 详细介绍过，下面重点说下Zookeeper脑裂问题的处理办法。ooKeeper是用来协调（同步）分布式进程的服务，提供了一个简单高性能的协调内核，用户可以在此之上构建更多复杂的分布式协调功能。脑裂通常会出现在集群环境中，比如ElasticSearch、Zookeeper集群，而这些集群环境有一个统一的特点，就是它们有一个大脑，比如ElasticSearch集群中有Master节点，Zookeeper集群中有Leader节点。</p>
<p><strong>一、 Zookeeper 集群节点为什么要部署成奇数</strong><br>zookeeper容错指的是：当宕掉几个zookeeper节点服务器之后，剩下的个数必须大于宕掉的个数，也就是剩下的节点服务数必须大于n/2，这样zookeeper集群才可以继续使用，无论奇偶数都可以选举leader。例如5台zookeeper节点机器最多宕掉2台，还可以继续使用，因为剩下3台大于5/2。 至于为什么最好为奇数个节点？这样是为了以最大容错服务器个数的条件下，能节省资源。比如，最大容错为2的情况下，对应的zookeeper服务数，奇数为5，而偶数为6，也就是6个zookeeper服务的情况下最多能宕掉2个服务，所以从节约资源的角度看，没必要部署6（偶数）个zookeeper服务节点。</p>
<p>zookeeper集群有这样一个特性：集群中只要有过半的机器是正常工作的，那么整个集群对外就是可用的。也就是说如果有2个zookeeper节点，那么只要有1个zookeeper节点死了，那么zookeeper服务就不能用了，因为1没有过半，所以2个zookeeper的死亡容忍度为0；同理，要是有3个zookeeper，一个死了，还剩下2个正常的，过半了，所以3个zookeeper的容忍度为1；同理也可以多列举几个：2-&gt;0; 3-&gt;1; 4-&gt;1; 5-&gt;2; 6-&gt;2 就会发现一个规律，2n和2n-1的容忍度是一样的，都是n-1，所以为了更加高效，何必增加那一个不必要的zookeeper呢。所以说，根据以上可以得出结论：从资源节省的角度来考虑，zookeeper集群的节点最好要部署成奇数个！</p>
<p><strong>二、 Zookeeper 集群中的”脑裂”场景说明</strong><br>对于一个集群，想要提高这个集群的可用性，通常会采用多机房部署，比如现在有一个由6台zkServer所组成的一个集群，部署在了两个机房：</p>
<p><img src="https://img2020.cnblogs.com/blog/907596/202003/907596-20200307120649932-714339480.png"></p>
<p>正常情况下，此集群只会有一个Leader，那么如果机房之间的网络断了之后，两个机房内的zkServer还是可以相互通信的，如果不考虑过半机制，那么就会出现每个机房内部都将选出一个Leader。</p>
<p><img src="https://img2020.cnblogs.com/blog/907596/202003/907596-20200307120741670-2124962886.png"></p>
<p>这就相当于原本一个集群，被分成了两个集群，出现了两个”大脑”，这就是所谓的”脑裂”现象。对于这种情况，其实也可以看出来，原本应该是统一的一个集群对外提供服务的，现在变成了两个集群同时对外提供服务，如果过了一会，断了的网络突然联通了，那么此时就会出现问题了，两个集群刚刚都对外提供服务了，数据该怎么合并，数据冲突怎么解决等等问题。刚刚在说明脑裂场景时有一个前提条件就是没有考虑过半机制，所以实际上Zookeeper集群中是不会轻易出现脑裂问题的，原因在于过半机制。</p>
<p>zookeeper的过半机制：在领导者选举的过程中，如果某台zkServer获得了超过半数的选票，则此zkServer就可以成为Leader了。举个简单的例子：如果现在集群中有5台zkServer，那么half=5/2=2，那么也就是说，领导者选举的过程中至少要有三台zkServer投了同一个zkServer，才会符合过半机制，才能选出来一个Leader。</p>
<p>那么zookeeper选举的过程中为什么一定要有一个过半机制验证？<br>因为这样不需要等待所有zkServer都投了同一个zkServer就可以选举出来一个Leader了，这样比较快，所以叫快速领导者选举算法。</p>
<p>zookeeper过半机制中为什么是大于，而不是大于等于？这就是更脑裂问题有关系了，比如回到上文出现脑裂问题的场景 [如上图1]：当机房中间的网络断掉之后，机房1内的三台服务器会进行领导者选举，但是此时过半机制的条件是 “节点数 &gt; 3”，也就是说至少要4台zkServer才能选出来一个Leader，所以对于机房1来说它不能选出一个Leader，同样机房2也不能选出一个Leader，这种情况下整个集群当机房间的网络断掉后，整个集群将没有Leader。 而如果过半机制的条件是 “节点数 &gt;= 3”，那么机房1和机房2都会选出一个Leader，这样就出现了脑裂。这就可以解释为什么过半机制中是大于而不是大于等于，目的就是为了防止脑裂。</p>
<p>如果假设我们现在只有5台机器，也部署在两个机房：</p>
<p><img src="https://img2020.cnblogs.com/blog/907596/202003/907596-20200307121116242-1425469546.png"></p>
<p>此时过半机制的条件是 “节点数 &gt; 2”，也就是至少要3台服务器才能选出一个Leader，此时机房件的网络断开了，对于机房1来说是没有影响的，Leader依然还是Leader，对于机房2来说是选不出来Leader的，此时整个集群中只有一个Leader。因此总结得出，有了过半机制，对于一个Zookeeper集群来说，要么没有Leader，要么只有1个Leader，这样zookeeper也就能避免了脑裂问题。</p>
<p><strong>三、 Zookeeper 集群”脑裂”问题处理</strong><br><strong>1.  什么是脑裂？</strong><br>简单点来说，脑裂(Split-Brain) 就是比如当你的 cluster 里面有两个节点，它们都知道在这个 cluster 里需要选举出一个 master。那么当它们两个之间的通信完全没有问题的时候，就会达成共识，选出其中一个作为 master。但是如果它们之间的通信出了问题，那么两个结点都会觉得现在没有 master，所以每个都把自己选举成 master，于是 cluster 里面就会有两个 master。</p>
<p>对于Zookeeper来说有一个很重要的问题，就是到底是根据一个什么样的情况来判断一个节点死亡down掉了？在分布式系统中这些都是有监控者来判断的，但是监控者也很难判定其他的节点的状态，唯一一个可靠的途径就是心跳，Zookeeper也是使用心跳来判断客户端是否仍然活着。</p>
<p>使用ZooKeeper来做Leader HA基本都是同样的方式：每个节点都尝试注册一个象征leader的临时节点，其他没有注册成功的则成为follower，并且通过watch机制 (<a href="https://www.cnblogs.com/kevingrace/p/7879390.html">这里有介绍</a>) 监控着leader所创建的临时节点，Zookeeper通过内部心跳机制来确定leader的状态，一旦leader出现意外Zookeeper能很快获悉并且通知其他的follower，其他flower在之后作出相关反应，这样就完成了一个切换，这种模式也是比较通用的模式，基本大部分都是这样实现的。但是这里面有个很严重的问题，如果注意不到会导致短暂的时间内系统出现脑裂，因为心跳出现超时可能是leader挂了，但是也可能是zookeeper节点之间网络出现了问题，导致leader假死的情况，leader其实并未死掉，但是与ZooKeeper之间的网络出现问题导致Zookeeper认为其挂掉了然后通知其他节点进行切换，这样follower中就有一个成为了leader，但是原本的leader并未死掉，这时候client也获得leader切换的消息，但是仍然会有一些延时，zookeeper需要通讯需要一个一个通知，这时候整个系统就很混乱可能有一部分client已经通知到了连接到新的leader上去了，有的client仍然连接在老的leader上，如果同时有两个client需要对leader的同一个数据更新，并且刚好这两个client此刻分别连接在新老的leader上，就会出现很严重问题。</p>
<p>这里做下小总结：<br><strong>假死</strong>：由于心跳超时（网络原因导致的）认为leader死了，但其实leader还存活着。<br><strong>脑裂</strong>：由于假死会发起新的leader选举，选举出一个新的leader，但旧的leader网络又通了，导致出现了两个leader ，有的客户端连接到老的leader，而有的客户端则连接到新的leader。</p>
<p><strong>2.  zookeeper脑裂是什么原因导致的？</strong><br>主要原因是Zookeeper集群和Zookeeper client判断超时并不能做到完全同步，也就是说可能一前一后，如果是集群先于client发现，那就会出现上面的情况。同时，在发现并切换后通知各个客户端也有先后快慢。一般出现这种情况的几率很小，需要leader节点与Zookeeper集群网络断开，但是与其他集群角色之间的网络没有问题，还要满足上面那些情况，但是一旦出现就会引起很严重的后果，数据不一致。</p>
<p><strong>3.  zookeeper是如何解决”脑裂”问题的？</strong><br>要解决Split-Brain脑裂的问题，一般有下面几种种方法：<br>Quorums (法定人数) 方式: 比如3个节点的集群，Quorums = 2, 也就是说集群可以容忍1个节点失效，这时候还能选举出1个lead，集群还可用。比如4个节点的集群，它的Quorums = 3，Quorums要超过3，相当于集群的容忍度还是1，如果2个节点失效，那么整个集群还是无效的。这是zookeeper防止”脑裂”默认采用的方法。<br>采用Redundant communications (冗余通信)方式：集群中采用多种通信方式，防止一种通信方式失效导致集群中的节点无法通信。<br>Fencing (共享资源) 方式：比如能看到共享资源就表示在集群中，能够获得共享资源的锁的就是Leader，看不到共享资源的，就不在集群中。<br>仲裁机制方式。<br>启动磁盘锁定方式。</p>
<p>要想避免zookeeper”脑裂”情况其实也很简单，在follower节点切换的时候不在检查到老的leader节点出现问题后马上切换，而是在休眠一段足够的时间，确保老的leader已经获知变更并且做了相关的shutdown清理工作了然后再注册成为master就能避免这类问题了，这个休眠时间一般定义为与zookeeper定义的超时时间就够了，但是这段时间内系统可能是不可用的，但是相对于数据不一致的后果来说还是值得的。</p>
<p>1、zooKeeper默认采用了Quorums这种方式来防止”脑裂”现象。即只有集群中超过半数节点投票才能选举出Leader。这样的方式可以确保leader的唯一性,要么选出唯一的一个leader,要么选举失败。在zookeeper中Quorums作用如下：<br><strong>1]</strong> 集群中最少的节点数用来选举leader保证集群可用。<br><strong>2]</strong> 通知客户端数据已经安全保存前集群中最少数量的节点数已经保存了该数据。一旦这些节点保存了该数据，客户端将被通知已经安全保存了，可以继续其他任务。而集群中剩余的节点将会最终也保存了该数据。</p>
<p>假设某个leader假死，其余的followers选举出了一个新的leader。这时，旧的leader复活并且仍然认为自己是leader，这个时候它向其他followers发出写请求也是会被拒绝的。因为每当新leader产生时，会生成一个epoch标号(标识当前属于那个leader的统治时期)，这个epoch是递增的，followers如果确认了新的leader存在，知道其epoch，就会拒绝epoch小于现任leader epoch的所有请求。那有没有follower不知道新的leader存在呢，有可能，但肯定不是大多数，否则新leader无法产生。Zookeeper的写也遵循quorum机制，因此，得不到大多数支持的写是无效的，旧leader即使各种认为自己是leader，依然没有什么作用。</p>
<p>zookeeper除了可以采用上面默认的Quorums方式来避免出现”脑裂”，还可以可采用下面的预防措施：<br>2、添加冗余的心跳线，例如双线条线，尽量减少“裂脑”发生机会。<br>3、启用磁盘锁。正在服务一方锁住共享磁盘，”裂脑”发生时，让对方完全”抢不走”共享磁盘资源。但使用锁磁盘也会有一个不小的问题，如果占用共享盘的一方不主动”解锁”，另一方就永远得不到共享磁盘。现实中假如服务节点突然死机或崩溃，就不可能执行解锁命令。后备节点也就接管不了共享资源和应用服务。于是有人在HA中设计了”智能”锁。即正在服务的一方只在发现心跳线全部断开（察觉不到对端）时才启用磁盘锁。平时就不上锁了。<br>4、设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下 参考IP，不通则表明断点就出在本端，不仅”心跳”、还兼对外”服务”的本端网络链路断了，即使启动（或继续）应用服务也没有用了，那就主动放弃竞争，让能够ping通参考IP的一端去起服务。更保险一些，ping不通参考IP的一方干脆就自我重启，以彻底释放有可能还占用着的那些共享资源。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>分布式协调</category>
        <category>Zookeeper</category>
      </categories>
      <tags>
        <tag>Zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>apc测试</title>
    <url>/2016/01/03/apc%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<blockquote>
<p>thinkphp 3.2.1 demo</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ ab -n5000 -c100 http://dev.demo.com/iframe.thinkphp/3.2.1/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking dev.demo.com (be patient)</span><br><span class="line">Completed 500 requests</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 1500 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 2500 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 3500 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 4500 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Finished 5000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache/2.2.22</span><br><span class="line">Server Hostname:        dev.demo.com</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /iframe.thinkphp/3.2.1/</span><br><span class="line">Document Length:        445 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken for tests:   102.252 seconds</span><br><span class="line">Complete requests:      5000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      4000000 bytes</span><br><span class="line">HTML transferred:       2225000 bytes</span><br><span class="line">Requests per second:    48.90 [#/sec] (mean)</span><br><span class="line">Time per request:       2045.045 [ms] (mean)</span><br><span class="line">Time per request:       20.450 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          38.20 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    1   2.0      1      20</span><br><span class="line">Processing:   836 2036 477.5   1993    7018</span><br><span class="line">Waiting:      835 1923 474.8   1876    7018</span><br><span class="line">Total:        836 2037 477.4   1994    7019</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%   1994</span><br><span class="line">  66%   2114</span><br><span class="line">  75%   2191</span><br><span class="line">  80%   2239</span><br><span class="line">  90%   2401</span><br><span class="line">  95%   2581</span><br><span class="line">  98%   2817</span><br><span class="line">  99%   3206</span><br><span class="line"> 100%   7019 (longest request)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>开启apc后</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ ab -n5000 -c100 http://dev.demo.com/iframe.thinkphp/3.2.1/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking dev.demo.com (be patient)</span><br><span class="line">Completed 500 requests</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 1500 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 2500 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 3500 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 4500 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Finished 5000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache/2.2.22</span><br><span class="line">Server Hostname:        dev.demo.com</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /iframe.thinkphp/3.2.1/</span><br><span class="line">Document Length:        445 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken for tests:   34.969 seconds</span><br><span class="line">Complete requests:      5000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      4000000 bytes</span><br><span class="line">HTML transferred:       2225000 bytes</span><br><span class="line">Requests per second:    142.98 [#/sec] (mean)</span><br><span class="line">Time per request:       699.382 [ms] (mean)</span><br><span class="line">Time per request:       6.994 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          111.71 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    1   2.0      1      18</span><br><span class="line">Processing:    61  695 353.2    658    4606</span><br><span class="line">Waiting:       14  658 347.7    615    4606</span><br><span class="line">Total:         61  696 353.0    658    4607</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%    658</span><br><span class="line">  66%    743</span><br><span class="line">  75%    800</span><br><span class="line">  80%    836</span><br><span class="line">  90%    946</span><br><span class="line">  95%   1072</span><br><span class="line">  98%   1340</span><br><span class="line">  99%   2618</span><br><span class="line"> 100%   4607 (longest request)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>原创</tag>
        <tag>PHP</tag>
        <tag>APC</tag>
      </tags>
  </entry>
  <entry>
    <title>explain</title>
    <url>/2016/01/03/explain/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `case1_article` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `mid` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `title` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `n_click` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `content` TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `publishtime` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `status` TINYINT(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    INDEX `mid` (`mid`)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;latin1_swedish_ci&#x27;</span></span><br><span class="line">ENGINE<span class="operator">=</span>InnoDB</span><br><span class="line">AUTO_INCREMENT<span class="operator">=</span><span class="number">100001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `case1_member` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `createtime` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `status` TINYINT(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;latin1_swedish_ci&#x27;</span></span><br><span class="line">ENGINE<span class="operator">=</span>InnoDB</span><br><span class="line">AUTO_INCREMENT<span class="operator">=</span><span class="number">10001</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case1_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows   | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 100752 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |      1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case1_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id <span class="keyword">desc</span> limit <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | index  | mid           | PRIMARY | 4       | NULL       |  100 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |    1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case1_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> limit <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows   | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 100752 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |      1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case1_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id <span class="keyword">asc</span> limit <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | index  | mid           | PRIMARY | 4       | NULL       |  100 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |    1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br></pre></td></tr></table></figure>


<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a,case1_member <span class="keyword">as</span> b <span class="keyword">where</span> a.mid <span class="operator">=</span> b.id <span class="keyword">and</span>  a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows   | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 100752 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |      1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a,case1_member <span class="keyword">as</span> b <span class="keyword">where</span> a.mid <span class="operator">=</span> b.id <span class="keyword">and</span>  a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> limit <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows   | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 100752 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |      1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+--------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case1_article <span class="keyword">as</span> a,case1_member <span class="keyword">as</span> b <span class="keyword">where</span> a.mid <span class="operator">=</span> b.id <span class="keyword">and</span>  a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id limit <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | index  | mid           | PRIMARY | 4       | NULL       |  100 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |    1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+---------------+------+---------------+------+---------+-------+------+-------+</span><br><span class="line">| id | select_type | table         | type | possible_keys | key  | key_len | ref   | rows | Extra |</span><br><span class="line">+----+-------------+---------------+------+---------------+------+---------+-------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | case1_article | ref  | mid           | mid  | 4       | const |   10 |       |</span><br><span class="line">+----+-------------+---------------+------+---------------+------+---------+-------+------+-------+</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> id <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="operator">=</span> <span class="number">2</span> <span class="keyword">or</span> mid <span class="operator">=</span><span class="number">12</span> <span class="keyword">or</span> mid<span class="operator">=</span><span class="number">13</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">| id | select_type | table         | type  | possible_keys | key  | key_len | ref  | rows | Extra                    |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | case1_article | range | mid           | mid  | 4       | NULL |   27 | Using where; Using index |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> id <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">12</span>,<span class="number">13</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">| id | select_type | table         | type  | possible_keys | key  | key_len | ref  | rows | Extra                    |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | case1_article | range | mid           | mid  | 4       | NULL |   27 | Using where; Using index |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> id <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="keyword">between</span> <span class="number">2</span> <span class="keyword">and</span> <span class="number">13</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">| id | select_type | table         | type  | possible_keys | key  | key_len | ref  | rows | Extra                    |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | case1_article | range | mid           | mid  | 4       | NULL |  122 | Using where; Using index |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">explain <span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">12</span>,<span class="number">13</span>) <span class="keyword">group</span> <span class="keyword">by</span> mid;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">| id | select_type | table         | type  | possible_keys | key  | key_len | ref  | rows | Extra                    |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | case1_article | range | mid           | mid  | 4       | NULL |   27 | Using where; Using index |</span><br><span class="line">+----+-------------+---------------+-------+---------------+------+---------+------+------+--------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">explain (<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">2</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">12</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case1_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">13</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+--------------+---------------+------+---------------+------+---------+-------+------+-------------+</span><br><span class="line">| id | select_type  | table         | type | possible_keys | key  | key_len | ref   | rows | Extra       |</span><br><span class="line">+----+--------------+---------------+------+---------------+------+---------+-------+------+-------------+</span><br><span class="line">|  1 | PRIMARY      | case1_article | ref  | mid           | mid  | 4       | const |   10 | Using index |</span><br><span class="line">|  2 | UNION        | case1_article | ref  | mid           | mid  | 4       | const |   10 | Using index |</span><br><span class="line">|  3 | UNION        | case1_article | ref  | mid           | mid  | 4       | const |    7 | Using index |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2,3&gt;  | ALL  | NULL          | NULL | NULL    | NULL  | NULL |             |</span><br><span class="line">+----+--------------+---------------+------+---------------+------+---------+-------+------+-------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>原创</tag>
        <tag>explain</tag>
      </tags>
  </entry>
  <entry>
    <title>macos 升级 10.15.4 导致 git 无法拉取代码问题</title>
    <url>/2020/03/29/macos-%E5%8D%87%E7%BA%A7-10-15-4-%E5%AF%BC%E8%87%B4-git-%E6%97%A0%E6%B3%95%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>今天发现 macos 推送了最新版本 10.15.4</p>
<p>逐马上更新了系统，但是更新系统以后发现一个玄学问题。</p>
<p>公司自建的 git 仓库无法拉取代码，执行 git pull 一直在等待毫无反应。</p>
<p>由于我的 git 一直使用的是 ssh 协议拉取，尝试过更新 Iterm2,git 均未解决。</p>
<p>开始是怀疑由于我本机是否有一些全局代理导致的问题，但是尝试过其他 github，gitee 等公有仓库均可以正常拉取代码。</p>
<p>后来看到 V2ex 上一片帖子也有人遇到跟我一样的问题</p>
<p>是我本机的 V2ray 开启了 pac 模式，导致了这一问题出现。</p>
<p>解决方案，执行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">brew install openssh</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>版本管理</category>
        <category>GIT</category>
      </categories>
      <tags>
        <tag>GIT</tag>
      </tags>
  </entry>
  <entry>
    <title>nignx缓存proxy_cache</title>
    <url>/2016/07/25/nignx%E7%BC%93%E5%AD%98proxy-cache/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ssh root@192.168.1.123 -p 32200</span><br><span class="line"></span><br><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">user  www www;</span><br><span class="line">worker_processes  1;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr\t$msec\t[$time_local]\t$request\t&#x27;</span><br><span class="line">                     &#x27;&quot;$status&quot;\t$body_bytes_sent\t&quot;$http_referer&quot;\t&#x27;</span><br><span class="line">                     &#x27;&quot;$http_user_agent&quot;\t&quot;$http_q_ua&quot;\t&quot;$http_x_forwarded_for&quot;\t&#x27;</span><br><span class="line">                     &#x27;&quot;$upstream_addr&quot;\t$request_time&#x27;;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name dev123.demo.com dev123.demo.proxy.com;</span><br><span class="line">        access_log  logs/dev123.demo.com-access.log;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /var/www/demo;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            root   /var/www/demo;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">/etc/init.d/nginx reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssh root@192.168.1.120 -p 32200</span><br><span class="line"></span><br><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">user  www www;</span><br><span class="line">worker_processes  1;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr\t$msec\t[$time_local]\t$request\t&#x27;</span><br><span class="line">                     &#x27;&quot;$status&quot;\t$body_bytes_sent\t&quot;$http_referer&quot;\t&#x27;</span><br><span class="line">                     &#x27;&quot;$http_user_agent&quot;\t&quot;$http_q_ua&quot;\t&quot;$http_x_forwarded_for&quot;\t&#x27;</span><br><span class="line">                     &#x27;&quot;$upstream_addr&quot;\t$request_time&#x27;;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    proxy_cache_path /usr/local/nginx/proxy_cache levels=1:2 keys_zone=my-cache:8m max_size=1000m inactive=600m;</span><br><span class="line">    proxy_temp_path /usr/local/nginx/proxy_temp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    upstream dev123 &#123;</span><br><span class="line">        server 192.168.1.123:80;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name dev123.demo.proxy.com;</span><br><span class="line">        error_log  logs/dev123.demo.proxy.com-error.log;</span><br><span class="line">        access_log  logs/dev123.demo.proxy.com-access.log;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://dev123;</span><br><span class="line">            proxy_cache my-cache;</span><br><span class="line">            proxy_cache_valid 200 10m;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">/etc/init.d/nginx reload</span><br><span class="line"></span><br><span class="line">curl &#x27;http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl &#x27;http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl &#x27;http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl &#x27;http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl &#x27;http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl -d &#x27;&#x27; http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl -d &#x27;&#x27; http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl -d &#x27;&#x27; http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl -d &#x27;&#x27; http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line">curl -d &#x27;&#x27; http://dev123.demo.proxy.com/tmp/get-serv.php&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssh root@192.168.1.123 -p 32200</span><br><span class="line"></span><br><span class="line">tail -n 10 /usr/local/nginx/logs/dev123.demo.com-access.log</span><br><span class="line"></span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:32:28 -0400] &quot;GET /tmp/get-serv.php HTTP/1.0&quot; 200 988 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:33:03 -0400] &quot;POST /tmp/get-serv.php HTTP/1.0&quot; 200 1115 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:33:03 -0400] &quot;POST /tmp/get-serv.php HTTP/1.0&quot; 200 1115 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:33:04 -0400] &quot;POST /tmp/get-serv.php HTTP/1.0&quot; 200 1114 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:33:06 -0400] &quot;POST /tmp/get-serv.php HTTP/1.0&quot; 200 1115 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">192.168.1.120 - - [24/Jul/2016:12:33:07 -0400] &quot;POST /tmp/get-serv.php HTTP/1.0&quot; 200 1115 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><a href="http://www.ttlsa.com/nginx/nginx-high-performance-caching/">http://www.ttlsa.com/nginx/nginx-high-performance-caching/</a></p>
]]></content>
      <categories>
        <category>web服务器</category>
        <category>nignx</category>
      </categories>
      <tags>
        <tag>nignx</tag>
      </tags>
  </entry>
  <entry>
    <title>oh my zsh 补全不生效问题</title>
    <url>/2020/04/04/oh-my-zsh-%E8%A1%A5%E5%85%A8%E4%B8%8D%E7%94%9F%E6%95%88%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>安装了以下插件，但是自动补全没生效</p>
<p>~/.zshrc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">plugins=(</span><br><span class="line">  zsh-completions</span><br><span class="line">  kubectl</span><br><span class="line">  docker</span><br><span class="line">  docker-compose</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">rm -rf ~/.zcompdump*</span><br><span class="line"></span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>操作系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
        <tag>Linux</tag>
        <tag>Q&amp;A</tag>
      </tags>
  </entry>
  <entry>
    <title>php编译中遇到种种error解决办法</title>
    <url>/2016/05/09/php%E7%BC%96%E8%AF%91%E4%B8%AD%E9%81%87%E5%88%B0%E7%A7%8D%E7%A7%8Derror%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
    <content><![CDATA[<ol>
<li>Configure: error: xml2-config not found. Please check your libxml2 installation.<br>Solutions :<br>Quote:<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#yum install libxml2 libxml2-devel (For Redhat &amp; Fedora)</span><br><span class="line"># aptitude install libxml2-dev      (For ubuntu)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>Checking for pkg-config… /usr/bin/pkg-config<br>configure: error: Cannot find OpenSSL’s &lt;evp.h&gt;<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#yum install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Configure: error: Please reinstall the BZip2 distribution<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install bzip2 bzip2-devel</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Configure: error: Please reinstall the libcurl distribution -<br>easy.h should be in <curl-dir>/include/curl/<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install curl curl-devel   (For Redhat &amp; Fedora)</span><br><span class="line"># install libcurl4-gnutls-dev    (For Ubuntu) </span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Configure: error: libjpeg.(also) not found.<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install libjpeg libjpeg-devel</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Configure: error: libpng.(also) not found.<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install libpng libpng-devel</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>Configure: error: freetype.h not found.<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#yum install freetype-devel</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>Configure: error: Unable to locate gmp.h<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install gmp-devel</span><br></pre></td></tr></table></figure>


<ol start="9">
<li>Configure: error: Cannot find MySQL header files under /usr.<br>Note that the MySQL client library is not bundled anymore!<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install mysql-devel            (For Redhat &amp; Fedora)</span><br><span class="line"># apt-get install libmysql++-dev      (For Ubuntu) </span><br></pre></td></tr></table></figure>


<ol start="10">
<li>Configure: error: Please reinstall the ncurses distribution<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install ncurses ncurses-devel</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>Checking for unixODBC support… configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found!<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install unixODBC-devel</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>Configure: error: Cannot find pspell<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install pspell-devel</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>configure: error: mcrypt.h not found. Please reinstall libmcrypt.<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://sourceforge.net/projects/mcrypt/files/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.gz/download</span><br><span class="line">mv download libmcrypt-2.5.8.tar.gz</span><br><span class="line">tar zxvf libmcrypt-2.5.8.tar.gz</span><br><span class="line">cd libmcrypt-2.5.8</span><br><span class="line">./configure --prefix=/usr/local/mcrypt</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="14">
<li>Configure: error: snmp.h not found. Check your SNMP installation.<br>Solutions :<br>Quote:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install net-snmp net-snmp-devel</span><br></pre></td></tr></table></figure>

<p>15)configure: error: Please reinstall libmhash – I cannot find mhash.h</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#yum install mhash-devel</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>select语句执行顺序</title>
    <url>/2016/01/03/select%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/</url>
    <content><![CDATA[<h3 id="SELECT语句定义"><a href="#SELECT语句定义" class="headerlink" title="SELECT语句定义"></a>SELECT语句定义</h3><p>一个完成的SELECT语句包含可选的几个子句。SELECT语句的定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;SELECT clause&gt; [&lt;FROM clause&gt;] [&lt;WHERE clause&gt;] [&lt;GROUP BY clause&gt;] [&lt;HAVING clause&gt;] [&lt;ORDER BY clause&gt;] [&lt;LIMIT clause&gt;]</span><br></pre></td></tr></table></figure>

<p>SELECT子句是必选的，其它子句如WHERE子句、GROUP BY子句等是可选的。</p>
<p>一个SELECT语句中，子句的顺序是固定的。例如GROUP BY子句不会位于WHERE子句的前面。</p>
<h3 id="SELECT语句执行顺序"><a href="#SELECT语句执行顺序" class="headerlink" title="SELECT语句执行顺序"></a>SELECT语句执行顺序</h3><p>SELECT语句中子句的执行顺序与SELECT语句中子句的输入顺序是不一样的，所以并不是从SELECT子句开始执行的，而是按照下面的顺序执行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">开始-&gt;FROM子句-&gt;WHERE子句-&gt;GROUP BY子句-&gt;HAVING子句-&gt;ORDER BY子句-&gt;SELECT子句-&gt;LIMIT子句-&gt;最终结果</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>每个子句执行后都会产生一个中间结果，供接下来的子句使用，如果不存在某个子句，就跳过</p>
]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>syslog-ng安装部署</title>
    <url>/2016/10/22/syslog-ng%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><blockquote>
<p>日志客户端机</p>
</blockquote>
<p>ip   : 192.168.1.120</p>
<p>系统 : CentOS Linux release 7.1.1503 (Core)</p>
<blockquote>
<p>日志服务端机</p>
</blockquote>
<p>ip   : 192.168.1.121</p>
<p>系统 : CentOS Linux release 7.1.1503 (Core)</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>参考资料</p>
</blockquote>
<p><a href="https://syslog-ng.gitbooks.io/getting-started/content/">https://syslog-ng.gitbooks.io/getting-started/content/</a></p>
<p><a href="http://www.sa-log.com/101.html">http://www.sa-log.com/101.html</a></p>
<blockquote>
<p>执行安装</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">wget http://www.balabit.com/downloads/files/syslog-ng/sources/3.2.4/source/eventlog_0.2.12.tar.gz</span><br><span class="line"></span><br><span class="line">tar xvf eventlog_0.2.12.tar.gz</span><br><span class="line"></span><br><span class="line">cd eventlog-0.2.12</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/eventlog &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>syslog-ng的包可以在这找到</p>
<p><a href="https://github.com/balabit/syslog-ng/releases/">https://github.com/balabit/syslog-ng/releases/</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">yum -y install glib2-devel json-c-devel</span><br><span class="line"></span><br><span class="line">wget https://github.com/balabit/syslog-ng/releases/download/syslog-ng-3.8.1/syslog-ng-3.8.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar xvf syslog-ng-3.8.1.tar.gz</span><br><span class="line"></span><br><span class="line">cd syslog-ng-3.8.1</span><br><span class="line"></span><br><span class="line">export PKG_CONFIG_PATH=/usr/local/eventlog/lib/pkgconfig</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/syslog-ng --enable-json &amp;&amp; make&amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cp ./contrib/rhel-packaging/syslog-ng.init /etc/init.d/syslog-ng</span><br><span class="line"></span><br><span class="line">chmod +x /etc/init.d/syslog-ng</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<blockquote>
<p>启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/syslog-ng start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/syslog-ng/sbin/syslog-ng</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="安装遇到的问题"><a href="#安装遇到的问题" class="headerlink" title="安装遇到的问题"></a>安装遇到的问题</h1><blockquote>
<p>安装syslog-ng时，编译报错：configure: error: Package requirements (glib-2.0 &gt;= 2.10.1 gmodule-2.0 gthread-2.0) were not met</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install glib2-devel</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动syslog-ng失败，报错：template: $(format-json)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install json-c-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd syslog-ng-3.8.1</span><br><span class="line"></span><br><span class="line">export PKG_CONFIG_PATH=/usr/local/eventlog/lib/pkgconfig</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/syslog-ng --enable-json &amp;&amp; make&amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动syslog-ng报错：Error opening plugin module; module=’mod-java’, error=’libjvm.so: cannot open shared object file: No such file or directory’</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">find /usr -name libjvm.so</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找到该文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.65-2.b17.el7_1.x86_64/jre/lib/amd64/server/libjvm.so</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>做软链，目的要让libjvm.so可以访问到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">export LD_LIBRARY_PATH=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.65-2.b17.el7_1.x86_64/jre/lib/amd64/server:$LD_LIBRARY_PATH</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><blockquote>
<p>在192.168.1.121上构建日志中心，192.168.1.120落地本地日志并上报到日志中心</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p22 root@192.168.1.120</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">vi /usr/local/syslog-ng/etc/syslog-ng.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@version: 3.8</span><br><span class="line">@include &quot;scl.conf&quot;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        log_msg_size(16384);</span><br><span class="line">        flush_lines(1);</span><br><span class="line">        log_fifo_size(1000000);</span><br><span class="line">        time_reopen(10);</span><br><span class="line">        use_dns(no);</span><br><span class="line">        dns_cache(yes);</span><br><span class="line">        use_fqdn(yes);</span><br><span class="line">        keep_hostname(yes);</span><br><span class="line">        chain_hostnames(no);</span><br><span class="line">        check_hostname(yes);</span><br><span class="line">        create_dirs(yes);</span><br><span class="line">        dir_perm(0755);</span><br><span class="line">        perm(0644);</span><br><span class="line">        stats_freq(1800);</span><br><span class="line">    threaded(yes);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">source s_local &#123;</span><br><span class="line">    #standard Linux log source (this is the default place for the syslog()</span><br><span class="line"># function to send logs to)</span><br><span class="line">    unix-stream(&quot;/dev/log&quot; max-connections(10240) log_iw_size(1024000));</span><br><span class="line"># messages from the kernel</span><br><span class="line">    file(&quot;/proc/kmsg&quot; program_override(&quot;kernel&quot;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## project logs</span><br><span class="line"></span><br><span class="line">destination d_remote_local6 &#123;tcp(&#x27;192.168.1.121&#x27; port(5124));&#125;;</span><br><span class="line">destination d_remote_back_all &#123;file(&quot;/var/log/projlogs/$PROGRAM/$YEAR$MONTH/$DAY/$HOUR&quot; perm(0644) dir_perm(0755) create_dirs(yes) );&#125;;</span><br><span class="line">filter f_remote_log_all &#123; facility(local6) and match(&quot;/&quot; value(&quot;PROGRAM&quot;));&#125;;</span><br><span class="line"></span><br><span class="line">log &#123;</span><br><span class="line">    source(s_local);</span><br><span class="line">    filter(f_remote_log_all);</span><br><span class="line">    destination(d_remote_back_all);</span><br><span class="line">    destination(d_remote_local6);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p22 root@192.168.1.121</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">vi /usr/local/syslog-ng/etc/syslog-ng.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@version: 3.8</span><br><span class="line">@include &quot;scl.conf&quot;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        flush_lines (0);</span><br><span class="line">        time_reopen (10);</span><br><span class="line">        log_fifo_size (1000);</span><br><span class="line">        chain_hostnames (off);</span><br><span class="line">        use_dns (no);</span><br><span class="line">        use_fqdn (no);</span><br><span class="line">        create_dirs (yes);</span><br><span class="line">        keep_hostname (no);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">source src_projlog &#123;</span><br><span class="line">    tcp(ip(&quot;192.168.1.121&quot;) port(5124));</span><br><span class="line">&#125;;</span><br><span class="line">                                                         </span><br><span class="line">                                                        </span><br><span class="line">filter f_remote_log_all &#123;facility(local6) and match(&quot;/&quot; value(&quot;PROGRAM&quot;));&#125;; </span><br><span class="line">                                                         </span><br><span class="line">destination dst_projlog &#123;</span><br><span class="line">    file(&quot;/var/log/center_projlogs/$PROGRAM/$YEAR$MONTH/$DAY/$HOUR&quot; perm(0644) dir_perm(0755) create_dirs(yes));</span><br><span class="line">&#125;;</span><br><span class="line">                                                         </span><br><span class="line">                                                         </span><br><span class="line">log &#123;</span><br><span class="line">    source(src_projlog);</span><br><span class="line">    filter(f_remote_log_all);</span><br><span class="line">    destination(dst_projlog);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>




<blockquote>
<p>在192.168.1.121上构建日志中心，192.168.1.120不落地本地日志，只上报到日志中心</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p22 root@192.168.1.120</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">vi /usr/local/syslog-ng/etc/syslog-ng.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@version: 3.8</span><br><span class="line">@include &quot;scl.conf&quot;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        log_msg_size(16384);</span><br><span class="line">        flush_lines(1);</span><br><span class="line">        log_fifo_size(1000000);</span><br><span class="line">        time_reopen(10);</span><br><span class="line">        use_dns(no);</span><br><span class="line">        dns_cache(yes);</span><br><span class="line">        use_fqdn(yes);</span><br><span class="line">        keep_hostname(yes);</span><br><span class="line">        chain_hostnames(no);</span><br><span class="line">        check_hostname(yes);</span><br><span class="line">        create_dirs(yes);</span><br><span class="line">        dir_perm(0755);</span><br><span class="line">        perm(0644);</span><br><span class="line">        stats_freq(1800);</span><br><span class="line">    threaded(yes);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">source s_local &#123;</span><br><span class="line">    #standard Linux log source (this is the default place for the syslog()</span><br><span class="line"># function to send logs to)</span><br><span class="line">    unix-stream(&quot;/dev/log&quot; max-connections(10240) log_iw_size(1024000));</span><br><span class="line"># messages from the kernel</span><br><span class="line">    file(&quot;/proc/kmsg&quot; program_override(&quot;kernel&quot;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## project logs</span><br><span class="line"></span><br><span class="line">destination d_remote_local6 &#123;tcp(&#x27;192.168.1.121&#x27; port(5124));&#125;;</span><br><span class="line">filter f_remote_log_all &#123; facility(local6) and match(&quot;/&quot; value(&quot;PROGRAM&quot;));&#125;;</span><br><span class="line"></span><br><span class="line">log &#123;</span><br><span class="line">    source(s_local);</span><br><span class="line">    filter(f_remote_log_all);</span><br><span class="line">    destination(d_remote_local6);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p22 root@192.168.1.121</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">vi /usr/local/syslog-ng/etc/syslog-ng.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@version: 3.8</span><br><span class="line">@include &quot;scl.conf&quot;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        flush_lines (0);</span><br><span class="line">        time_reopen (10);</span><br><span class="line">        log_fifo_size (1000);</span><br><span class="line">        chain_hostnames (off);</span><br><span class="line">        use_dns (no);</span><br><span class="line">        use_fqdn (no);</span><br><span class="line">        create_dirs (yes);</span><br><span class="line">        keep_hostname (no);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">source src_projlog &#123;</span><br><span class="line">    tcp(ip(&quot;192.168.1.121&quot;) port(5124));</span><br><span class="line">&#125;;</span><br><span class="line">                                                         </span><br><span class="line">                                                        </span><br><span class="line">filter f_remote_log_all &#123;facility(local6) and match(&quot;/&quot; value(&quot;PROGRAM&quot;));&#125;; </span><br><span class="line">                                                         </span><br><span class="line">destination dst_projlog &#123;</span><br><span class="line">    file(&quot;/var/log/center_projlogs/$PROGRAM/$YEAR$MONTH/$DAY/$HOUR&quot; perm(0644) dir_perm(0755) create_dirs(yes));</span><br><span class="line">&#125;;</span><br><span class="line">                                                         </span><br><span class="line">                                                         </span><br><span class="line">log &#123;</span><br><span class="line">    source(src_projlog);</span><br><span class="line">    filter(f_remote_log_all);</span><br><span class="line">    destination(dst_projlog);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>日志工具</category>
        <category>syslog-ng</category>
      </categories>
      <tags>
        <tag>syslog-ng</tag>
      </tags>
  </entry>
  <entry>
    <title>为了解决 Prometheus 大内存问题，我竟然强行将 Prometheus Operator 给肢解了</title>
    <url>/2020/09/20/%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3-Prometheus-%E5%A4%A7%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%EF%BC%8C%E6%88%91%E7%AB%9F%E7%84%B6%E5%BC%BA%E8%A1%8C%E5%B0%86-Prometheus-Operator-%E7%BB%99%E8%82%A2%E8%A7%A3%E4%BA%86/</url>
    <content><![CDATA[<p>Promtheus 本身只支持单机部署，没有自带支持集群部署，也不支持高可用以及水平扩容，它的存储空间受限于本地磁盘的容量。同时随着数据采集量的增加，单台 Prometheus 实例能够处理的时间序列数会达到瓶颈，这时 CPU 和内存都会升高，一般内存先达到瓶颈，主要原因有：</p>
<ul>
<li><p>  Prometheus 的内存消耗主要是因为每隔 2 小时做一个 Block 数据落盘，落盘之前所有数据都在内存里面，因此和采集量有关。</p>
</li>
<li><p>  加载历史数据时，是从磁盘到内存的，查询范围越大，内存越大。这里面有一定的优化空间。</p>
</li>
<li><p>  一些不合理的查询条件也会加大内存，如 Group 或大范围 Rate。</p>
</li>
</ul>
<p>这个时候要么加内存，要么通过集群分片来减少每个实例需要采集的指标。本文就来讨论通过 Prometheus Operator 部署的 Prometheus 如何根据服务维度来拆分实例。</p>
<h2 id="1-根据服务维度拆分-Prometheus"><a href="#1-根据服务维度拆分-Prometheus" class="headerlink" title="1. 根据服务维度拆分 Prometheus"></a>1. 根据服务维度拆分 Prometheus</h2><p>Prometheus 主张根据功能或服务维度进行拆分，即如果要采集的服务比较多，一个 Prometheus 实例就配置成仅采集和存储某一个或某一部分服务的指标，这样根据要采集的服务将 Prometheus 拆分成多个实例分别去采集，也能一定程度上达到水平扩容的目的。</p>
<p><img src="https://p.tomhjx.top/Ft6XrR-_NPONCk89EDMgto_Grsyl"></p>
<p>在 Kubernetes 集群中，我们可以根据 namespace 来拆分 Prometheus 实例，例如将所有 Kubernetes 集群组件相关的监控发送到一个 Prometheus 实例，将其他所有监控发送到另一个 Prometheus 实例。</p>
<p>Prometheus Operator 通过 CRD 资源名 Prometheus 来控制 Prometheus 实例的部署，其中可以通过在配置项 serviceMonitorNamespaceSelector 和 podMonitorNamespaceSelector 中指定标签来限定抓取 target 的 namespace。例如，将 namespace kube-system 打上标签 monitoring-role=system，将其他的 namespace 打上标签 monitoring-role=others。</p>
<p><img src="https://p.tomhjx.top/Ftsa_E57HLAP8Aaeo1Cb02skJgQE"></p>
<h2 id="2-告警规则拆分"><a href="#2-告警规则拆分" class="headerlink" title="2. 告警规则拆分"></a>2. 告警规则拆分</h2><p>将 Prometheus 拆分成多个实例之后，就不能再使用默认的告警规则了，因为默认的告警规则是针对所有 target 的监控指标的，每一个 Prometheus 实例都无法获取所有 target 的监控指标，势必会一直报警。为了解决这个问题，需要对告警规则进行拆分，使其与每个 Prometheus 实例的服务维度一一对应，按照上文的拆分逻辑，这里只需要拆分成两个告警规则，打上不同的标签，然后在 CRD 资源 Prometheus 中通过配置项 ruleSelector 指定规则标签来选择相应的告警规则。</p>
<p><img src="https://p.tomhjx.top/Fg6XWxhLVkhObUQkFEDAtFaVU22y"></p>
<h2 id="3-集中数据存储"><a href="#3-集中数据存储" class="headerlink" title="3. 集中数据存储"></a>3. 集中数据存储</h2><p>解决了告警问题之后，还有一个问题，现在监控数据比较分散，使用 Grafana 查询监控数据时我们也需要添加许多数据源，而且不同数据源之间的数据还不能聚合查询，监控页面也看不到全局的视图，造成查询混乱的局面。</p>
<p>为了解决这个问题，我们可以让 Prometheus 不负责存储数据，只将采集到的样本数据通过 Remote Write 的方式写入远程存储的 Adapter，然后将 Grafana 的数据源设为远程存储的地址，就可以在 Grafana 中查看全局视图了。这里选择 VictoriaMetrics[1] 来作为远程存储。VictoriaMetrics 是一个高性能，低成本，可扩展的时序数据库，可以用来做 Prometheus 的长期存储，分为单机版本和集群版本，均已开源。如果数据写入速率低于每秒一百万个数据点，官方建议使用单节点版本而不是集群版本。本文作为演示，仅使用单机版本，架构如图：</p>
<p><img src="https://p.tomhjx.top/FpEeERGtOWDn02ctP5yAQTMGRZXk"></p>
<h2 id="4-实践"><a href="#4-实践" class="headerlink" title="4. 实践"></a>4. 实践</h2><p>确定好了方案之后，下面来进行动手实践。</p>
<p><strong>部署 VictoriaMetrics</strong></p>
<p>首先部署一个单实例的 VictoriaMetrics，完整的 yaml 如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">pvictoriametrics</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">victoriametrics</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">blog:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">containers:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--storageDataPath=/storage</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--httpListenAddr=:8428</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--retentionPeriod=1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">victoriametrics/victoria-metrics</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8428</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8428</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8428</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">120</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2000Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2000Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/storage</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8428</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8428</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">victoriametrics</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有几个启动参数需要注意：</p>
<ul>
<li><p>  storageDataPath：数据目录的路径。VictoriaMetrics 将所有数据存储在此目录中。</p>
</li>
<li><p>  retentionPeriod：数据的保留期限（以月为单位）。旧数据将自动删除。默认期限为1个月。</p>
</li>
<li><p>  httpListenAddr：用于监听 HTTP 请求的 TCP 地址。默认情况下，它在所有网络接口上监听端口 8428。</p>
</li>
</ul>
<p><strong>给 namespace 打标签</strong></p>
<p>为了限定抓取 target 的 namespace，我们需要给 namespace 打上标签，使每个 Prometheus 实例只抓取特定 namespace 的指标。根据上文的方案，需要给 kube-system 打上标签 monitoring-role=system：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl label ns kube-system monitoring-role=system</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>给其他的 namespace 打上标签 monitoring-role=others。例如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl label ns monitoring monitoring-role=others</span><br><span class="line">$ kubectl label ns default monitoring-role=others</span><br></pre></td></tr></table></figure>

<p><strong>拆分 PrometheusRule</strong></p>
<p>告警规则需要根据监控目标拆分成两个 PrometheusRule。具体做法是将 kube-system namespace 相关的规则整合到一个 PrometheusRule 中，并修改名称和标签：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># prometheus-rules-system.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PrometheusRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-system-rules</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>剩下的放到另外一个 PrometheusRule 中，并修改名称和标签：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># prometheus-rules-others.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PrometheusRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">others</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-others-rules</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后删除默认的 PrometheusRule：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl -n monitoring delete prometheusrule prometheus-k8s-rules</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>新增两个 PrometheusRule：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl apply -f prometheus-rules-system.yaml</span><br><span class="line">$ kubectl apply -f prometheus-rules-others.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果你实在不知道如何拆分规则，或者不想拆分，想做一个伸手党，可以看这里：</p>
<ul>
<li><p>  prometheus-rules-system.yamlp[2]</p>
</li>
<li><p>  prometheus-rules-others.yaml[3]</p>
</li>
</ul>
<p><strong>拆分 Prometheus</strong></p>
<p>下一步是拆分 Prometheus 实例，根据上面的方案需要拆分成两个实例，一个用来监控 kube-system namespace，另一个用来监控其他 namespace：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># prometheus-prometheus-system.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">system</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://victoriametrics.kube-system.svc.cluster.local:8428/api/v1/write</span></span><br><span class="line">      <span class="attr">queueConfig:</span></span><br><span class="line">        <span class="attr">maxSamplesPerSend:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">2h</span> </span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-main</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.io/prometheus/prometheus:v2.17.2</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">podMonitorNamespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">monitoring-role:</span> <span class="string">system</span> </span><br><span class="line">  <span class="attr">podMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> </span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">ruleSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">system</span> </span><br><span class="line">      <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">serviceMonitorNamespaceSelector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">monitoring-role:</span> <span class="string">system</span> </span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.17.2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">others</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">others</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://victoriametrics.kube-system.svc.cluster.local:8428/api/v1/write</span></span><br><span class="line">      <span class="attr">queueConfig:</span></span><br><span class="line">        <span class="attr">maxSamplesPerSend:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">2h</span></span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-main</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.io/prometheus/prometheus:v2.17.2</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">podMonitorNamespaceSelector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">monitoring-role:</span> <span class="string">others</span> </span><br><span class="line">  <span class="attr">podMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">ruleSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">others</span> </span><br><span class="line">      <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">serviceMonitorNamespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">monitoring-role:</span> <span class="string">others</span> </span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">additionalScrapeConfigs:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">additional-scrape-configs</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">prometheus-additional.yaml</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.17.2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>需要注意的配置：</p>
<ul>
<li><p>  通过 remoteWrite 指定 remote write 写入的远程存储。</p>
</li>
<li><p>  通过 ruleSelector 指定 PrometheusRule。</p>
</li>
<li><p>  限制内存使用上限为 2Gi，可根据实际情况自行调整。</p>
</li>
<li><p>  通过 retention 指定数据在本地磁盘的保存时间为 2 小时。 因为指定了远程存储，本地不需要保存那么长时间，尽量缩短。</p>
</li>
<li><p>  Prometheus 的自定义配置可以通过 additionalScrapeConfigs 在 others 实例中指定，当然你也可以继续拆分，放到其他实例中。</p>
</li>
</ul>
<p>删除默认的 Prometheus 实例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl -n monitoring delete prometheus k8s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建新的 Prometheus 实例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl apply -f prometheus-prometheus.yaml</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看运行状况：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl -n monitoring get prometheus</span><br><span class="line">NAME     VERSION   REPLICAS   AGE</span><br><span class="line">system   v2.17.2   1          29h</span><br><span class="line">others   v2.17.2   1          29h</span><br><span class="line"></span><br><span class="line">$ kubectl -n monitoring get sts</span><br><span class="line">NAME                READY   AGE</span><br><span class="line">prometheus-system   1/1     29h</span><br><span class="line">prometheus-others   1/1     29h</span><br><span class="line">alertmanager-main   1/1     25d</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>查看每个 Prometheus 实例的内存占用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl -n monitoring top pod -l app=prometheus</span><br><span class="line">NAME                  CPU(cores)   MEMORY(bytes)</span><br><span class="line">prometheus-others-0   12m          110Mi</span><br><span class="line">prometheus-system-0   121m         1182Mi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后还要修改 Prometheus 的 Service，yaml 如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-system</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">others</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-others</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">others</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>删除默认的 Service：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl -n monitoring delete svc prometheus-k8s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建新的 Service：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ kubectl apply -f prometheus-service.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>修改 Grafana 数据源</strong></p>
<p>Prometheus 拆分成功之后，最后还要修改 Grafana 的数据源为 VictoriaMetrics 的地址，这样就可以在 Grafana 中查看全局视图，也能聚合查询。</p>
<p>打开 Grafana 的设置页面，将数据源修改为 <a href="http://victoriametrics.kube/-system.svc.cluster.local:8428/%EF%BC%9A">http://victoriametrics.kube\-system.svc.cluster.local:8428/：</a></p>
<p><img src="https://p.tomhjx.top/FnuZittzOhcG8PQYOFWo-iRILbJq"></p>
<p>点击 Explore 菜单：</p>
<p><img src="https://p.tomhjx.top/FiaxWmbDNIOKT2K27g0el4MqWygd"></p>
<p>在查询框内输入 up，然后按下 Shift+Enter 键查询：</p>
<p><img src="https://p.tomhjx.top/FovnwjjxXoEfEaACFljMHrHpF0H9"></p>
<p>可以看到查询结果中包含了所有的 namespace。</p>
<p>写这篇文章的起因是我的 k3s 集群每台节点的资源很紧张，而且监控的 target 很多，导致 Prometheus 直接把节点的内存资源消耗完了，不停地 OOM。为了充分利用我的云主机，不得不另谋他路，这才有了这篇文章。</p>
<p>相关链接：</p>
<ol>
<li><p> <a href="https://github.com/VictoriaMetrics/VictoriaMetrics">https://github.com/VictoriaMetrics/VictoriaMetrics</a></p>
</li>
<li><p> <a href="https://gist.github.com/yangchuansheng/4310ae9f41513899dc5f0176cdf804b1">https://gist.github.com/yangchuansheng/4310ae9f41513899dc5f0176cdf804b1</a></p>
</li>
<li><p> <a href="https://gist.github.com/yangchuansheng/102595fc50436cf4a2ce18744467718c">https://gist.github.com/yangchuansheng/102595fc50436cf4a2ce18744467718c</a></p>
</li>
</ol>
<p>文章来源：云原生实验室，<a href="https://mp.weixin.qq.com/s?__biz=MzU1MzY4NzQ1OA==&mid=2247486681&idx=2&sn=bb8659c07132350b7d0e50dae252f85c&scene=21#wechat_redirect">点击查看原文</a>。</p>
]]></content>
      <categories>
        <category>运维</category>
        <category>监控</category>
      </categories>
      <tags>
        <tag>云原生</tag>
        <tag>监控</tag>
        <tag>转载</tag>
        <tag>Kubernetes</tag>
        <tag>虚拟化</tag>
      </tags>
  </entry>
  <entry>
    <title>五分钟搞清楚 MVCC 机制</title>
    <url>/2020/09/27/%E4%BA%94%E5%88%86%E9%92%9F%E6%90%9E%E6%B8%85%E6%A5%9A-MVCC-%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>先看一个案例：</p>
<p>1.查看数据的事务隔离级别</p>
<p>对事务隔离级别不熟悉的同学可以参考文章 <a href="https://mp.weixin.qq.com/s/WIqoR0-l7h9SObIzmGDatQ">【MySQL （三） | 五分钟搞清楚MySQL事务隔离级别】</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT @@tx_isolation;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/2/17/168f8c4a50c54d63?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="查看数据库的事务隔离级别"></p>
<p>可见 数据库隔离级别使用的是MySQL默认的RR级别。</p>
<p><strong>REPEATABLE READ</strong> 意味着：</p>
<ul>
<li>  同一个事务中多次执行同一个select,读取到的数据没有发生改变；</li>
<li>  此时：允许幻读，但不允许不可重复读和脏读，所以RR隔离级别要求解决不可重复读；</li>
</ul>
<p>2.在不同会话中执行以下SQL</p>
<p>补充一下建表语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table `test_zq` (</span><br><span class="line">	`id` int (11),</span><br><span class="line">	`test_id` int (11)</span><br><span class="line">);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;1&#x27;,&#x27;18&#x27;);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;4&#x27;,&#x27;8&#x27;);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;7&#x27;,&#x27;4&#x27;);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;10&#x27;,&#x27;1234&#x27;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>用户1：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">-- 更新 id 为 1 的数据</span><br><span class="line">UPDATE test_zq SET test_id = 20 WHERE id = 1;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>用户2:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">--查询 id 为 1 的数据</span><br><span class="line">SELECT * FROM test_zq WHERE id = 1;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行结果大致如下：</p>
<p>![执行结果](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="256"></svg>)</p>
<p>根据事务隔离级别来看，我们理论上对获得 X 锁（关于锁的概念可以参考 <a href="http://mp.weixin.qq.com/s?__biz=MzI1Mzg4OTMxNQ==&mid=100000550&idx=1&sn=8a5cdff008fc1eed7b5c623c1bdf4ed1&chksm=69ccdd6a5ebb547c7b7baf6be78763fc5065e0a58de202f3e25d8d8ed56e6d1c1146332cfec1#rd">【MySQL （四） | 五分钟搞清楚InnoDB锁机制】</a>）的数据行是不能再被获取读锁而访问的，但是事实上我们依然访问到了这个数据！</p>
<p><strong>通过结果说明</strong>：我们可以在一个事务未进行 commit/rollback操作之前，另一个事务仍然可以读取到数据库中的数据，只不过是读取到的是其他事务未改变之前的数据。此处是利用了MVCC多数据做了多版本处理，读取的数据来源于快照。</p>
<p>3.同理，在不同会话中执行以下SQL</p>
<p>用户1：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">SELECT * FROM test_zq WHERE id = 1;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>用户2：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">update test_zq set test_id = 22 where id = 1;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行完之后再回到用户1进行一次数据查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM test_zq WHERE id = 1;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/2/17/168f8c6166f8fecf?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="执行结果2"></p>
<p>执行结果和上一步的执行结果一样，只不过区别在于2步骤中是先 update 后 select , 3 步骤是先 select 后 update.</p>
<p>虽然两者执行结果是一致的，但是我们要思考两个问题：</p>
<ul>
<li>  他们的底层实现是一样的吗？</li>
<li>  他们的实现和MVCC有什么关系呢？</li>
</ul>
<p>接下来我们便开始了解一下 MVCC 机制</p>
<h3 id="什么是MVCC"><a href="#什么是MVCC" class="headerlink" title="什么是MVCC"></a>什么是MVCC</h3><blockquote>
<p>MVCC，Multi-Version Concurrency Control，多版本并发控制。MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问；在编程语言中实现事务内存。</p>
</blockquote>
<p>如果有人从数据库中读数据的同时，有另外的人写入数据，有可能读数据的人会看到『半写』或者不一致的数据。有很多种方法来解决这个问题，叫做并发控制方法。最简单的方法，通过加锁，让所有的读者等待写者工作完成，但是这样效率会很差。MVCC 使用了一种不同的手段，每个连接到数据库的读者，<strong>在某个瞬间看到的是数据库的一个快照</strong>，写者写操作造成的变化在写操作完成之前（或者数据库事务提交之前）对于其他的读者来说是不可见的。</p>
<p>当一个 MVCC 数据库需要更一个一条数据记录的时候，它不会直接用新数据覆盖旧数据，而是将旧数据标记为过时（obsolete）并在别处增加新版本的数据。这样就会有存储多个版本的数据，但是只有一个是最新的。这种方式允许读者读取在他读之前已经存在的数据，即使这些在读的过程中半路被别人修改、删除了，也对先前正在读的用户没有影响。**这种多版本的方式避免了填充删除操作在内存和磁盘存储结构造成的空洞的开销，但是需要系统周期性整理（sweep through）以真实删除老的、过时的数据。**对于面向文档的数据库（Document-oriented database，也即半结构化数据库）来说，这种方式允许系统将整个文档写到磁盘的一块连续区域上，当需要更新的时候，直接重写一个版本，而不是对文档的某些比特位、分片切除，或者维护一个链式的、非连续的数据库结构。</p>
<p>MVCC 提供了时点（point in time）一致性视图。MVCC 并发控制下的读事务一般使用<strong>时间戳或者事务 ID</strong>去标记当前读的数据库的状态（版本），读取这个版本的数据。读、写事务相互隔离，不需要加锁。<strong>读写并存的时候，写操作会根据目前数据库的状态，创建一个新版本，并发的读则依旧访问旧版本的数据。</strong></p>
<p>一句话总结就是：</p>
<blockquote>
<p>MVCC(<code>Multiversion concurrency control</code>) 就是 同一份数据临时保留多版本的一种方式，进而实现并发控制</p>
</blockquote>
<p>哪么此处需要注意的点就是：</p>
<ul>
<li>  在读写并发的过程中如何实现多版本？</li>
<li>  在读写并发之后，如何实现旧版本的删除（毕竟很多时候只需要一份最新版的数据就够了）？</li>
</ul>
<p>下面介绍一下MySQL中对于 MVCC 的逻辑实现</p>
<h3 id="MVCC逻辑流程-插入"><a href="#MVCC逻辑流程-插入" class="headerlink" title="MVCC逻辑流程-插入"></a>MVCC逻辑流程-插入</h3><p>在MySQL中建表时，每个表都会有三列隐藏记录，其中和MVCC有关系的有两列</p>
<ul>
<li>  数据行的版本号 （DB_TRX_ID）</li>
<li>  删除版本号 (DB_ROLL_PT)</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
</table>
<p>在插入数据的时候，假设系统的全局事务ID从1开始，以下SQL语句执行分析参考注释信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;-- 获取到全局事务ID</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;5&#x27;,&#x27;68&#x27;);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;6&#x27;,&#x27;78&#x27;);</span><br><span class="line">commit;-- 提交事务</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>当执行完以上SQL语句之后，表格中的内容会变成：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>68</td>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>6</td>
<td>78</td>
<td>1</td>
<td>NULL</td>
</tr>
</tbody></table>
<p>可以看到，插入的过程中会把全局事务ID记录到列 DB_TRX_ID 中去</p>
<h3 id="MVCC逻辑流程-删除"><a href="#MVCC逻辑流程-删除" class="headerlink" title="MVCC逻辑流程-删除"></a>MVCC逻辑流程-删除</h3><p>对上述表格做删除逻辑，执行以下SQL语句（假设获取到的事务逻辑ID为 3）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin；--获得全局事务ID = 3</span><br><span class="line">delete test_zq where id = 6;</span><br><span class="line">commit;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行完上述SQL之后数据并没有被真正删除，而是对删除版本号做改变，如下所示：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>68</td>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>6</td>
<td>78</td>
<td>1</td>
<td>3</td>
</tr>
</tbody></table>
<h3 id="MVCC逻辑流程-修改"><a href="#MVCC逻辑流程-修改" class="headerlink" title="MVCC逻辑流程-修改"></a>MVCC逻辑流程-修改</h3><p>修改逻辑和删除逻辑有点相似，修改数据的时候 会先复制一条当前记录行数据，同事标记这条数据的数据行版本号为当前是事务版本号，最后把原来的数据行的删除版本号标记为当前是事务。</p>
<p>执行以下SQL语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;-- 获取全局系统事务ID 假设为 10</span><br><span class="line">update test_zq set test_id = 22 where id = 5;</span><br><span class="line">commit;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行后表格实际数据应该是：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>68</td>
<td>1</td>
<td>10</td>
</tr>
<tr>
<td>6</td>
<td>78</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>5</td>
<td>22</td>
<td>10</td>
<td>NULL</td>
</tr>
</tbody></table>
<h3 id="MVCC逻辑流程-查询"><a href="#MVCC逻辑流程-查询" class="headerlink" title="MVCC逻辑流程-查询"></a>MVCC逻辑流程-查询</h3><p>此时，数据查询规则如下：</p>
<ul>
<li><p>查找<strong>数据行版本号早于当前事务版本号</strong>的数据行记录</p>
<p>  也就是说，数据行的版本号要小于或等于当前是事务的系统版本号，这样也就确保了读取到的数据是当前事务开始前已经存在的数据，或者是自身事务改变过的数据</p>
</li>
<li><p>查找<strong>删除版本号</strong>要么为NULL，要么<strong>大于当前事务版本号</strong>的记录</p>
<p>  这样确保查询出来的数据行记录在事务开启之前没有被删除</p>
</li>
</ul>
<p>根据上述规则，我们继续以上张表格为例，对此做查询操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;-- 假设拿到的系统事务ID为 12</span><br><span class="line">select * from test_zq;</span><br><span class="line">commit;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>执行结果应该是：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>6</td>
<td>22</td>
<td>10</td>
<td>NULL</td>
</tr>
</tbody></table>
<h3 id="MySQL-中-MVCC-版本控制案例"><a href="#MySQL-中-MVCC-版本控制案例" class="headerlink" title="MySQL 中 MVCC 版本控制案例"></a>MySQL 中 MVCC 版本控制案例</h3><p>回到文章刚开始的哪个例子，我们使用 MVCC 机制分析一遍</p>
<p>为了方便描述，对SQL语句做如下标记：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;--假设当前获取到的事务 ID 为 2				 ----1</span><br><span class="line">select * from test_zq;						    ----2</span><br><span class="line">commit;</span><br><span class="line"></span><br><span class="line">begin;--假设当前获取到的事务 ID 为 3				 ----3</span><br><span class="line">UPDATE test_zq SET test_id = 20 WHERE id = 1;	----4</span><br><span class="line">commit;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>对表中数据做初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;1&#x27;,&#x27;18&#x27;);</span><br><span class="line">insert into `test_zq` (`id`, `test_id`) values(&#x27;4&#x27;,&#x27;8&#x27;);</span><br><span class="line">commit;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>表中的原始数据为：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
<td>1</td>
<td>NULL</td>
</tr>
</tbody></table>
<h4 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h4><p><strong>执行顺序为</strong> <code>1 2 3 4 2</code></p>
<p><code>1 2</code> 步骤执行结果为：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
</tr>
</tbody></table>
<p><code>3 4</code> 步骤执行结果为：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>1</td>
<td>20</td>
<td>3</td>
<td>NULL</td>
</tr>
</tbody></table>
<p><code>2</code>执行后的结果为：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
</tr>
</tbody></table>
<p>上述结果符合预期，接下来看案例2</p>
<h4 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h4><p><strong>执行顺序为</strong><code>3 4 1 2</code></p>
<p><code>3 4</code> 步骤执行后结果为：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
<th>DB_TRX_ID</th>
<th>DB_ROLL_PT</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>1</td>
<td>20</td>
<td>3</td>
<td>NULL</td>
</tr>
</tbody></table>
<p><code>1 2</code> 步骤执行后结果为：</p>
<p>假设此时的事务ID为 <code>txid = 4</code></p>
<p>则查询结果是 ：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>test_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>20</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
</tr>
</tbody></table>
<p>显然，结果应该是不对的，但是我们在文章开头也是按照这样的顺序执行的，但是MySQL的返回结果没有任何问题，可是这里根据MVCC机制来分析却出现了这样的状况，所以问题出在哪里？</p>
<p>我们大概可以猜测到：</p>
<blockquote>
<p>此处问题不是出在 MVCC 机制，MySQL解决不可重复读和脏读并不是单纯利用 MVCC 机制来实现的。</p>
</blockquote>
<p><a href="https://juejin.im/post/6844903778026536968">原文</a></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 ffmpeg 实现 MP4 与 GIF 的互转</title>
    <url>/2020/03/01/%E4%BD%BF%E7%94%A8-ffmpeg-%E5%AE%9E%E7%8E%B0-MP4-%E4%B8%8E-GIF-%E7%9A%84%E4%BA%92%E8%BD%AC/</url>
    <content><![CDATA[<p>在 Mac OSX 上使用 <a href="http://brew.sh/">Homebrew</a> 安装 <a href="https://www.ffmpeg.org/">ffmpeg</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">brew install ffmpeg</span><br><span class="line"></span><br><span class="line">brew install ffmpeg --with-fdk-aac --with-ffplay --with-freetype --with-libass --with-libquvi --with-libvorbis --with-libvpx --with-opus --with-x265</span><br><span class="line"></span><br><span class="line">brew update &amp;&amp; brew upgrade ffmpeg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="将视频-MP4-转化为-GIF"><a href="#将视频-MP4-转化为-GIF" class="headerlink" title="将视频 MP4 转化为 GIF"></a>将视频 MP4 转化为 GIF<a href="#%E5%B0%86%E8%A7%86%E9%A2%91-mp4-%E8%BD%AC%E5%8C%96%E4%B8%BA-gif"></a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i small.mp4 small.gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="转化视频中的一部分为-GIF"><a href="#转化视频中的一部分为-GIF" class="headerlink" title="转化视频中的一部分为 GIF"></a>转化视频中的一部分为 GIF<a href="#%E8%BD%AC%E5%8C%96%E8%A7%86%E9%A2%91%E4%B8%AD%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%E4%B8%BA-gif"></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -t 3 -ss 00:00:02 -i small.webm small-clip.gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从视频中第二秒开始，截取时长为3秒的片段转化为 gif</p>
<h3 id="转化高质量-GIF"><a href="#转化高质量-GIF" class="headerlink" title="转化高质量 GIF"></a>转化高质量 GIF<a href="#%E8%BD%AC%E5%8C%96%E9%AB%98%E8%B4%A8%E9%87%8F-gif"></a></h3><p>默认转化是中等质量模式，若要转化出高质量的 gif，可以修改比特率</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i small.mp4 -b 2048k small.gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="视频属性调整"><a href="#视频属性调整" class="headerlink" title="视频属性调整"></a>视频属性调整<a href="#%E8%A7%86%E9%A2%91%E5%B1%9E%E6%80%A7%E8%B0%83%E6%95%B4"></a></h2><h3 id="缩放视频尺寸"><a href="#缩放视频尺寸" class="headerlink" title="缩放视频尺寸"></a>缩放视频尺寸<a href="#%E7%BC%A9%E6%94%BE%E8%A7%86%E9%A2%91%E5%B0%BA%E5%AF%B8"></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i big.mov -vf scale=360:-1  small.mov</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意 <code>sacle</code> 值必须是偶数，这里的 <code>-1</code> 表示保持长宽比，根据宽度值自适应高度。</p>
<p>如果要求压缩出来的视频尺寸长宽都保持为偶数，可以使用 <code>-2</code></p>
<h3 id="加倍速播放视频"><a href="#加倍速播放视频" class="headerlink" title="加倍速播放视频"></a>加倍速播放视频<a href="#%E5%8A%A0%E5%80%8D%E9%80%9F%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91"></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mov -filter:v &quot;setpts=0.5*PTS&quot; output.mov</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义帧率 16fps:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mov -r 16 -filter:v &quot;setpts=0.125*PTS&quot; -an output.mov</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="慢倍速播放视频"><a href="#慢倍速播放视频" class="headerlink" title="慢倍速播放视频"></a>慢倍速播放视频<a href="#%E6%85%A2%E5%80%8D%E9%80%9F%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91"></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mov -filter:v &quot;setpts=2.0*PTS&quot; output.mov</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="静音视频（移除视频中的音频）"><a href="#静音视频（移除视频中的音频）" class="headerlink" title="静音视频（移除视频中的音频）"></a>静音视频（移除视频中的音频）<a href="#%E9%9D%99%E9%9F%B3%E8%A7%86%E9%A2%91%E7%A7%BB%E9%99%A4%E8%A7%86%E9%A2%91%E4%B8%AD%E7%9A%84%E9%9F%B3%E9%A2%91"></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mov -an mute-output.mov</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>-an</code> 就是禁止音频输出</p>
<h2 id="将-GIF-转化为-MP4"><a href="#将-GIF-转化为-MP4" class="headerlink" title="将 GIF 转化为 MP4"></a>将 GIF 转化为 MP4<a href="#%E5%B0%86-gif-%E8%BD%AC%E5%8C%96%E4%B8%BA-mp4"></a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -f gif -i animation.gif animation.mp4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以将 gif 转为其他视频格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -f gif -i animation.gif animation.mpeg</span><br><span class="line"></span><br><span class="line">ffmpeg -f gif -i animation.gif animation.webm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="获取-GIF-的第一帧图片"><a href="#获取-GIF-的第一帧图片" class="headerlink" title="获取 GIF 的第一帧图片"></a>获取 GIF 的第一帧图片<a href="#%E8%8E%B7%E5%8F%96-gif-%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B8%A7%E5%9B%BE%E7%89%87"></a></h2><p>使用 <a href="http://www.imagemagick.org/">ImageMagick</a> 可以方便第提取 gif 图片的第 N 帧图像。</p>
<p>安装 ImageMagick</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">brew install imagemagick</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>提取第一帧</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">convert &#x27;animation.gif[0]&#x27; animation-first-frame.gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过 <code>[0]</code> 就可以提取出 gif 的第一帧图像。</p>
<h2 id="GIF-转出来的-MP4-播放不了？"><a href="#GIF-转出来的-MP4-播放不了？" class="headerlink" title="GIF 转出来的 MP4 播放不了？"></a>GIF 转出来的 MP4 播放不了？<a href="#gif-%E8%BD%AC%E5%87%BA%E6%9D%A5%E7%9A%84-mp4-%E6%92%AD%E6%94%BE%E4%B8%8D%E4%BA%86"></a></h2><p>有些 GIF 转化出来的 MP4 不能被 Mac QuickTime Player.app 播放，需要添加 <code>pixel formal</code> 参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.gif -vf scale=420:-2,format=yuv420p out.mp4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 <code>yunv420p</code> 需要保证长宽为偶数，这里同时使用了 <code>scale=420:-2</code> 。</p>
<p><a href="https://trac.ffmpeg.org/wiki/Encode/H.264#Encodingfordumbplayers">wiki 解释</a>： QuickTime Player 对 H.264 视频只支持 YUV 色域 4:2:0 方式的二次插值算法。</p>
<p>参考资料</p>
<ul>
<li>  <a href="https://trac.ffmpeg.org/wiki/CompilationGuide/MacOSX">FFmpeg CompilationGuide/MacOSX</a></li>
<li>  <a href="http://davidwalsh.name/convert-video-gif">Convert Video to GIF or GIF to Video</a></li>
<li>  <a href="http://davidwalsh.name/first-frame-animated-gif">Get the First Frame of an Animated GIF with ImageMagick</a></li>
<li>  <a href="http://davidwalsh.name/create-image-preview-video">Create an Image Preview from a Video</a></li>
<li>  <a href="https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video">How to speed up / slow down a video</a></li>
<li>  <a href="http://siwei.me/blog/posts/ffmpeg-useful-commands">ffmpeg useful commands (FFMPEG 命令大全）</a></li>
<li>  <a href="http://siwei.me/blog/posts/ffmpeg-useful-commands">ffmpeg 文档</a></li>
</ul>
]]></content>
      <categories>
        <category>开发</category>
        <category>多媒体</category>
        <category>ffmpeg</category>
      </categories>
      <tags>
        <tag>ffmpeg</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>使用GitHub和Hexo搭建免费静态Blog</title>
    <url>/2016/01/03/%E4%BD%BF%E7%94%A8GitHub%E5%92%8CHexo%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E9%9D%99%E6%80%81Blog/</url>
    <content><![CDATA[<h3 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h3><p><a href="http://wsgzao.github.io/post/hexo-guide/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io">http://wsgzao.github.io/post/hexo-guide/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>
<h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><p><a href="https://hexo.io/zh-cn/api/index.html">https://hexo.io/zh-cn/api/index.html</a></p>
<p><a href="http://segmentfault.com/a/1190000002632530">http://segmentfault.com/a/1190000002632530</a></p>
<h3 id="git-pages"><a href="#git-pages" class="headerlink" title="git pages"></a>git pages</h3><p><a href="http://www.cnblogs.com/purediy/archive/2013/03/07/2948892.html">http://www.cnblogs.com/purediy/archive/2013/03/07/2948892.html</a></p>
<h3 id="推荐主题"><a href="#推荐主题" class="headerlink" title="推荐主题"></a>推荐主题</h3><p><a href="http://theme-next.iissnan.com/">http://theme-next.iissnan.com/</a></p>
<h3 id="配置搜索插件"><a href="#配置搜索插件" class="headerlink" title="配置搜索插件"></a>配置搜索插件</h3><p><a href="http://www.jianshu.com/p/85cd68408f81">http://www.jianshu.com/p/85cd68408f81</a></p>
<h3 id="第三方搜索引擎"><a href="#第三方搜索引擎" class="headerlink" title="第三方搜索引擎"></a>第三方搜索引擎</h3><p><a href="https://swiftype.com/">https://swiftype.com/</a></p>
<p><a href="http://tinysou.com/">http://tinysou.com/</a></p>
<h3 id="第三方评论系统"><a href="#第三方评论系统" class="headerlink" title="第三方评论系统"></a>第三方评论系统</h3><p><a href="http://duoshuo.com/">http://duoshuo.com/</a></p>
]]></content>
      <categories>
        <category>杂文</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>图解kubernetes中Pod生命之初的坎坷历程</title>
    <url>/2020/02/29/%E5%9B%BE%E8%A7%A3kubernetes%E4%B8%ADPod%E7%94%9F%E5%91%BD%E4%B9%8B%E5%88%9D%E7%9A%84%E5%9D%8E%E5%9D%B7%E5%8E%86%E7%A8%8B-1/</url>
    <content><![CDATA[<p>kubernetes中的容器创建无疑是个复杂的过程，涉及内部各种组件的统一协作，还有对接外部的CRI运行时，本文尝试初探一下容器创建流程中的各种细节，了解其各种组件协作流程，从而在后续出现问题的时候，也好能大概有点排查方向</p>
<h1 id="1-基础筑基"><a href="#1-基础筑基" class="headerlink" title="1. 基础筑基"></a>1. 基础筑基</h1><h2 id="1-1-容器管理线程模型"><a href="#1-1-容器管理线程模型" class="headerlink" title="1.1 容器管理线程模型"></a>1.1 容器管理线程模型</h2><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc80311c666?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">kubelet中的线程模型属于master/worker模型，通过单master来监听各种事件源，并为每个Pod创建一个goroutine来进行Pod业务逻辑的处理，master和worker之间通过一个状态管道来进行通信</p>
<h2 id="1-2-基于事件驱动的状态最终一致性"><a href="#1-2-基于事件驱动的状态最终一致性" class="headerlink" title="1.2 基于事件驱动的状态最终一致性"></a>1.2 基于事件驱动的状态最终一致性</h2><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc83c2fddd0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">在通过yaml创建Pod之后，kubernetes会根据当前的事件和当前的Pod状态，来不断进行调整，从而达到最终目标状态的一致性</p>
<h2 id="1-3-组件协作流程"><a href="#1-3-组件协作流程" class="headerlink" title="1.3 组件协作流程"></a>1.3 组件协作流程</h2><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc86353db9b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">kubelet的结构体声明就高达300多行代码，可见其复杂程度，但是我们按照容器创建这个流程，我们去观察其核心流程，其实主要可以概括为三部分：kubelet、containerRuntime、CRI容器运行时</p>
<h1 id="2-Kubelet创建容器流程"><a href="#2-Kubelet创建容器流程" class="headerlink" title="2.Kubelet创建容器流程"></a>2.Kubelet创建容器流程</h1><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc8860ff0d2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png"></p>
<h2 id="2-1-获取Pod进行准入检查"><a href="#2-1-获取Pod进行准入检查" class="headerlink" title="2.1 获取Pod进行准入检查"></a>2.1 获取Pod进行准入检查</h2><p>kubelet的事件源主要包含两个部分：静态Pod和Apiserver，我们这里只考虑普通的Pod，则会直接将Pod加入到PodManager来进行管理，并且进行准入检查</p>
<p>准入检查主要包含两个关键的控制器：驱逐管理与预选检查驱逐管理主要是根据当前的资源压力，检测对应的Pod是否容忍当前的资源压力；预选检查则是根据当前活跃的容器和当前节点的信息来检查是否满足当前Pod的基础运行环境，例如亲和性检查，同时如果当前的Pod的优先级特别高或者是静态Pod，则会尝试为其进行资源抢占，会按照QOS等级逐级来进行抢占从而满足其运行环境</p>
<h2 id="2-2-创建事件管道与容器管理主线程"><a href="#2-2-创建事件管道与容器管理主线程" class="headerlink" title="2.2 创建事件管道与容器管理主线程"></a>2.2 创建事件管道与容器管理主线程</h2><p>kubelet接收到一个新创建的Pod首先会为其创建一个事件管道，并且启动一个容器管理的主线程消费管道里面的事件，并且会基于最后同步时间来等待当前kubelet中最新发生的事件(从本地的podCache中获取)，如果是一个新建的Pod，则主要是通过PLEG中更新时间操作，广播的默认空状态来作为最新的状态</p>
<h2 id="2-3-同步最新状态"><a href="#2-3-同步最新状态" class="headerlink" title="2.3 同步最新状态"></a>2.3 同步最新状态</h2><p>当从本地的podCache中获取到最新的状态信息和从事件源获取的Pod信息后，会结合当前当前statusManager和probeManager里面的Pod里面的容器状态来更新，从而获取当前感知到的最新的Pod状态</p>
<h2 id="2-4-准入控制检查"><a href="#2-4-准入控制检查" class="headerlink" title="2.4 准入控制检查"></a>2.4 准入控制检查</h2><p>之前的准入检查是Pod运行的资源硬性限制的检查，而这里的准入检查则是软状态即容器运行时和版本的一些软件运行环境检查，如果这里检查失败，则会讲对应的容器状态设置为Blocked</p>
<h2 id="2-5-更新容器状态"><a href="#2-5-更新容器状态" class="headerlink" title="2.5 更新容器状态"></a>2.5 更新容器状态</h2><p>在通过准入检查之后，会调用statusManager来进行POd最新状态的同步，此处可能会同步给apiserver</p>
<h2 id="2-6-Cgroup配置"><a href="#2-6-Cgroup配置" class="headerlink" title="2.6 Cgroup配置"></a>2.6 Cgroup配置</h2><p>在更新完成状态之后会启动一个PodCOntainerManager主要作用则是为对应的Pod根据其QOS等级来进行Cgroup配置的更新</p>
<h2 id="2-7Pod基础运行环境准备"><a href="#2-7Pod基础运行环境准备" class="headerlink" title="2.7Pod基础运行环境准备"></a>2.7Pod基础运行环境准备</h2><p>接下来kubelet会为Pod的创建准备基础的环境，包括Pod数据目录的创建、镜像秘钥的获取、等待volume挂载完成等操作创建Pod的数据目录主要是创建 Pod运行所需要的Pod、插件、Volume目录，并且会通过Pod配置的镜像拉取秘钥生成秘钥信息，到此kubelet创建容器的工作就已经基本完成</p>
<h1 id="3-ContainerRuntime"><a href="#3-ContainerRuntime" class="headerlink" title="3.ContainerRuntime"></a>3.ContainerRuntime</h1><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc8ad527317?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">前面我们提到过针对Pod的操作，最终都是基于事件和状态的同步而完成，在containerRUntime并不会区分对应的事件是创建还是更新操作，只是根据当前的Pod的信息与目标状态来进行对比，从而构建出对应的操作，达到目标状态</p>
<h2 id="3-1-计算Pod容器变更"><a href="#3-1-计算Pod容器变更" class="headerlink" title="3.1 计算Pod容器变更"></a>3.1 计算Pod容器变更</h2><p>计算容器变更主要包括：Pod的sandbox是否变更、短声明周期容器、初始化容器是否完成、业务容器是否已经完成，相应的我们会得到一个几个对应的容器列表：需要被kill掉的容器列表、需要启动的容器列表，注意如果我们的初始化容器未完成，则不会进行将要运行的业务容器加入到需要启动的容器列表，可以看到这个地方是两个阶段</p>
<h2 id="3-2-初始化失败尝试终止"><a href="#3-2-初始化失败尝试终止" class="headerlink" title="3.2 初始化失败尝试终止"></a>3.2 初始化失败尝试终止</h2><p>如果之前检测到之前的初始化容器失败，则会检查当前Pod的所有容器和sandbox关联的容器如果有在运行的容器，会全部进行Kill操作，并且等待操作完成</p>
<h2 id="3-3-未知状态容器补偿"><a href="#3-3-未知状态容器补偿" class="headerlink" title="3.3 未知状态容器补偿"></a>3.3 未知状态容器补偿</h2><p>当一些Pod的容器已经运行，但是其状态仍然是Unknow的时候，在这个地方会进行统一的处理，全部kill掉，从而为接下来的重新启动做清理操作，此处和3.2只会进行一个分支，但核心的目标都是清理那些运行失败或者无法获取状态的容器</p>
<h2 id="3-4-创建容器沙箱"><a href="#3-4-创建容器沙箱" class="headerlink" title="3.4 创建容器沙箱"></a>3.4 创建容器沙箱</h2><p>在启动Pod的容器之前，首先会为其创建一个sandbox容器，当前Pod的所有容器都和Pod对应的sandbox共享同一个namespace从而共享一个namespace里面的资源，创建Sandbox比较复杂，后续会继续介绍</p>
<h2 id="3-5-启动Pod相关容器"><a href="#3-5-启动Pod相关容器" class="headerlink" title="3.5 启动Pod相关容器"></a>3.5 启动Pod相关容器</h2><p>Pod的容器目前分为三大类：短生命周期容器、初始化容器、业务容器，启动顺序也是从左到右依次进行,如果对于的容器创建失败，则会通过backoff机制来延缓容器的创建，这里我们顺便介绍下containerRuntime启动容器的流程</p>
<h3 id="3-5-1-检查容器镜像是否拉取"><a href="#3-5-1-检查容器镜像是否拉取" class="headerlink" title="3.5.1 检查容器镜像是否拉取"></a>3.5.1 检查容器镜像是否拉取</h3><p>镜像的拉取首先会进行对应容器镜像的拼接，然后将之前获取的拉取的秘钥信息和镜像信息，一起交给CRI运行时来进行底层容器镜像的拉取，当然这里也会各种backoff机制，从而避免频繁拉取失败影响kubelet的性能</p>
<h3 id="3-5-2-创建容器配置"><a href="#3-5-2-创建容器配置" class="headerlink" title="3.5.2 创建容器配置"></a>3.5.2 创建容器配置</h3><p>创建容器配置主要是为了容器的运行创建对应的配置数据，主要包括：Pod的主机名、域名、挂载的volume、configMap、secret、环境变量、挂载的设备信息、要挂载的目录信息、端口映射信息、根据环境生成执行的命令、日志目录等信息</p>
<h3 id="3-5-3-调用runtimeService完成容器的创建"><a href="#3-5-3-调用runtimeService完成容器的创建" class="headerlink" title="3.5.3 调用runtimeService完成容器的创建"></a>3.5.3 调用runtimeService完成容器的创建</h3><p>调用runtimeService传递容器的配置信息，调用CRI，并且最终调用容器的创建接口完成容器的状态</p>
<h3 id="3-5-4-调用runtimeService启动容器"><a href="#3-5-4-调用runtimeService启动容器" class="headerlink" title="3.5.4 调用runtimeService启动容器"></a>3.5.4 调用runtimeService启动容器</h3><p>通过之前创建容器返回的容器ID，来进行对应的容器的启动，并且会为容器创建对应的日志目录</p>
<h3 id="3-5-5-执行容器的回调钩子"><a href="#3-5-5-执行容器的回调钩子" class="headerlink" title="3.5.5 执行容器的回调钩子"></a>3.5.5 执行容器的回调钩子</h3><p>如果容器配置了PostStart钩子，则会在此处进行对应钩子的执行，如果钩子的类型是Exec类则会调用CNI的EXec接口完成在容器内的执行</p>
<h1 id="4-运行沙箱容器"><a href="#4-运行沙箱容器" class="headerlink" title="4. 运行沙箱容器"></a>4. 运行沙箱容器</h1><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc8d5b7ff92?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png"></p>
<h2 id="4-1-拉取sandbox镜像"><a href="#4-1-拉取sandbox镜像" class="headerlink" title="4.1 拉取sandbox镜像"></a>4.1 拉取sandbox镜像</h2><p>首先会拉取sandbox镜像</p>
<h2 id="4-2-创建沙箱容器"><a href="#4-2-创建沙箱容器" class="headerlink" title="4.2 创建沙箱容器"></a>4.2 创建沙箱容器</h2><h3 id="4-2-1-应用SecurityContext"><a href="#4-2-1-应用SecurityContext" class="headerlink" title="4.2.1 应用SecurityContext"></a>4.2.1 应用SecurityContext</h3><p>在创建容器之前会先根据SecurityContext里面的配资信息，来进行容器SecurityContext的配置，主要包括特权等级、只读目录、运行账户组等信息</p>
<h3 id="4-2-其余基础信息"><a href="#4-2-其余基础信息" class="headerlink" title="4.2 其余基础信息"></a>4.2 其余基础信息</h3><p>除了应用SecurityContext还会进行断开、OOMScoreAdj、Cgroup驱动等信息的映射</p>
<h3 id="4-3-创建容器"><a href="#4-3-创建容器" class="headerlink" title="4.3 创建容器"></a>4.3 创建容器</h3><p>根据上面的各种配置信息来进行容器的创建</p>
<h2 id="4-3-创建checkpoint"><a href="#4-3-创建checkpoint" class="headerlink" title="4.3 创建checkpoint"></a>4.3 创建checkpoint</h2><p>checkpoint主要是将当前sandbox的配置信息进行序列化，并且存储其当前的快照信息</p>
<h2 id="4-4-启动sandbox容器"><a href="#4-4-启动sandbox容器" class="headerlink" title="4.4 启动sandbox容器"></a>4.4 启动sandbox容器</h2><p>启动sandbox容器则会直接调用StartContainer同时传入之前创建容器返回的ID完成容器的启动，并且此时会重写覆盖容器的dns配置文件</p>
<h2 id="4-5-容器网络设置"><a href="#4-5-容器网络设置" class="headerlink" title="4.5 容器网络设置"></a>4.5 容器网络设置</h2><p>容器的网络配置主要是调用CNI插件来完成容器网络的配置，这里就先不展开了</p>
<h1 id="5-Pod容器启动总结"><a href="#5-Pod容器启动总结" class="headerlink" title="5. Pod容器启动总结"></a>5. Pod容器启动总结</h1><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc901917b9c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">kubelet是容器管理的核心大管家，其负责各种准入控制、状态管理、探测管理、volume管理、QOS管理、CSI对接的统一调度，并且为Runtime运行时准备基础的数据和并反馈Pod当前的最新状态 <img src="https://user-gold-cdn.xitu.io/2020/2/28/17089dc974176f91?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image.png" title="image.png">Runtime层则将kubelet组装的数据，按照CRI运行时的目标配置和kubelet管理的资源配置信息来进行资源的重组，并且根据Pod的容器的状态来决策容器的启停、创建等操作，并完成容器的基础配置环境的构建，并最终调用CRI完成容器的创建，而CRI运行时，则会讲传递过来的各种数据进行进一步的组合，并应用到主机和对应的namespace资源限制，并根据自己的容器服务组织数据，调用容器服务完成容器的最终创建</p>
]]></content>
      <categories>
        <category>运维</category>
        <category>虚拟化</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>在linux上为什么内存使用率过高?</title>
    <url>/2020/07/04/%E5%9C%A8linux%E4%B8%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98/</url>
    <content><![CDATA[<h2 id="常用排障命令"><a href="#常用排障命令" class="headerlink" title="常用排障命令"></a>常用排障命令</h2><ul>
<li>使用ps命令找出占用内存资源最多的20个进程（数量可以任意设置）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps aux | head -1;ps aux |grep -v PID |sort -rn -k +4 | head -20</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>使用 top , 按命令分组，查找内存消耗最大的前20<a href="https://www.2daygeek.com/understanding-linux-top-command-output-usage/">在这里可以了解到top的输出方式</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">top -b -n 1|tail -n +8| awk <span class="string">&#x27;&#123; sum[$12]+=($6-$7) &#125; END &#123; for(i in sum) &#123;print i,sum[i]/1024&#125;&#125;&#x27;</span>|sort -rn -k +2|head -20</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://juejin.im/post/5e3c13dbf265da576f52f706">查看 Linux 系统中进程和用户的内存使用情况</a></li>
<li><a href="https://segmentfault.com/a/1190000004147558">linux下查询进程占用的内存方法总结</a></li>
</ul>
]]></content>
      <categories>
        <category>系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>内存</tag>
        <tag>排障</tag>
      </tags>
  </entry>
  <entry>
    <title>在linux如何使用rsync做文件同步</title>
    <url>/2016/10/16/%E5%9C%A8linux%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8rsync%E5%81%9A%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5/</url>
    <content><![CDATA[<p>###配置</p>
<p><a href="http://blog.csdn.net/chen978616649/article/details/42581843">http://blog.csdn.net/chen978616649/article/details/42581843</a></p>
<p>###使用</p>
<p>远程将10.1.0.37上的文件同步到本地</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rsync -aq --max-size=100m  10.1.0.37::logs/server/livelocation/2016-10-12.log /home/www/livelocation_10.1.0.37/2016-10-12.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>###参考资料</p>
<p><a href="http://man.linuxde.net/rsync">http://man.linuxde.net/rsync</a></p>
]]></content>
      <categories>
        <category>系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>在linux怎样查看挂载情况</title>
    <url>/2016/06/01/%E5%9C%A8linux%E6%80%8E%E6%A0%B7%E6%9F%A5%E7%9C%8B%E6%8C%82%E8%BD%BD%E6%83%85%E5%86%B5/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">cat /etc/mtab</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>如何着手分析一个行业?</title>
    <url>/2021/06/20/%E5%A6%82%E4%BD%95%E7%9D%80%E6%89%8B%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AA%E8%A1%8C%E4%B8%9A/</url>
    <content><![CDATA[<p>这里分享一套教科书式的分析方法论，可以帮助快速了解一个行业，并记住这个行业的核心内容。</p>
<h1 id="我们需要设定目标，要搞清楚哪些问题？"><a href="#我们需要设定目标，要搞清楚哪些问题？" class="headerlink" title="我们需要设定目标，要搞清楚哪些问题？"></a>我们需要设定目标，要搞清楚哪些问题？</h1><p>“了解一个行业”这件事本身不太可能快速完成。不过，如果我们只是想摸清楚最基本的情况，我们可以通过问对几个关键问题着手。</p>
<ul>
<li>  这个行业的存在是因为它提供了什么价值？</li>
<li>  这个行业从源头到终点都有哪些环节？</li>
<li>  这个行业的终端产品售价都由谁分享？</li>
<li>  每个环节凭借什么关键因素，创造了什么价值获得他所应得的利益？</li>
<li>  这个行业的市场集中度如何？</li>
</ul>
<h1 id="从哪里找到行业数据？"><a href="#从哪里找到行业数据？" class="headerlink" title="从哪里找到行业数据？"></a>从哪里找到行业数据？</h1><a href="#">Post not found: 家都在哪里找数据?</a>

<h1 id="摸清行业的方法论"><a href="#摸清行业的方法论" class="headerlink" title="摸清行业的方法论"></a>摸清行业的方法论</h1><p>首先我们需要知道，如果想快速了解一个行业，要关注哪些关键元素，还有哪些小技巧可以结合。<br>这些关键元素按照研究顺序依次是：痛点、相关区别和联系、发展史、成熟度、取胜密码五个。</p>
<p>有人会问：啥？不先去百科看看这个行业的定义？</p>
<p>**</p>
<p><img src="https://pic2.zhimg.com/50/v2-6c26fdd6ab5d78c25b7a6a6d18985cde_hd.jpg?source=1940ef5c"></p>
<p><img src="https://pic2.zhimg.com/80/v2-6c26fdd6ab5d78c25b7a6a6d18985cde_720w.jpg?source=1940ef5c"></p>
<p>**</p>
<p>不建议！</p>
<p>对于外行来说，一方面百科内容正式，过于晦涩，搞懂要花不少功夫，另一方面由于规则要求，很多百科内容参考了学术论文，而中国的学术论文在商业世界里大多是脱节的，这造成百科内容看起来很完整，但是飘在天上，跟这个领域的现实情况有不少距离，看了反而误导人。</p>
<h2 id="痛点"><a href="#痛点" class="headerlink" title="痛点"></a>痛点</h2><p>这里指这个行业最主要帮客户解决了什么问题，具体来说，客户如果没有这个行业的产品或服务的时候是什么样子的，有了以后，又是什么样子的。对痛点的描述必须结合场景，而有了场景，人们的理解会容易很多。痛点意味着这个行业存在的意义，因为它确实解决了客户的问题。</p>
<p>怎么快速了解这个行业解决的痛点呢？</p>
<p>1、看案例，这是效率最高的方式：搜索xx行业案例</p>
<p>2、看宣传材料——这个要碰运气，很多宣传材料其实比较模糊，制作时候是建立在受众有一定基础上的，对小白不够友好</p>
<p>3、有条件的话，和从业者交流更直接一些</p>
<h2 id="相关区别和联系"><a href="#相关区别和联系" class="headerlink" title="相关区别和联系"></a>相关区别和联系</h2><p><img src="https://pic1.zhimg.com/50/v2-c3885930af05e74905fbea30f1c1ed5f_hd.jpg?source=1940ef5c"></p>
<p><img src="https://pic1.zhimg.com/80/v2-c3885930af05e74905fbea30f1c1ed5f_720w.jpg?source=1940ef5c"></p>
<p>确实，外行很容易搞不清楚这种外形相似（名字、宣传语、术语）的行业之间的关系，但如果真正想要了解一个行业，还是分清楚的好——说起来这个很好解决，只要多看看几个问网络上的的解答内容就行了。</p>
<h2 id="发展史"><a href="#发展史" class="headerlink" title="发展史"></a>发展史</h2><p>发展史有助于进一步了解一个行业存在的意义，同时它的营养更丰富，可以当八卦文章读，没有什么难度，研究方式：关键词搜索xx行业发展史即可，看2-3篇比较长的足够了。</p>
<h2 id="成熟度"><a href="#成熟度" class="headerlink" title="成熟度"></a>成熟度</h2><p>成熟度是指该行业在客户、媒体、同行等大众心中被认识到了什么地步，越多地了解上下游其他行业的成熟度，就更加了解自己的客户。</p>
<p>研究方式：</p>
<ul>
<li>  搜索关键词xx行业成熟度，调2-3篇较长的看看即可</li>
<li>  观察这个行业国内top厂商员工、客户案例数量</li>
<li>  有条件的可以直接跟从业者沟通</li>
</ul>
<p><img src="https://pic4.zhimg.com/50/v2-9079d78e614012e3fd6cb72da68797ff_hd.jpg?source=1940ef5c"></p>
<p><img src="https://pic4.zhimg.com/80/v2-9079d78e614012e3fd6cb72da68797ff_720w.jpg?source=1940ef5c"></p>
<h2 id="取胜密码"><a href="#取胜密码" class="headerlink" title="取胜密码"></a>取胜密码</h2><p>取胜密码是一个行业的底层逻辑，就是这个行业的公司、个人在竞争中到底在拼什么？设想如果想要进入行业，门槛在哪里？</p>
<p>大部分情况下一个行业受限于大环境，往小了说，某方面做得好，就可以有竞争优势，往大了说，有的一方面做得好，可以赢家通吃。</p>
<ul>
<li>  有的行业竞争关键靠渠道，比如很多硬件</li>
<li>  有的行业竞争关键靠关系，比如政务软件</li>
<li>  有的行业竞争关键靠供应链，比如大屏设备</li>
<li>  有的行业竞争关键靠资本，比如云主机</li>
</ul>
<p>顺便说一句，那些竞争关键并不是资本的行业，拿了资金，其实并花不明白这笔钱，不容易提升竞争力。</p>
<p>有的公司被收购后，行业地位会下降，是同样的道理：被收购可能被输入了一些客户资源和资本，但是长期的竞争中拼的不是一次性的存量客户资源，最后只能在安乐窝里惨淡经营。</p>
<p>有的行业竞争关键靠价格，比如短信平台</p>
<p>有的行业竞争关键靠方法论，比如咨询</p>
<p>当然……还有很多细分领域，进入门槛很低，看起来有一点技术基础谁都能做，这样的行业最终都是在拼文化，拼人才，拼效率，拼方法论，拼客户案例，比如BI，<a href="https://link.zhihu.com/?target=http://www.finebi.com/?utm_source=media&utm_medium=zhihu">FineBI</a>在各个行业都有深度的案例分析，这是靠积累的，不会一蹴而就。</p>
<p>说个技巧：</p>
<p>行业分类一定要遵循<a href="https://wiki.mbalib.com/wiki/MECE%E5%88%86%E6%9E%90%E6%B3%95">MECE法则（相互独立，完全穷尽）</a>-我们谈的行业，尽量是细分到不能再细分的。否则无法抽象出共性，场景差距太大。</p>
]]></content>
      <categories>
        <category>大数据</category>
        <category>数据分析</category>
      </categories>
      <tags>
        <tag>数据分析</tag>
        <tag>行业分析</tag>
        <tag>方法论</tag>
      </tags>
  </entry>
  <entry>
    <title>如何让MySQL查询对大小写敏感?</title>
    <url>/2020/07/19/%E5%A6%82%E4%BD%95%E8%AE%A9MySQL%E6%9F%A5%E8%AF%A2%E5%AF%B9%E5%A4%A7%E5%B0%8F%E5%86%99%E6%95%8F%E6%84%9F/</url>
    <content><![CDATA[<p>当我们输入不管大小写都能查询到数据，例如：输入 aaa 或者aaA ,AAA都能查询同样的结果，说明查询条件对大小写不敏感。<br>解决方案一：<br>于是怀疑Mysql的问题。做个实验：直接使用客户端用sql查询数据库。 发现的确是大小不敏感 。<br>通过查询资料发现需要设置collate（校对） 。 collate规则：<br>*_bin: 表示的是binary case sensitive collation，也就是说是区分大小写的<br>*_cs: case sensitive collation，区分大小写<br>*_ci: case insensitive collation，不区分大小写<br>解决方法。<br>1.可以将查询条件用binary()括起来。 比如：<br>select * from TableA where binary columnA =’aaa’;</p>
<ol start="2">
<li>可以修改该字段的collation 为 binary<br> 比如：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> TABLENAME</span><br><span class="line">MODIFY <span class="keyword">COLUMN</span> COLUMNNAME <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="type">BINARY</span> <span class="type">CHARACTER</span></span><br><span class="line"><span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解决方案二：<br>mysql查询默认是不区分大小写的 如:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> some_table <span class="keyword">where</span> str<span class="operator">=</span>‘abc<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">select * from some_table where str=&#x27;</span>ABC<span class="string">&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>得到的结果是一样的，如果我们需要进行区分的话可以按照如下方法来做：<br>第一种方法：<br>要让mysql查询区分大小写，可以：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> some_table <span class="keyword">where</span> <span class="type">binary</span> str<span class="operator">=</span><span class="string">&#x27;abc&#x27;</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> some_table <span class="keyword">where</span> <span class="type">binary</span> str<span class="operator">=</span><span class="string">&#x27;ABC&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二方法：<br>在建表时时候加以标识</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> some_table( str <span class="type">char</span>(<span class="number">20</span>) <span class="type">binary</span> )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原理：<br>对于CHAR、VARCHAR和TEXT类型，BINARY属性可以为列分配该列字符集的 校对规则。BINARY属性是指定列字符集的二元 校对规则的简写。排序和比较基于数值字符值。因此也就自然区分了大小写。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>定时器重启爱奇艺客户端</title>
    <url>/2016/03/12/%E5%AE%9A%E6%97%B6%E5%99%A8%E9%87%8D%E5%90%AF%E7%88%B1%E5%A5%87%E8%89%BA%E5%AE%A2%E6%88%B7%E7%AB%AF/</url>
    <content><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>想下载几个电视节目，找了很多地方，没有资源打包下载的，只有爱奇艺上可以下载。</p>
<p>但是有个问题，爱奇艺客户端上的下载功能不好用，断了不重试，每次断了之后，只能手动暂停再重开才能继续。</p>
<p>于是需要写个批处理来代替人工，才能挂着不用管。</p>
<h2 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h2><p>windows xp sp3</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><ul>
<li><p>由于无法长时间挂着下载，需要定期暂停并重新下载</p>
</li>
<li><p>设置客户端启动即刻继续下载</p>
</li>
<li><p>定时重启客户端，达到周期性重试下载的目的</p>
</li>
</ul>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><h5 id="客户端的守护进程"><a href="#客户端的守护进程" class="headerlink" title="客户端的守护进程"></a>客户端的守护进程</h5><ul>
<li><p>设置客户端自动启动</p>
</li>
<li><p><code>运行</code> -&gt; 输入<code>msconfig</code> -&gt; 切换到<code>启动</code>选项卡 </p>
</li>
<li><p>找到最小启动客户端的命令</p>
</li>
</ul>
<ul>
<li>编写客户端的守护进程</li>
</ul>
<p><code>QyClient-daemon.bat</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">:main</span><br><span class="line">ping -n 3 127.0.0.1&gt;nul</span><br><span class="line">tasklist | find /i &quot;QyClient.exe&quot;&amp;&amp;goto main</span><br><span class="line">cd D:\Program Files\IQIYI Video\LStyle\</span><br><span class="line">start QyClient.exe</span><br><span class="line">goto main</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="关闭客户端"><a href="#关闭客户端" class="headerlink" title="关闭客户端"></a>关闭客户端</h5><p><code>QyClient-Close.bat</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">taskkill /im QyClient.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="主进程"><a href="#主进程" class="headerlink" title="主进程"></a>主进程</h5><p><code>QyClient.bat</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd D:\workplace\tmp\</span><br><span class="line">start /min QyClient-daemon.bat</span><br><span class="line">:main</span><br><span class="line">ping -n 71 127.0.0.1&gt;nul</span><br><span class="line">taskkill /im QyClient.exe</span><br><span class="line">goto main</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>执行<code>QyClient.bat</code></p>
<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><p><a href="https://github.com/tomhjx/tools/tree/master/qiyi-download">https://github.com/tomhjx/tools/tree/master/qiyi-download</a></p>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>windows批处理</category>
      </categories>
      <tags>
        <tag>原创</tag>
      </tags>
  </entry>
  <entry>
    <title>怎样同步修正Mac OS X的时钟?</title>
    <url>/2020/09/26/%E6%80%8E%E6%A0%B7%E5%90%8C%E6%AD%A5%E4%BF%AE%E6%AD%A3Mac-OS-X%E7%9A%84%E6%97%B6%E9%92%9F/</url>
    <content><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sntp -sS time.apple.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>IT</category>
        <category>笔记本电脑</category>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>笔记本电脑</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>悲观锁和乐观锁</title>
    <url>/2016/01/03/%E6%82%B2%E8%A7%82%E9%94%81%E5%92%8C%E4%B9%90%E8%A7%82%E9%94%81/</url>
    <content><![CDATA[<p>1        事务隔离</p>
<p>事务隔离是数据库提供的功能。</p>
<p>SQL Server通过SET TRANSACTION ISOLATION LEVEL语句设置事务隔离级别：</p>
<p>SET TRANSACTION ISOLATION LEVEL</p>
<pre><code>&#123; READ UNCOMMITTED

| READ COMMITTED

| REPEATABLE READ

| SNAPSHOT

| SERIALIZABLE

&#125;
</code></pre>
<p>[ ; ]</p>
<p>Read Committed是SQL Server的预设隔离等级。</p>
<p>1.1         READ UNCOMMITTED<br>Read UnCommitted事务可以读取事务已修改，但未提交的的记录。</p>
<p>Read UnCommitted事务会产生脏读（Dirty Read）。</p>
<p>Read UnCommitted事务与select语句加nolock的效果一样，它是所有隔离级别中限制最少的。</p>
<p>1.2         READ COMMITTED<br>Read Committed事务不能读取事务已修改，但未提交的记录。</p>
<p>Read Committed是SQL Server的预设隔离等级。</p>
<p>1.3         REPEATABLE READ<br>Repeatable Read事务不能读取交易已修改，但未提交的记录，并且在事务完成之前，任何其它事务都不能修改目前事务已读取的记录。</p>
<p>其它事务仍可以插入新记录，但必须符合当前事务的搜索条件——这意味着当前事务重新查询记录时，会产生幻读（Phantom Read）。</p>
<p>1.4         SNAPSHOT<br>Snapshot事务中任何语句所读取的记录，都是事务启动时的数据。</p>
<p>这相当于事务启动时，数据库为事务生成了一份专用“快照”。</p>
<p>在当前事务中看到不其它事务在当前事务启动之后所进行的数据修改。</p>
<p>Snapshot事务不会读取记录时要求锁定，读取记录的Snapshot事务不会锁住其它事务写入记录，写入记录的事务也不会锁住Snapshot事务读取数据。</p>
<p>1.5         SERIALIZABLE<br>Serializable事务会产生以下效果：</p>
<p>1.语句无法读取其它事务已修改但未提交的记录。</p>
<p>2.在当前事务完成之前，其它事务不能修改目前事务已读取的记录。</p>
<p>3.在当前事务完成之前，其它事务所插入的新记录，其索引键值不能在当前事务的任何语句所读取的索引键范围中。</p>
<p>Serializable事务与select语句加holdlock的效果一样。</p>
<p>2        READ COMMITTED 和 REPEATABLE READ<br>Read Committed 和 Repeatable Read 是最常用的两种事务。</p>
<p>Read Committed 是 SQL Server的默认级别；而 Repeatable Read 比Read Committed 更能保证数据一致性。</p>
<p>2.1         特点<br>Read Committed会阻塞其它事务中的update，但不会阻塞select。</p>
<p>Repeatable Read不但会阻塞其它事务中的update，还会阻塞select。</p>
<p>Read Committed 和 Repeatable Read 的相同点是：都会阻塞其它事务的update语句。</p>
<p>Read Committed 和 Repeatable Read 的不同点是：Read Committed 不会阻塞其它事务的select语句，但Repeatable Read阻塞。</p>
<p>注意，Read Committed 和 Repeatable Read 都是行级锁，它们只会锁住与自己相关的记录。当事务提交之后，阻塞的语句就会继续执行。</p>
<p>2.2         理解<br>2.2.1     READ COMMITTED<br>Read Committed 事务的含义是我select出来的记录，别人只能看，不能改（只阻塞别的事务的update）。</p>
<p>Read Committed 的缺点是：无法防止读取不一致和修改丢失。</p>
<p>读取不一致是因为Read Committed 不锁住读取的记录；修改丢失是因为别的事务也能读取当前事务的记录，虽然会阻塞别的事务的update，但在当前事务提交之后，别的事务的update语句会继续执行，进而覆盖上一次事务的结果，导致上一次的修改丢失。</p>
<p>2.2.2     REPEATABLE READ<br>Repeatable Read 事务的含义是我select出来的记录，不允许别人看，也不允许别人改（阻塞别的事务select、update），这就意味着我可以在事务中多次select数据，而不用担心出现“脏读”——这就是“可重复读取”的意思。</p>
<p>Repeatable Read 虽然解决了Read Committed 事务的读取不一致和修改丢失的缺点，但它也有缺点（尽管这个缺点Read Committed 也有）：</p>
<p>Repeatable Read 不会阻塞insert和delete，所以会出现“幻读”——两次select的结果不一样。还有，Repeatable Read 占用的资源比Read Committed 大。</p>
<p>3        在应用程序中设置事务隔离级别<br>READ COMMITTED 是 Microsoft SQL Server Database Engine 的预设隔离等级。</p>
<p>已指定隔离等级时，在 SQL Server 工作阶段中，所有查询和数据操作语言 (DML) 陈述式的锁定行为都会在此隔离等级运作。此隔离等级会维持有效，直到工作阶段结束或隔离等级设为另一个等级为止。</p>
<p>如果应用程序必须在不同隔离等级操作，可以使用下列方法来设定隔离等级：</p>
<p>l           执行 SET TRANSACTION ISOLATION LEVEL Transact-SQL 陈述式。</p>
<p>l           如果 ADO.NET 应用程序使用 System.Data.SqlClient 管理的命名空间，可以使用 SqlConnection.BeginTransaction 方法来指定 IsolationLevel 选项。</p>
<p>l           使用 ADO 的应用程序可以设定 Autocommit Isolation Levels 属性。</p>
<p>l           当启动交易时，使用 OLE DB 的应用程序可以将 isoLevel 设为所要的交易隔离等级，以呼叫 ITransactionLocal::StartTransaction。当在自动认可模式中指定隔离等级时，使用 OLE DB 的应用程序可以将 DBPROPSET_SESSION 属性 DBPROP_SESS_AUTOCOMMITISOLEVELS 设为所要的交易隔离等级。</p>
<p>l           使用 ODBC 的应用程序可以使用 SQLSetConnectAttr 来设定 SQL_COPT_SS_TXN_ISOLATION 属性。</p>
<p>4        悲观锁<br>悲观锁是指假设并发更新冲突会发生，所以不管冲突是否真的发生，都会使用锁机制。</p>
<p>悲观锁会完成以下功能：锁住读取的记录，防止其它事务读取和更新这些记录。其它事务会一直阻塞，直到这个事务结束。</p>
<p>悲观锁是在使用了数据库的事务隔离功能的基础上，独享占用的资源，以此保证读取数据一致性，避免修改丢失。</p>
<p>悲观锁可以使用Repeatable Read事务，它完全满足悲观锁的要求。</p>
<p>5        乐观锁<br>乐观锁不会锁住任何东西，也就是说，它不依赖数据库的事务机制，乐观锁完全是应用系统层面的东西。</p>
<p>如果使用乐观锁，那么数据库就必须加版本字段，否则就只能比较所有字段，但因为浮点类型不能比较，所以实际上没有版本字段是不可行的。</p>
<p>6        死锁<br>当二或多个工作各自具有某个资源的锁定，但其它工作尝试要锁定此资源，而造成工作永久封锁彼此时，会发生死锁。例如：</p>
<ol>
<li><pre><code>      事务 A 取得数据列 1 的共享锁定。
</code></pre>
</li>
<li><pre><code>      事务B 取得数据列 2 的共享锁定。
</code></pre>
</li>
<li><pre><code>      事务A 现在要求数据列 2 的独占锁定，但会被封锁直到事务B 完成并释出对数据列 2 的共享锁定为止。
</code></pre>
</li>
<li><pre><code>      事务B 现在要求数据列 1 的独占锁定，但会被封锁直到事务A 完成并释出对数据列 1 的共享锁定为止。
</code></pre>
</li>
</ol>
<p>等到事务B 完成后，事务A 才能完成，但事务B 被事务A 封锁了。这个状况也称为「循环相依性」(Cyclic Dependency)。事务A 相依于事务B，并且事务B 也因为相依于事务A 而封闭了这个循环。</p>
<p>例如以下操作就会产生死锁，两个连接互相阻塞对方的update。</p>
<p>连接1：</p>
<p>begin tran</p>
<p>select * from customers</p>
<p>update customers set CompanyName = CompanyName</p>
<p>waitfor delay ‘00:00:05’</p>
<p>select * from Employees</p>
<p>–因为Employees被连接2锁住了，所以这里会阻塞。</p>
<p>update Employees set LastName = LastName</p>
<p>commit tran</p>
<p>连接2：</p>
<p>begin tran</p>
<p>select * from Employees</p>
<p>update Employees set LastName = LastName</p>
<p>waitfor delay ‘00:00:05’</p>
<p>select * from customers</p>
<p>–因为customers被连接1锁住了，所以这里会阻塞。</p>
<p>update customers set CompanyName = CompanyName</p>
<p>commit tran</p>
<p>SQL Server遇到死锁时会自动杀死其中一个事务，而另一个事务会正常结束（提交或回滚）。</p>
<p>SQL Server对杀死的连接返回错误代码是1205，异常提示是：</p>
<p>Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thRead} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.</p>
<p>除了Read UnCommitted和Snapshot，其它类型的事务都可能产生死锁。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>悲观锁</tag>
        <tag>乐观锁</tag>
      </tags>
  </entry>
  <entry>
    <title>文件操作监控</title>
    <url>/2020/03/14/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<h1 id="inotify-tools"><a href="#inotify-tools" class="headerlink" title="inotify-tools"></a><a href="https://github.com/inotify-tools/inotify-tools/wiki">inotify-tools</a></h1><p>inotify-tools 是为linux下inotify文件监控工具提供的一套c的开发接口库函数，同时还提供了一系列的命令行工具，这些工具可以用来监控文件系统的事件。 inotify-tools是用c编写的，除了要求内核支持inotify外，不依赖于其他。inotify-tools提供两种工具，一是inotifywait，它是用来监控文件或目录的变化，二是inotifywatch，它是用来统计文件系统访问的次数</p>
<p>参考:<br><a href="https://www.centos.bz/2012/06/inotify-tools-introduction/">https://www.centos.bz/2012/06/inotify-tools-introduction/</a><br><a href="https://www.linuxjournal.com/content/linux-filesystem-events-inotify">https://www.linuxjournal.com/content/linux-filesystem-events-inotify</a></p>
]]></content>
      <categories>
        <category>操作系统</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>服务度量</title>
    <url>/2021/04/18/%E6%9C%8D%E5%8A%A1%E5%BA%A6%E9%87%8F/</url>
    <content><![CDATA[<h1 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h1><p>响应时间（response time 简称 RT）是从系统接收请求开始到返回响应之间的时间跨度，是一项极其重要的性能指标。它可以从侧面反映系统的整体吞吐量，也是业务请求（比如 sql 请求）的性能好坏的判断依据。</p>
<p>举个例子 A 要从杭州坐飞机到北京机场，经历如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">从公司到萧山机场 40min</span><br></pre></td></tr></table></figure>

<p>复制代码</p>
<p>其中真正的 ‘执行’ 时间就飞机飞行的时间（100min+40+40），其他安检、候机、堵车的都是等待时间。</p>
<blockquote>
<p>RT = 等待时间 + 执行时间</p>
</blockquote>
<p>假如到机场的过程中发生堵车，或者空中管制导致候机时间延长，整体的 RT 也会变长，但是飞机飞行时间是相对一定的。</p>
<p>从技术的角度来看 SQL 的请求路径：</p>
<blockquote>
<p>app &lt;----&gt;（网络建立连接，data 传输）&lt;----&gt; proxy &lt;----&gt;（网络建立连接，data 传输）&lt;----&gt; mysql（执行）</p>
</blockquote>
<p>因为网络问题丢包，重传等导致数据传输时间增加，进而导致总体的 RT 时间增加 ，还有常见的案例 app 服务器 cpu 飙高导致程序执行的速度变慢，JAVA 程序 GC 等因素也会导致 RT 升高。所以说 SQL 慢，其实 RT 就会高。但是反过来 <strong>RT 高，不一定是 SQL 慢的原因</strong> 。如果是开发同学遇到监控尤其是 trace 系统发现某个接口慢了，并不一定是 SQL 慢。</p>
<blockquote>
<p>重点： <strong>不要把 trace 系统中的监控 rt 直接当做 db 的执行时间</strong></p>
</blockquote>
<p>参考案例：<a href="https://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&mid=2648450714&idx=1&sn=d2a25d111c78147001aa9329dbbf9dbd&scene=21#wechat_redirect">Strace 解决性能问题案例一则</a></p>
<h1 id="TPS"><a href="#TPS" class="headerlink" title="TPS"></a>TPS</h1><p>Transactions Per Second（每秒传输的事物处理个数），即服务器<strong>每秒</strong>处理的事务数。TPS包括一条消息入和一条消息出，加上一次用户数据库访问。（业务TPS = CAPS × 每个呼叫平均TPS）</p>
<p>TPS是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数。</p>
<p>一般的，评价系统性能均以每秒钟完成的技术交易的数量来衡量。系统整体处理能力取决于处理能力最低模块的TPS值。</p>
<h1 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h1><p>每秒查询率QPS是对一个特定的查询服务器在<strong>规定时间内</strong>所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。</p>
<p>对应fetches/sec，即每秒的响应请求数，也即是最大吞吐能力。</p>
<p>QPS与TPS的<strong>区别</strong>是什么呢？</p>
<p>举个栗子：假如一个大胃王一秒能吃10个包子，一个女孩子0.1秒能吃1个包子，那么他们是不是一样的呢？答案是否定的，因为这个女孩子不可能在一秒钟吃下10个包子，她可能要吃很久。这个时候这个大胃王就相当于TPS，而这个女孩子则是QPS。虽然很相似，但其实是不同的。</p>
<h1 id="并发量"><a href="#并发量" class="headerlink" title="并发量"></a>并发量</h1><p>我们首先分析一个问题：一个公司有7200名员工，每天上班打卡时间是早上8点到8点30分，每次打卡时间系统耗时5秒。请问RT、QPS、并发量分别是多少？</p>
<p>RT表示响应时间，问题已经告诉了我们答案：</p>
<blockquote>
<p>RT = 5</p>
</blockquote>
<p>QPS表示每秒查询量，假设签到行为平均分布：</p>
<blockquote>
<p>QPS = 7200 / (30 * 60) = 4</p>
</blockquote>
<p>并发量表示系统同时处理的请求数量：</p>
<blockquote>
<p>并发量 = QPS x RT = 4 x 5 = 20</p>
</blockquote>
<p>根据上述实例引出如下公式：</p>
<blockquote>
<p>并发量 = QPS x RT</p>
</blockquote>
<p>如果系统为每一个请求分配一个处理线程，那么并发量可以近似等于线程数。基于上述公式不难看出并发量受QPS和RT影响，这两个指标任意一个上升就会导致并发量上升。</p>
<p>但是这只是理想情况，因为并发量受限于系统能力而不可能持续上升</p>
<h1 id="吞吐量"><a href="#吞吐量" class="headerlink" title="吞吐量"></a>吞吐量</h1><p>一．系统吞吐量要素：</p>
<p>一个系统的<strong>吞吐量</strong>（承压能力）与request对CPU的消耗、外部接口、IO等等紧密关联。单个reqeust 对CPU消耗越高，外部系统接口、IO影响速度越慢，系统吞吐能力越低，反之越高。</p>
<p>系统吞吐量几个重要参数：QPS（TPS）、并发数、响应时间</p>
<p>QPS（TPS）：每秒钟request/事务 数量</p>
<p>并发数： 系统同时处理的request/事务数</p>
<p>响应时间： 一般取平均响应时间</p>
<p>（很多人经常会把并发数和TPS理解混淆）</p>
<p>理解了上面三个要素的意义之后，就能推算出它们之间的关系：</p>
<p>QPS（TPS）= 并发数/平均响应时间 或者 并发数 = QPS*平均响应时间</p>
<p>一个典型的上班签到系统，早上8点上班，7点半到8点的30分钟的时间里用户会登录签到系统进行签到。公司员工为1000人，平均每个员上登录签到系统的时长为5分钟。可以用下面的方法计算。</p>
<p>QPS = 1000/(30*60) 事务/秒</p>
<p>平均响应时间为 = 5*60 秒</p>
<p>并发数= QPS*平均响应时间 = 1000/(30*60) *(5*60)=166.7</p>
<p>一个系统吞吐量通常由QPS（TPS）、并发数两个因素决定，每套系统这两个值都有一个相对极限值，在应用场景访问压力下，只要某一项达到系统最高值，系统的吞吐量就上不去了，如果压力继续增大，系统的吞吐量反而会下降，原因是系统超负荷工作，上下文切换、内存等等其它消耗导致系统性能下降。</p>
<p>决定系统响应时间要素</p>
<p>我们做项目要排计划，可以多人同时并发做多项任务，也可以一个人或者多个人串行工作，始终会有一条关键路径，这条路径就是项目的工期。</p>
<p>系统一次调用的响应时间跟项目计划一样，也有一条关键路径，这个关键路径是就是系统影响时间；</p>
<p>关键路径是有CPU运算、IO、外部系统响应等等组成。</p>
<p>二．系统吞吐量评估：</p>
<p>我们在做系统设计的时候就需要考虑CPU运算、IO、外部系统响应因素造成的影响以及对系统性能的初步预估。</p>
<p>而通常境况下，我们面对需求，我们评估出来的出来QPS、并发数之外，还有另外一个维度：日PV。</p>
<p>通过观察系统的访问日志发现，在用户量很大的情况下，各个时间周期内的同一时间段的访问流量几乎一样。比如工作日的每天早上。只要能拿到日流量图和QPS我们就可以推算日流量。</p>
<p>通常的技术方法：</p>
<p>1. 找出系统的最高TPS和日PV，这两个要素有相对比较稳定的关系（除了放假、季节性因素影响之外）</p>
<p>2. 通过压力测试或者经验预估，得出最高TPS，然后跟进1的关系，计算出系统最高的日吞吐量。B2B中文和淘宝面对的客户群不一样，这两个客户群的网络行为不应用，他们之间的TPS和PV关系比例也不一样。</p>
<p>A)淘宝</p>
<p>淘宝流量图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9405009-38330b52a93daf7c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/690/format/webp"></p>
<p>淘宝的TPS和PV之间的关系通常为 最高TPS：PV大约为 1 : 11*3600 （相当于按最高TPS访问11个小时，这个是商品详情的场景，不同的应用场景会有一些不同）</p>
<p>B) B2B中文站</p>
<p>B2B的TPS和PV之间的关系不同的系统不同的应用场景比例变化比较大，粗略估计在1 : 8个小时左右的关系（09年对offerdetail的流量分析数据）。旺铺和offerdetail这两个比例相差很大，可能是因为爬虫暂的比例较高的原因导致。</p>
<p>在淘宝环境下，假设我们压力测试出的TPS为100，那么这个系统的日吞吐量=100*11*3600=396万</p>
<p>这个是在简单（单一url）的情况下，有些页面，一个页面有多个request，系统的实际吞吐量还要小。</p>
<p>无论有无思考时间（T_think），测试所得的TPS值和并发虚拟用户数(U_concurrent)、Loadrunner读取的交易响应时间（T_response）之间有以下关系（稳定运行情况下）：</p>
<p>TPS=U_concurrent / (T_response+T_think)。</p>
<p>并发数、QPS、平均响应时间三者之间关系</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9405009-d9a096983a4d7e45.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/500/format/webp"></p>
<p>上图横坐标是并发用户数。绿线是CPU使用率；紫线是吞吐量，即QPS；蓝线是时延。</p>
<p>开始，系统只有一个用户，CPU工作肯定是不饱合的。一方面该服务器可能有多个cpu，但是只处理单个进程，另一方面，在处理一个进程中，有些阶段可能是IO阶段，这个时候会造成CPU等待，但是有没有其他请 求进程可以被处理）。随着并发用户数的增加，CPU利用率上升，QPS相应也增加（公式为QPS=并发用户数/平均响应时间。）随着并发用户数的增加，平均响应时间也在增加，而且平均响应时间的增加是一个指数增加曲线。而当并发数增加到很大时，每秒钟都会有很多请求需要处理，会造成进程（线程）频繁切换，反正真正用于处理请求的时间变少，每秒能够处 理的请求数反而变少，同时用户的请求等待时间也会变大，甚至超过用户的心理底线。</p>
<p>软件性能测试的基本概念和计算公式</p>
<p>一、软件性能的关注点</p>
<p>对一个软件做性能测试时需要关注那些性能呢？</p>
<p>我们想想在软件设计、部署、使用、维护中一共有哪些角色的参与，然后再考虑这些角色各自关注的性能点是什么，作为一个软件性能测试工程师，我们又该关注什么？</p>
<p>首先，开发软件的目的是为了让用户使用，我们先站在用户的角度分析一下，用户需要关注哪些性能。</p>
<p>对于用户来说，当点击一个按钮、链接或发出一条指令开始，到系统把结果已用户感知的形式展现出来为止，这个过程所消耗的时间是用户对这个软件性能的直观印象。也就是我们所说的响应时间，当相应时间较小时，用户体验是很好的，当然用户体验的响应时间包括个人主观因素和客观响应时间，在设计软件时，我们就需要考虑到如何更好地结合这两部分达到用户最佳的体验。如：用户在大数据量查询时，我们可以将先提取出来的数据展示给用户，在用户看的过程中继续进行数据检索，这时用户并不知道我们后台在做什么。</p>
<p>用户关注的是用户操作的相应时间。</p>
<p>其次，我们站在管理员的角度考虑需要关注的性能点。</p>
<p>1、 相应时间</p>
<p>2、 服务器资源使用情况是否合理</p>
<p>3、 应用服务器和数据库资源使用是否合理</p>
<p>4、 系统能否实现扩展</p>
<p>5、 系统最多支持多少用户访问、系统最大业务处理量是多少</p>
<p>6、 系统性能可能存在的瓶颈在哪里</p>
<p>7、 更换那些设备可以提高性能</p>
<p>8、 系统能否支持7×24小时的业务访问</p>
<p>再次，站在开发（设计）人员角度去考虑。</p>
<p>1、 架构设计是否合理</p>
<p>2、 数据库设计是否合理</p>
<p>3、 代码是否存在性能方面的问题</p>
<p>4、 系统中是否有不合理的内存使用方式</p>
<p>5、 系统中是否存在不合理的线程同步方式</p>
<p>6、 系统中是否存在不合理的资源竞争</p>
<p>那么站在性能测试工程师的角度，我们要关注什么呢？</p>
<p>一句话，我们要关注以上所有的性能点。</p>
<p>二、软件性能的几个主要术语</p>
<p>1、响应时间：对请求作出响应所需要的时间</p>
<p>网络传输时间：N1+N2+N3+N4</p>
<p>应用服务器处理时间：A1+A3</p>
<p>数据库服务器处理时间：A2</p>
<p>响应时间=N1+N2+N3+N4+A1+A3+A2</p>
<p>2、并发用户数的计算公式</p>
<p>系统用户数：系统额定的用户数量，如一个OA系统，可能使用该系统的用户总数是5000个，那么这个数量，就是系统用户数。</p>
<p>同时在线用户数：在一定的时间范围内，最大的同时在线用户数量。</p>
<p>同时在线用户数=每秒请求数RPS（吞吐量）+并发连接数+平均用户思考时间</p>
<p>平均并发用户数的计算：C=nL / T</p>
<p>其中C是平均的并发用户数，n是平均每天访问用户数（login session），L是一天内用户从登录到退出的平均时间（login session的平均时间），T是考察时间长度（一天内多长时间有用户使用系统）</p>
<p>并发用户数峰值计算：C^约等于C + 3*根号C</p>
<p>其中C^是并发用户峰值，C是平均并发用户数，该公式遵循泊松分布理论。</p>
<p>3、吞吐量的计算公式</p>
<p>指单位时间内系统处理用户的请求数</p>
<p>从业务角度看，吞吐量可以用：请求数/秒、页面数/秒、人数/天或处理业务数/小时等单位来衡量</p>
<p>从网络角度看，吞吐量可以用：字节/秒来衡量</p>
<p>对于交互式应用来说，吞吐量指标反映的是服务器承受的压力，他能够说明系统的负载能力</p>
<p>以不同方式表达的吞吐量可以说明不同层次的问题，例如，以字节数/秒方式可以表示数要受网络基础设施、服务器架构、应用服务器制约等方面的瓶颈；已请求数/秒的方式表示主要是受应用服务器和应用代码的制约体现出的瓶颈。</p>
<p>当没有遇到性能瓶颈的时候，吞吐量与虚拟用户数之间存在一定的联系，可以采用以下公式计算：F=VU * R /</p>
<p>其中F为吞吐量，VU表示虚拟用户个数，R表示每个虚拟用户发出的请求数，T表示性能测试所用的时间</p>
<p>4、性能计数器</p>
<p>是描述服务器或操作系统性能的一些数据指标，如使用内存数、进程时间，在性能测试中发挥着“监控和分析”的作用，尤其是在分析统统可扩展性、进行新能瓶颈定位时有着非常关键的作用。</p>
<p>资源利用率：指系统各种资源的使用情况，如cpu占用率为68%，内存占用率为55%，一般使用“资源实际使用/总的资源可用量”形成资源利用率。</p>
<p>5、思考时间的计算公式</p>
<p>Think Time，从业务角度来看，这个时间指用户进行操作时每个请求之间的时间间隔，而在做新能测试时，为了模拟这样的时间间隔，引入了思考时间这个概念，来更加真实的模拟用户的操作。</p>
<p>在吞吐量这个公式中F=VU * R / T说明吞吐量F是VU数量、每个用户发出的请求数R和时间T的函数，而其中的R又可以用时间T和用户思考时间TS来计算：R = T / TS</p>
<p>下面给出一个计算思考时间的一般步骤：</p>
<p>A、首先计算出系统的并发用户数</p>
<p>C=nL / T F=R×C</p>
<p>B、统计出系统平均的吞吐量</p>
<p>F=VU * R / T R×C = VU * R / T</p>
<p>C、统计出平均每个用户发出的请求数量</p>
<p>R=u*C*T/VU</p>
<p>D、根据公式计算出思考时间</p>
<p>TS=T/R</p>
]]></content>
      <categories>
        <category>运维</category>
        <category>度量</category>
      </categories>
      <tags>
        <tag>度量</tag>
      </tags>
  </entry>
  <entry>
    <title>流程图绘制工具</title>
    <url>/2021/07/17/%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%BB%98%E5%88%B6%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h1 id="Excalidraw"><a href="#Excalidraw" class="headerlink" title="Excalidraw"></a>Excalidraw</h1><p><img src="https://static.leiphone.com/uploads/new/sns/blogSpe/article/202007/5f0f282b48261."></p>
<p><img src="https://upload-images.jianshu.io/upload_images/25212543-4a9676eb5fbae4a3.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp"></p>
<p><a href="https://excalidraw.com/">https://excalidraw.com/</a></p>
<h1 id="Draw-io"><a href="#Draw-io" class="headerlink" title="Draw.io"></a>Draw.io</h1><p><img src="https://static.leiphone.com/uploads/new/sns/blogSpe/article/202007/5f0f282b69ee0.jpg"></p>
<p><a href="https://app.diagrams.net/">https://app.diagrams.net/</a></p>
]]></content>
      <categories>
        <category>办公</category>
        <category>效率工具</category>
      </categories>
      <tags>
        <tag>办公效率</tag>
      </tags>
  </entry>
  <entry>
    <title>继承类并使用单例模式陷阱</title>
    <url>/2016/03/28/%E7%BB%A7%E6%89%BF%E7%B1%BB%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E9%99%B7%E9%98%B1/</url>
    <content><![CDATA[<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_instance</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> !== <span class="built_in">static</span>::<span class="variable">$_instance</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$_instance</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;init &#x27;</span>.get_called_class().<span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$_instance</span> = <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cls1st</span> <span class="keyword">extends</span> <span class="title">Base</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;1st;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cls2nd</span> <span class="keyword">extends</span> <span class="title">Base</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;2nd;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cls1st</span> = Cls1st::getInstance();</span><br><span class="line"><span class="variable">$cls1st</span>-&gt;say();</span><br><span class="line"><span class="variable">$cls2nd</span> = Cls2nd::getInstance();</span><br><span class="line"><span class="variable">$cls2nd</span>-&gt;say();</span><br><span class="line"><span class="variable">$cls1st</span> = Cls1st::getInstance();</span><br><span class="line"><span class="variable">$cls1st</span>-&gt;say();</span><br><span class="line"><span class="variable">$cls2nd</span> = Cls2nd::getInstance();</span><br><span class="line"><span class="variable">$cls2nd</span>-&gt;say();</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">init Cls1st;</span><br><span class="line">1st;</span><br><span class="line">1st;</span><br><span class="line">1st;</span><br><span class="line">1st;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>修改父类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_instances</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$calledClass</span> = get_called_class();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="built_in">static</span>::<span class="variable">$_instances</span>[<span class="variable">$calledClass</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$_instances</span>[<span class="variable">$calledClass</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;init &#x27;</span>.get_called_class().<span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$return</span> = <span class="built_in">static</span>::<span class="variable">$_instances</span>[<span class="variable">$calledClass</span>] = <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">init Cls1st;</span><br><span class="line">1st;</span><br><span class="line">init Cls2nd;</span><br><span class="line">2nd;</span><br><span class="line">1st;</span><br><span class="line">2nd;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>开发</category>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>设计容量，到底有多重要</title>
    <url>/2021/06/05/%E8%AE%BE%E8%AE%A1%E5%AE%B9%E9%87%8F%EF%BC%8C%E5%88%B0%E5%BA%95%E6%9C%89%E5%A4%9A%E9%87%8D%E8%A6%81/</url>
    <content><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>单位每年都会举行运动会，有一个2000m长跑的项目，大约每年报名人员为男选手40人，女选手20人，只有一条橡胶跑道。一次比赛10人齐跑，所以至少需要6场比赛。</p>
<p>2000米的完成时间要求是20分钟，超过20分钟不计数，所以比赛耗时我们计算为20分钟，加上比赛前的动员组织，比赛后的清场，我们假定每场比赛耗时30分钟。</p>
<p>现在我们预估下耗时：</p>
<p>1、60人/10人每场 = 6场，至少需要举行6场</p>
<p>2、总耗时 = 6场 * 0.5h = 3h</p>
<p>所以每年把这个比赛安排在下午3点到6点，是最后一个比赛项目，晚上7点举行颁奖晚会。这个预估容量也算合理。</p>
<p>但是今年比较特别，取消了4000米的长跑，所以2000米报名人员激增50人。时间还是下午3点到6点，</p>
<p>这个就有问题了，最后为了保证晚会的正常进行，一半的人员的比赛时间推迟到另外一周的周末，搞得怨声四起，大骂举办的行政部门不讲武德。</p>
<p>这个是我们单位真实的故事，这就是设计容量，当你的业务场景的容量发生了变化时候，没有预估到他的变化，以及变化可能产生的影响，没有按照这个影响及时的做调整</p>
<p>（比如将比赛时间提前，拉长整个比赛的过程时间，或者增加比赛跑到，同时进行两场比赛），就会造成灾难。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>何为设计容量，从技术上说就是运用一些策略对系统容量进行预估的过程。容量设计是架构师必备的技能之一。</p>
<p>他要求我们分析系统设计容量要求，尽可能给出具体数据描述的：数据量、并发量、带宽、注册用户规模、活跃用户规模、在线用户规模、消息长度，图片大小、网盘空间容量，内存CPU容量等。</p>
<p>下面的内容，我们以 <strong>并发</strong> 为例子，看看看具体的分析过程。</p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><h4 id="理解一些原理"><a href="#理解一些原理" class="headerlink" title="理解一些原理"></a>理解一些原理</h4><p>TPS（Transactions Per Second）：每秒事务数</p>
<p>QPS（Query Per Second）：每秒请求数，QPS其实是衡量吞吐量的一个常用指标，就是说服务器在一秒的时间内处理了多少个请求。</p>
<p>并发数：并发数是指系统同时能处理的请求数量，这个也是反应了系统的负载能力。</p>
<p>峰值QPS计算：</p>
<p>1、原理：每天80%的访问集中在20%的时间里，这20%时间叫做峰值时间</p>
<p>2、公式：( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS)</p>
<p>PV（Page View）：页面访问量，即页面浏览量或点击量，用户每次刷新即被计算一次</p>
<p>UV（Unique Visitor）：独立访客，统计1天内访问某站点的用户数(以cookie为依据)</p>
<p>吐吞量：吞吐量是指系统在单位时间内处理请求的数量</p>
<p>响应时间（RT）：响应时间是指系统对请求作出响应的时间，一般取平均响应时间</p>
<p>QPS（每秒查询数）、TPS（每秒事务数）是吞吐量的常用量化指标，另外还有HPS（每秒HTTP请求数）。</p>
<p>QPS（TPS）、并发数、响应时间它们三者之间的关系是：</p>
<p>1、QPS（TPS）= 并发数 / 平均响应时间</p>
<p>2、并发数 = QPS * 平均响应时间</p>
<h4 id="系统容量评估时机"><a href="#系统容量评估时机" class="headerlink" title="系统容量评估时机"></a>系统容量评估时机</h4><p>主要在三种业务场景下需要及时考虑对系统容量进行评估。</p>
<p>1、临时的流量变化：比如 618、双11，新年大促搞活动等场景，预估我们的流量会大涨，甚至到原来的数倍。这时候要做好应对的措施。</p>
<p>2、初始系统容量评估：假设我们开发了某个系统，这个系统初始上线，我们预估他的容量和负载会是多少。</p>
<p>3、容量基数的变化：比如某个系统，他的功能模块越来越多，数据流量越来越大，日活指数越来越高，迎来了第二波的增长曲线。我们原来定好的系统容量渐渐的不满足我们的需求，这时候我们也要重新评估和扩容。</p>
<p>我们系统容量评估包括数据量、并发量、带宽、CPU、MEMORY、DISK等。以并发量为案例，我们来说明系统容量评估的方法和步骤。</p>
<h4 id="评估的步骤"><a href="#评估的步骤" class="headerlink" title="评估的步骤"></a>评估的步骤</h4><h5 id="1、分析日总访问量"><a href="#1、分析日总访问量" class="headerlink" title="1、分析日总访问量"></a>1、分析日总访问量</h5><p>分析可能的日访问量，一般系统系统都会提供比较真实的访问量数值，基于此，我们需要评估一个活动的访问量；如果是一个新上线的系统，我们也要评估可能的PV、UV值。</p>
<p>产品、运营部门也需要给出可能的访问预期值。</p>
<p>举个例子：</p>
<p>我们活动期间(9点~10点)会推送2000W的应用消息，假设用户实际点进去查看的比列为1/10，那么这个活动期间(1小时)新增的访问量就有 2000W * 1/10= 200W</p>
<h5 id="2、评估平均访问量QPS"><a href="#2、评估平均访问量QPS" class="headerlink" title="2、评估平均访问量QPS"></a>2、评估平均访问量QPS</h5><p>QPS是每秒请求量,假设我们一天正常活动时间一般是11个小时多一点,那一天的时间长度以秒为单位:60*60*11 ≈ 4W,  我们再使用日访问时间再去除以4W总时间即可.</p>
<p>举个例子：</p>
<p>我们上面说的两个小时的活动时间,实际的总访问量最后确实是200W,</p>
<p>那么平均访问量QPS为:200W/(60*60)=555.5 QPS.</p>
<p>一个成熟系统日QPS也可以预估 ,比如 百度首页的日PV数量为 5000W,按照我们说的常规活动时间4W秒算,就是5000W / 4W = 1250 QPS.</p>
<h5 id="3、评估高峰区间的QPS"><a href="#3、评估高峰区间的QPS" class="headerlink" title="3、评估高峰区间的QPS"></a>3、评估高峰区间的QPS</h5><p>我们在做系统容量规划时，不仅仅是考虑平均QPS，最重要的是要承受住高峰区间的QPS，这个数据可以根据业务流量监控的曲线和28法则来评估,我们来看下具体是怎么做的?</p>
<p>3.1 业务流量监控的曲线</p>
<p>以下面这个云系统作为例子：</p>
<p>日均QPS为2900，业务访问趋势图如下图，我们来对峰值QPS做一下预估</p>
<p><img src="https://p.tomhjx.top/Fodidb1DJ5EGoNH05Xuzodg59knu"></p>
<p>从图中可以看出，峰值QPS大概是均值QPS的2.58倍，日均QPS为2900，于是评估出峰值QPS为2900*2.58=7482。</p>
<p>这种是日常流量情况,如果遇到很特别的业务,比如竞拍\抢订\秒杀情况,流量幅度还是比较大的.</p>
<p>3.2 使用二八法则计算</p>
<p>何为二八法则:80%的业务基本都是发生在20%的时间里面,所以有如下:</p>
<p>峰值QPS公式：( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS)</p>
<h5 id="4、评估单实例极限承受的QPS"><a href="#4、评估单实例极限承受的QPS" class="headerlink" title="4、评估单实例极限承受的QPS"></a>4、评估单实例极限承受的QPS</h5><p>可以使用压测(nGrinder 或者 jmeter)方式来获取单个系统实例的QPS极限值,我们团队的标准是当请求响应时间超过2S的时候,已经达到了瓶颈值，并影响使用,需要进行优化和扩容。</p>
<p>我们在一个系统上线前，一般来说是需要进行压力测试,了解她实际的极限值在哪个地方，以我们上面流量图为例子（日平均QPS为2900，峰值QPS为7500），这个系统的架构可能是这样的：</p>
<p><img src="https://p.tomhjx.top/FrZsYefbfU6dEpatuSaY4-wj9u5Z"></p>
<p>1、经由APP和Web的的请求，会经过Nginx均衡到多台Web站点上去。</p>
<p>2、Web集群会调用并落地到Service集群上</p>
<p>3、Service集群向数据层请求数据，正常情况下其中90%会落到Cache集群中</p>
<p>4、Cache集群中不存在（假设10%），会进入DB集群去访问数据库。</p>
<p>我们通过压测数据发现，web层是瓶颈，tomcat压测单个实例只能支持2500的QPS。</p>
<p>Cache集群和DB集群足够强悍，能够轻松应对峰值7500的QPS，按比例分别是7500*0.9=6750 和 7500*0.1=750.</p>
<p>所以我们得到了web单实例极限的QPS是2500。这边需要下调，因为我们不建议让请求响应时长接近2S，最好是1S以内。所以下调至2000。</p>
<h5 id="5、根据线上冗余度最终确认"><a href="#5、根据线上冗余度最终确认" class="headerlink" title="5、根据线上冗余度最终确认"></a>5、根据线上冗余度最终确认</h5><p>通过上面的计算，我们已经得到了峰值QPS是7500，单个实例能够顺畅承载QPS是2000，那么Web集群中至少有4个实例能够承接这样的请求洪峰。</p>
<p>除此之外，其他类型的的容量预估，如数据量、带宽、CPU、MEMORY、DISK等都可以采用类似策略。</p>
<h4 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h4><p>结合项目：如何计算图书系统的QPS、峰值QPS、N个实例和并发数</p>
<p>1、图书预定系统的并发数计算：</p>
<p>1.1、二八法则定理：80%的业务基本都是发生在20% 的时间里面，如系统有早中晚高峰，历经9个小时（早上10点到晚上19点），9*3600=32400。</p>
<p>1.2、获取峰值QPS：公式：( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS)</p>
<p>即 ( 1500000 * 80% ) / ( 32400 * 20% ) = 600000/6480≈185/秒</p>
<p>1.3、并发数 = QPS * 平均响应时间 = 0.5*185 = 92.5 ，矫正为100</p>
<p>1.4、利用343估算法判定 154，向上矫正为200</p>
<table>
<thead>
<tr>
<th><strong>Pessimism 悲观</strong></th>
<th>30%</th>
<th>80</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Normal 标准</strong></td>
<td>40%</td>
<td>100</td>
</tr>
<tr>
<td><strong>Optimism 乐观</strong></td>
<td>30%</td>
<td>300</td>
</tr>
</tbody></table>
<p>最后提供给性能测试QA 的测试标准数据是 建议支持并发 200+，QA最终的测试结果是 该并发下响应时间在 50~100ms</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>系统设计容量评估时机：</p>
<p>1、临时的流量变化：比如 618、双11，新年大促搞活动等场景，预估我们的流量会大涨，甚至到原来的数倍。这时候要做好应对的措施。</p>
<p>2、初始系统容量评估：假设我们开发了某个系统，这个系统初始上线，我们预估他的容量和负载会是多少。</p>
<p>3、容量基数的变化：比如某个系统，他的功能模块越来越多，数据流量越来越大，日活指数越来越高，迎来了第二波的增长曲线。我们原来定好的系统容量渐渐的不满足我们的需求，这时候我们也要重新评估和扩容。</p>
<p>系统设计容量评估的步骤：</p>
<p>1、分析日总访问量：产品、运营的评估和线上数据的收集</p>
<p>2、评估日平均访问量QPS：评估运营时间内的平均QPS</p>
<p>3、评估高峰区间的QPS：流量曲线计算 或 28 法则估算</p>
<p>4、性能压力测试：评估实例能够承受的极限吞吐量</p>
<p>5、根据线上冗余度，与实际的差值进行调整，评估出能承载容量的实际结果值</p>
<p>显然，开头的运动会如果子报名结束后能够根据报名的人数对比，重新做容量设计，提早做好准备，情况就不会那么糟糕。</p>
<p>码字不易，欢迎<a href="javascript:void(0);">关注</a>，欢迎转载</p>
<p>作者：<a href="javascript:void(0);">翁智华</a></p>
<p>出处：<a href="https://www.cnblogs.com/wzh2010/">https://www.cnblogs.com/wzh2010/</a></p>
<p>本文采用「<a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>」知识共享协议进行许可，转载请注明作者及出处。</p>
]]></content>
      <categories>
        <category>运维</category>
        <category>度量</category>
      </categories>
      <tags>
        <tag>转载</tag>
        <tag>度量</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP任意文件上传漏洞（CVE-2015-2348）</title>
    <url>/2016/01/03/PHP%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2015-2348%EF%BC%89/</url>
    <content><![CDATA[<p>安全研究人员今天发布了一个中危漏洞——PHP任意文件上传漏洞（CVE-2015-2348）。<br>在上传文件的时候只判断文件名是合法的文件名就断定这个文件不是恶意文件，这确实会导致其他安全问题。并且在这种情况下，在你自己的文件中检查漏洞很不现实，因为这个漏洞可以绕过你对文件名后缀、文件类型(Content-Type)、Mime type、文件大小等的检查，所以仅仅依靠这些检查是救不了你的。<br>漏洞细节<br>这个漏洞存在于php中一个非常常用的函数中：move_uploaded_files，开发者总是用这个函数来移动上传的文件,这个函数会检查被上传的文件是否是一个合法的文件(是否是通过 HTTP 的 post 机制上传的)，如果是合法的文件，则将它一定到指定目录中。<br>例子：<br>move_uploaded_file ( string $filename , string $destination )<br>这里的问题是，可以在文件名中插入空字符(之前多次修复过这个漏洞，比如CVE-2006-7243)，利用插入空字符的方式，攻击者可以上传任意文件，引起远程代码执行漏洞等。<br>我这里用DVWA来演示这个例子，DVWA级别最高的一题中因为种种原因不是很容易通过，意在告诉开发者如何去开发更安全的文件上传组件。让我们来看看这个例子：<br>代码地址：<a href="https://github.com/RandomStorm/DVWA/blob/master/vulnerabilities/upload/source/high.php">https://github.com/RandomStorm/DVWA/blob/master/vulnerabilities/upload/source/high.php</a><br>代码片段：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]; </span><br><span class="line"><span class="variable">$uploaded_ext</span> = substr(<span class="variable">$uploaded_name</span>, strrpos(<span class="variable">$uploaded_name</span>, <span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>); <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;size&#x27;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="variable">$uploaded_ext</span> == <span class="string">&quot;jpg&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;JPG&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;jpeg&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;JPEG&quot;</span>) &amp;&amp; (<span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span>))&#123; <span class="keyword">if</span>(!move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$target_path</span>)) &#123; </span><br><span class="line"></span><br><span class="line"><span class="variable">$html</span> .= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$html</span> .= <span class="string">&#x27;Your image was not uploaded.&#x27;</span>; </span><br><span class="line"><span class="variable">$html</span> .= <span class="string">&#x27;&#x27;</span>; &#125; </span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line"><span class="variable">$html</span> .= <span class="variable">$target_path</span> . <span class="string">&#x27; succesfully uploaded!&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>.<br>.<br>这段代码有好多个漏洞，比如XSCH, XSS等，但是没有RCE这种严重的漏洞，因为从PHP 5.3.1开始，空字符的问题已经被修复了。这里的问题是，DVWA将用户上传的name参数传递给了move_upload_file()函数，那么 php 执行的操作可能就是这样子的：<br>move_uploaded_file($_FILES[‘name’][‘tmp_name’],”/file.php\x00.jpg”);<br>这本应该创建一个名为file.php\x00.jpg的文件，但实际上创建的文件是file.php。</p>
<p>这样，就绕过了代码中对后缀名的校验，并且事实证明GD库中又很多其他函数也存在这个问题(比如getimagesize(), imagecreatefromjpeg()…等)，可以看这个例子。<br>如果你机器的php版本在 5.4.39, 5.5.x – 5.5.23, 或者 5.6.x – 5.6.7，可以通过检查文件名中是否有\x00字符来解决本文中所述的问题。<br>安全建议<br>如果你的机器上存在这个漏洞，建议使用随机字符串重命名文件名，而不是使用用户上传上来的name参数的值。</p>
<p><a href="http://www.freebuf.com/vuls/62811.html">http://www.freebuf.com/vuls/62811.html</a></p>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL Select实测</title>
    <url>/2016/01/03/MySQL-Select%E5%AE%9E%E6%B5%8B/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `case_article` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `mid` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `title` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `n_click` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `publishtime` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `status` TINYINT(<span class="number">3</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    INDEX `n_click` (`n_click`),</span><br><span class="line">    INDEX `publishtime` (`publishtime`),</span><br><span class="line">    INDEX `mid` (`mid`)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;utf8_general_ci&#x27;</span></span><br><span class="line">ENGINE<span class="operator">=</span>MyISAM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `case_member` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `createtime` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    `status` TINYINT(<span class="number">3</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    INDEX `createtime` (`createtime`)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;utf8_general_ci&#x27;</span></span><br><span class="line">ENGINE<span class="operator">=</span>MyISAM;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>; #开启运行记录日志</span><br><span class="line">#<span class="keyword">show</span> profiles;#查询运行记录</span><br><span class="line">#reset query cache;#清空查询缓存</span><br><span class="line">#flush tables;</span><br><span class="line">#<span class="keyword">set</span> session query_cache_type <span class="operator">=</span> <span class="number">0</span>;临时禁用查询缓存</span><br><span class="line">#<span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%query_cache%&#x27;</span>;</span><br><span class="line">#<span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%Qcache%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="联表查询"><a href="#联表查询" class="headerlink" title="联表查询"></a>联表查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">inner</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows    | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 5000000 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |       1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line"></span><br><span class="line">5000000 rows in set (31.00355250 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows    | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 5000000 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |       1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line"></span><br><span class="line">5000000 rows in set (24.35417500 sec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="限制小记录数联表查询"><a href="#限制小记录数联表查询" class="headerlink" title="限制小记录数联表查询"></a>限制小记录数联表查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id <span class="keyword">desc</span> limit <span class="number">100000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows    | Extra                       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 5000000 | Using where; Using filesort |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |       1 | Using where                 |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line"></span><br><span class="line">100000 rows in set (3.17512150 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">inner</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id <span class="keyword">desc</span> limit <span class="number">100000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows    | Extra                       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 5000000 | Using where; Using filesort |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |       1 | Using where                 |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-----------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100000 rows in set (3.46428075 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总记录数5000000，查询超过47853-a不用索引"><a href="#总记录数5000000，查询超过47853-a不用索引" class="headerlink" title="总记录数5000000，查询超过47853,a不用索引"></a>总记录数5000000，查询超过47853,a不用索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> a.id <span class="keyword">desc</span> limit <span class="number">47853</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+-------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows  | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+-------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | index  | mid           | PRIMARY | 4       | NULL       | 47853 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |     1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+-------+-------------+</span><br><span class="line"></span><br><span class="line">47853 rows in set (0.30755625 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.id,b.name <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span>  case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> a.`status`<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b.`status`<span class="operator">=</span><span class="number">1</span> limit <span class="number">47853</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | ref        | rows    | Extra       |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | ALL    | mid           | NULL    | NULL    | NULL       | 5000000 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | eq_ref | PRIMARY       | PRIMARY | 4       | test.a.mid |       1 | Using where |</span><br><span class="line">+----+-------------+-------+--------+---------------+---------+---------+------------+---------+-------------+</span><br><span class="line"></span><br><span class="line">47853 rows in set (0.23440550 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span> <span class="number">1000000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows    | Extra       |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ALL  | mid           | NULL | NULL    | NULL | 5000000 | Using where |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line"></span><br><span class="line">2500814 rows in set (1.75442150 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span> <span class="number">1000000</span> limit <span class="number">2500814</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows    | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 2625654 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+---------+-------------+</span><br><span class="line"></span><br><span class="line">2500814 rows in set (4.93114550 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span> <span class="number">1900000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 487187 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line"></span><br><span class="line">249909 rows in set (0.53250450 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span> <span class="number">1900000</span> limit <span class="number">249909</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 487187 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line"></span><br><span class="line">249909 rows in set (0.52184200 sec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id,mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span><span class="number">1900000</span> <span class="keyword">or</span> mid <span class="operator">&lt;</span><span class="number">1000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 256711 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line"></span><br><span class="line">252507 rows in set (0.58568825 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="keyword">select</span> id,mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span><span class="number">1900000</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> id,mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&lt;</span><span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+--------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type  | table        | type  | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+--------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | PRIMARY      | case_article | range | mid           | mid  | 4       | NULL | 253595 | Using where |</span><br><span class="line">|  2 | UNION        | case_article | range | mid           | mid  | 4       | NULL |   3116 | Using where |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2&gt;   | ALL   | NULL          | NULL | NULL    | NULL |   NULL |             |</span><br><span class="line">+----+--------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line"></span><br><span class="line">252507 rows in set (0.63561700 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&gt;</span><span class="number">1900000</span> <span class="keyword">or</span> mid <span class="operator">&lt;</span><span class="number">1000</span> <span class="keyword">group</span> <span class="keyword">by</span> mid;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 256711 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+--------+-------------+</span><br><span class="line"></span><br><span class="line">92702 rows in set (0.52456750 sec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="title无做索引"><a href="#title无做索引" class="headerlink" title="title无做索引"></a>title无做索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="operator">=</span> <span class="string">&#x27;(10).title&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows    | Extra       |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ALL  | NULL          | NULL | NULL    | NULL | 5000000 | Using where |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+-------------+</span><br><span class="line"></span><br><span class="line">1 row in set (1.23551125 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="title做索引"><a href="#title做索引" class="headerlink" title="title做索引"></a>title做索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="operator">=</span> <span class="string">&#x27;(10).title&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+-------+---------+-------+------+-------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key   | key_len | ref   | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+------+---------------+-------+---------+-------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ref  | title         | title | 767     | const |    1 | Using where |</span><br><span class="line">+----+-------------+--------------+------+---------------+-------+---------+-------+------+-------------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00026075 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="operator">=</span> <span class="string">&#x27;(10).title&#x27;</span> <span class="keyword">or</span> title <span class="operator">=</span> <span class="string">&#x27;(40).title&#x27;</span> <span class="keyword">or</span> title <span class="operator">=</span> <span class="string">&#x27;(50).title&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key   | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | title         | title | 767     | NULL |    3 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00074250 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="keyword">in</span> (<span class="string">&#x27;(10).title&#x27;</span>,<span class="string">&#x27;(40).title&#x27;</span>,<span class="string">&#x27;(50).title&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key   | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | title         | title | 767     | NULL |    3 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00074150 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="keyword">like</span> <span class="string">&#x27;(10).title&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key   | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | title         | title | 767     | NULL |    1 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00042425 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">where</span> title <span class="keyword">like</span> <span class="string">&#x27;%(10).title&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key   | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | title         | title | 767     | NULL |    1 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+-------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">1 row in set (1.96752275 sec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="group-by与union方式查询比较"><a href="#group-by与union方式查询比较" class="headerlink" title="group by与union方式查询比较"></a>group by与union方式查询比较</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">12</span>,<span class="number">13</span>) <span class="keyword">group</span> <span class="keyword">by</span> mid;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL |    5 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00056525 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">2</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">12</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(id),mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">=</span><span class="number">13</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+--------------+--------------+------+---------------+------+---------+-------+------+-------+</span><br><span class="line">| id | select_type  | table        | type | possible_keys | key  | key_len | ref   | rows | Extra |</span><br><span class="line">+----+--------------+--------------+------+---------------+------+---------+-------+------+-------+</span><br><span class="line">|  1 | PRIMARY      | case_article | ref  | mid           | mid  | 4       | const |    3 |       |</span><br><span class="line">|  2 | UNION        | case_article | ref  | mid           | mid  | 4       | const |    1 |       |</span><br><span class="line">|  3 | UNION        | case_article | ref  | mid           | mid  | 4       | const |    1 |       |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2,3&gt; | ALL  | NULL          | NULL | NULL    | NULL  | NULL |       |</span><br><span class="line">+----+--------------+--------------+------+---------------+------+---------+-------+------+-------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00045425 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> case_article <span class="keyword">as</span> b <span class="keyword">on</span> a.id <span class="operator">=</span> b.mid <span class="keyword">where</span> a.createtime <span class="operator">=</span> <span class="number">1406038366</span> <span class="keyword">or</span> a.createtime <span class="operator">=</span> <span class="number">1406038367</span> <span class="keyword">group</span> <span class="keyword">by</span> a.createtime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line">| id | select_type | table | type  | possible_keys | key        | key_len | ref       | rows | Extra       |</span><br><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | range | createtime    | createtime | 4       | NULL      |   15 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | ref   | mid           | mid        | 4       | test.a.id |   19 |             |</span><br><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00045750 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(a.id),b.createtime <span class="keyword">from</span> case_article <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> case_member <span class="keyword">as</span> b <span class="keyword">on</span> a.mid <span class="operator">=</span> b.id <span class="keyword">where</span> b.createtime <span class="operator">=</span> <span class="number">1406038366</span> <span class="keyword">or</span> b.createtime <span class="operator">=</span> <span class="number">1406038367</span> <span class="keyword">group</span> <span class="keyword">by</span> b.createtime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line">| id | select_type | table | type  | possible_keys | key        | key_len | ref       | rows | Extra       |</span><br><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | range | createtime    | createtime | 4       | NULL      |   15 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | ref   | mid           | mid        | 4       | test.a.id |   19 |             |</span><br><span class="line">+----+-------------+-------+-------+---------------+------------+---------+-----------+------+-------------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00068375 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> case_article <span class="keyword">as</span> b <span class="keyword">on</span> a.id <span class="operator">=</span> b.mid <span class="keyword">where</span> a.createtime <span class="operator">=</span> <span class="number">1406038366</span>) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> case_article <span class="keyword">as</span> b <span class="keyword">on</span> a.id <span class="operator">=</span> b.mid <span class="keyword">where</span> a.createtime <span class="operator">=</span> <span class="number">1406038367</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+--------------+------------+------+---------------+------------+---------+-----------+------+-------+</span><br><span class="line">| id | select_type  | table      | type | possible_keys | key        | key_len | ref       | rows | Extra |</span><br><span class="line">+----+--------------+------------+------+---------------+------------+---------+-----------+------+-------+</span><br><span class="line">|  1 | PRIMARY      | a          | ref  | createtime    | createtime | 4       | const     |    8 |       |</span><br><span class="line">|  1 | PRIMARY      | b          | ref  | mid           | mid        | 4       | test.a.id |   19 |       |</span><br><span class="line">|  2 | UNION        | a          | ref  | createtime    | createtime | 4       | const     |    7 |       |</span><br><span class="line">|  2 | UNION        | b          | ref  | mid           | mid        | 4       | test.a.id |   19 |       |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2&gt; | ALL  | NULL          | NULL       | NULL    | NULL      | NULL |       |</span><br><span class="line">+----+--------------+------------+------+---------------+------------+---------+-----------+------+-------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00085850 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a,case_article <span class="keyword">as</span> b <span class="keyword">where</span> a.id <span class="operator">=</span> b.mid <span class="keyword">and</span> (a.createtime <span class="operator">=</span> <span class="number">1406038366</span> <span class="keyword">or</span> a.createtime <span class="operator">=</span> <span class="number">1406038367</span>) <span class="keyword">group</span> <span class="keyword">by</span> a.createtime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line">| id | select_type | table | type  | possible_keys      | key        | key_len | ref       | rows | Extra       |</span><br><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | range | PRIMARY,createtime | createtime | 4       | NULL      |   15 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | ref   | mid                | mid        | 4       | test.a.id |   19 |             |</span><br><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00057425 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a,case_article <span class="keyword">as</span> b <span class="keyword">where</span> a.id <span class="operator">=</span> b.mid <span class="keyword">and</span> (a.createtime <span class="operator">=</span> <span class="number">1406038366</span>)) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a,case_article <span class="keyword">as</span> b <span class="keyword">where</span> a.id <span class="operator">=</span> b.mid <span class="keyword">and</span> (a.createtime <span class="operator">=</span> <span class="number">1406038367</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+--------------+------------+------+--------------------+------------+---------+-----------+------+-------+</span><br><span class="line">| id | select_type  | table      | type | possible_keys      | key        | key_len | ref       | rows | Extra |</span><br><span class="line">+----+--------------+------------+------+--------------------+------------+---------+-----------+------+-------+</span><br><span class="line">|  1 | PRIMARY      | a          | ref  | PRIMARY,createtime | createtime | 4       | const     |    8 |       |</span><br><span class="line">|  1 | PRIMARY      | b          | ref  | mid                | mid        | 4       | test.a.id |   19 |       |</span><br><span class="line">|  2 | UNION        | a          | ref  | PRIMARY,createtime | createtime | 4       | const     |    7 |       |</span><br><span class="line">|  2 | UNION        | b          | ref  | mid                | mid        | 4       | test.a.id |   19 |       |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2&gt; | ALL  | NULL               | NULL       | NULL    | NULL      | NULL |       |</span><br><span class="line">+----+--------------+------------+------+--------------------+------------+---------+-----------+------+-------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00053550 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(b.id),a.createtime <span class="keyword">from</span> case_member <span class="keyword">as</span> a <span class="keyword">inner</span> <span class="keyword">join</span> case_article <span class="keyword">as</span> b <span class="keyword">on</span> a.id <span class="operator">=</span> b.mid <span class="keyword">where</span> a.createtime <span class="operator">=</span> <span class="number">1406038366</span> <span class="keyword">or</span> a.createtime <span class="operator">=</span> <span class="number">1406038367</span> <span class="keyword">group</span> <span class="keyword">by</span> a.createtime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line">| id | select_type | table | type  | possible_keys      | key        | key_len | ref       | rows | Extra       |</span><br><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | a     | range | PRIMARY,createtime | createtime | 4       | NULL      |   15 | Using where |</span><br><span class="line">|  1 | SIMPLE      | b     | ref   | mid                | mid        | 4       | test.a.id |   19 |             |</span><br><span class="line">+----+-------------+-------+-------+--------------------+------------+---------+-----------+------+-------------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00046050 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="查询单条记录"><a href="#查询单条记录" class="headerlink" title="查询单条记录"></a>查询单条记录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article limit <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+---------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key     | key_len | ref  | rows    | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+---------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | index | NULL          | PRIMARY | 4       | NULL | 5000000 | Using index |</span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+---------+-------------+</span><br><span class="line"></span><br><span class="line">1 rows in set (0.00040625 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">order</span> <span class="keyword">by</span> id <span class="keyword">asc</span> limit <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | index | NULL          | PRIMARY | 4       | NULL |    1 | Using index |</span><br><span class="line">+----+-------------+--------------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">1 rows in set (0.00034825 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> case_article <span class="keyword">order</span> <span class="keyword">by</span> mid <span class="keyword">asc</span> limit <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | case_article | index | NULL          | mid  | 4       | NULL |    1 |       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------+</span><br><span class="line"></span><br><span class="line">1 rows in set (0.00036500 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> id,mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="keyword">between</span>  <span class="number">1000</span> <span class="keyword">and</span> <span class="number">1500</span> <span class="keyword">order</span> <span class="keyword">by</span> mid <span class="keyword">asc</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL | 1521 | Using where |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+-------------+</span><br><span class="line"></span><br><span class="line">1304 rows in set (0.04822150 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h3 id="查询最近发布文章的用户列表"><a href="#查询最近发布文章的用户列表" class="headerlink" title="查询最近发布文章的用户列表"></a>查询最近发布文章的用户列表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> mid,<span class="built_in">max</span>(publishtime) <span class="keyword">as</span> max_publishtime <span class="keyword">from</span> case_article <span class="keyword">group</span> <span class="keyword">by</span> mid <span class="keyword">order</span> <span class="keyword">by</span> max_publishtime;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows    | Extra                           |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ALL  | NULL          | NULL | NULL    | NULL | 5000000 | Using temporary; Using filesort |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line"></span><br><span class="line">1835947 rows in set (52.97973200 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">select</span> mid,<span class="built_in">max</span>(publishtime) <span class="keyword">as</span> max_publishtime <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="keyword">in</span> (<span class="number">1000</span>,<span class="number">10000</span>,<span class="number">100000</span>) <span class="keyword">group</span> <span class="keyword">by</span> mid <span class="keyword">order</span> <span class="keyword">by</span> max_publishtime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+----------------------------------------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra                                        |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+----------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL |    5 | Using where; Using temporary; Using filesort |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+----------------------------------------------+</span><br><span class="line"></span><br><span class="line">2 rows in set (0.00034525 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> mid,<span class="built_in">max</span>(publishtime) <span class="keyword">as</span> max_publishtime <span class="keyword">from</span> case_article <span class="keyword">group</span> <span class="keyword">by</span> mid;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows    | Extra                           |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ALL  | NULL          | NULL | NULL    | NULL | 5000000 | Using temporary; Using filesort |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1835947 rows in set (47.17097075 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="查询最近发布文章的前10用户列表"><a href="#查询最近发布文章的前10用户列表" class="headerlink" title="查询最近发布文章的前10用户列表"></a>查询最近发布文章的前10用户列表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> mid,<span class="built_in">max</span>(publishtime) <span class="keyword">as</span> max_publishtime <span class="keyword">from</span> case_article <span class="keyword">group</span> <span class="keyword">by</span> mid <span class="keyword">order</span> <span class="keyword">by</span> max_publishtime <span class="keyword">desc</span> limit <span class="number">10</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows    | Extra                           |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | ALL  | NULL          | NULL | NULL    | NULL | 5000000 | Using temporary; Using filesort |</span><br><span class="line">+----+-------------+--------------+------+---------------+------+---------+------+---------+---------------------------------+</span><br><span class="line"></span><br><span class="line">10 rows in set (47.24095550 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="统计mid数"><a href="#统计mid数" class="headerlink" title="统计mid数"></a>统计mid数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> mid) <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&lt;</span> <span class="number">290000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra                                 |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | case_article | range | mid           | mid  | 4       | NULL |    1 | Using where; Using index for group-by |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.40 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> (<span class="keyword">select</span> mid <span class="keyword">from</span> case_article <span class="keyword">where</span> mid <span class="operator">&lt;</span> <span class="number">290000</span> <span class="keyword">group</span> <span class="keyword">by</span> mid) <span class="keyword">as</span> a;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line">| id | select_type | table        | type  | possible_keys | key  | key_len | ref  | rows | Extra                                 |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line">|  1 | PRIMARY     | NULL         | NULL  | NULL          | NULL | NULL    | NULL | NULL | Select tables optimized away          |</span><br><span class="line">|  2 | DERIVED     | case_article | range | mid           | mid  | 4       | NULL |    2 | Using where; Using index for group-by |</span><br><span class="line">+----+-------------+--------------+-------+---------------+------+---------+------+------+---------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 row in set (0.46 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>原创</tag>
        <tag>select</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL事务的实现原理</title>
    <url>/2020/09/27/MySQL%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h2><p>相信大家都用过事务以及了解他的特点，如原子性(Atomicity),一致性(Consistency),隔离型(Isolation)以及持久性(Durability)等。今天想跟大家一起研究下事务内部到底是怎么实现的，在讲解前我想先抛出个问题：</p>
<blockquote>
<p>事务想要做到什么效果？</p>
</blockquote>
<p>按我理解，无非是要做到可靠性以及并发处理</p>
<ul>
<li><p>  可靠性：数据库要保证当insert或update操作时抛异常或者数据库crash的时候需要保障数据的操作前后的一致，想要做到这个，我需要知道我修改之前和修改之后的状态，所以就有了undo log和redo log。</p>
</li>
<li><p>  并发处理：也就是说当多个并发请求过来，并且其中有一个请求是对数据修改操作的时候会有影响，为了避免读到脏数据，所以需要对事务之间的读写进行隔离，至于隔离到啥程度得看业务系统的场景了，实现这个就得用MySQL 的隔离级别。</p>
</li>
</ul>
<p>下面我首先讲实现事务功能的三个技术，分别是日志文件(redo log 和 undo log)，锁技术以及MVCC，然后再讲事务的实现原理，包括原子性是怎么实现的，隔离型是怎么实现的等等。最后在做一个总结，希望大家能够耐心看完</p>
<ul>
<li><p>  redo log与undo log介绍</p>
</li>
<li><p>  mysql锁技术以及MVCC基础</p>
</li>
<li><p>  事务的实现原理</p>
</li>
<li><p>  总结</p>
</li>
</ul>
<h2 id="二、-redo-log-与-undo-log介绍"><a href="#二、-redo-log-与-undo-log介绍" class="headerlink" title="二、 redo log 与 undo log介绍"></a>二、 redo log 与 undo log介绍</h2><h3 id="1-redo-log"><a href="#1-redo-log" class="headerlink" title="1. redo log"></a>1. redo log</h3><h4 id="什么是redo-log"><a href="#什么是redo-log" class="headerlink" title="什么是redo log ?"></a>什么是redo log ?</h4><p>redo log叫做重做日志，是用来实现事务的持久性。该日志文件由两部分组成：重做日志缓冲（redo log buffer）以及重做日志文件（redo log）,前者是在内存中，后者在磁盘中。</p>
<p>当事务提交之后会把所有修改信息都会存到该日志中。假设有个表叫做tb1(id,username) 现在要插入数据（3，ceshi）</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p>
<pre><code>    `start transaction;
</code></pre>
<p>select balance from bank where name=”zhangsan”;<br>// 生成 重做日志 balance=600<br>update bank<br>            set balance = balance - 400;<br>// 生成 重做日志 amount=400<br>update finance set amount = amount + 400;<br>commit;<br>`</p>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLrSxAoG4x1FXl0zkofq8WvnoT4etDYlJBCgsiaNm0OA0ntOa3bfd9n3jw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></h4><h4 id="redo-log-有什么作用？"><a href="#redo-log-有什么作用？" class="headerlink" title="redo log 有什么作用？"></a>redo log 有什么作用？</h4><p>mysql 为了提升性能不会把每次的修改都实时同步到磁盘，而是会先存到Boffer Pool(缓冲池)里头，把这个当作缓存来用。然后使用后台线程去做缓冲池和磁盘之间的同步。</p>
<p>那么问题来了，如果还没来的同步的时候宕机或断电了怎么办？还没来得及执行上面图中红色的操作。这样会导致丢部分已提交事务的修改信息！</p>
<p>所以引入了redo log来记录已成功提交事务的修改信息，并且会把redo log持久化到磁盘，系统重启之后在读取redo log恢复最新数据。</p>
<p>总结：</p>
<blockquote>
<p>redo log是用来恢复数据的 用于保障，已提交事务的持久化特性</p>
</blockquote>
<h3 id="2-undo-log"><a href="#2-undo-log" class="headerlink" title="2.undo log"></a>2.undo log</h3><h4 id="什么是-undo-log-？"><a href="#什么是-undo-log-？" class="headerlink" title="什么是 undo log ？"></a>什么是 undo log ？</h4><p>undo log 叫做回滚日志，用于记录数据被修改前的信息。他正好跟前面所说的重做日志所记录的相反，重做日志记录数据被修改后的信息。undo log主要记录的是数据的逻辑变化，为了在发生错误时回滚之前的操作，需要将之前的操作都记录下来，然后在发生错误时才可以回滚。</p>
<p>还用上面那两张表</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLr1ZNia36F30BXn4VSicdVxIdwmkmsOicuhicvhKblAgLCUpk4WU3xENY8SQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p>每次写入数据或者修改数据之前都会把修改前的信息记录到 undo log。</p>
<h4 id="undo-log-有什么作用？"><a href="#undo-log-有什么作用？" class="headerlink" title="undo log 有什么作用？"></a>undo log 有什么作用？</h4><p>undo log 记录事务修改之前版本的数据信息，因此假如由于系统错误或者rollback操作而回滚的话可以根据undo log的信息来进行回滚到没被修改前的状态。</p>
<p>总结：</p>
<blockquote>
<p>undo log是用来回滚数据的用于保障 未提交事务的原子性</p>
</blockquote>
<h2 id="三、mysql锁技术以及MVCC基础"><a href="#三、mysql锁技术以及MVCC基础" class="headerlink" title="三、mysql锁技术以及MVCC基础"></a>三、mysql锁技术以及MVCC基础</h2><h3 id="1-mysql锁技术"><a href="#1-mysql锁技术" class="headerlink" title="1. mysql锁技术"></a>1. mysql锁技术</h3><p>当有多个请求来读取表中的数据时可以不采取任何操作，但是多个请求里有读请求，又有修改请求时必须有一种措施来进行并发控制。不然很有可能会造成不一致。</p>
<h4 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h4><p>解决上述问题很简单，只需用两种锁的组合来对读写请求进行控制即可，这两种锁被称为：</p>
<p><strong>共享锁(shared lock),又叫做”读锁”</strong></p>
<p>读锁是可以共享的，或者说多个读请求可以共享一把锁读数据，不会造成阻塞。</p>
<p><strong>排他锁(exclusive lock),又叫做”写锁”</strong></p>
<p>写锁会排斥其他所有获取锁的请求，一直阻塞，直到写入完成释放锁。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLrK9iaNiaGZMGiblmrg7AoiaP5xgOODGsNic0tOCqIYdukfISDVAwr0bPROcA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p>总结：通过读写锁，可以做到读读可以并行，但是不能做到写读，写写并行 事务的隔离性就是根据读写锁来实现的！！！这个后面再说。</p>
<h3 id="2-MVCC基础"><a href="#2-MVCC基础" class="headerlink" title="2. MVCC基础"></a>2. MVCC基础</h3><p>MVCC (MultiVersion Concurrency Control) 叫做多版本并发控制。</p>
<blockquote>
<p>InnoDB的 MVCC ，是通过在每行记录的后面保存两个隐藏的列来实现的。这两个列， 一个保存了行的创建时间，一个保存了行的过期时间，当然存储的并不是实际的时间值，而是系统版本号。</p>
</blockquote>
<p>以上片段摘自《高性能Mysql》这本书对MVCC的定义。他的主要实现思想是通过数据多版本来做到读写分离。从而实现不加锁读进而做到读写并行。</p>
<p>MVCC在mysql中的实现依赖的是undo log与read view</p>
<ul>
<li><p>  undo log :undo log 中记录某行数据的多个版本的数据。</p>
</li>
<li><p>  read view :用来判断当前版本数据的可见性</p>
</li>
</ul>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLraAusmFF6PibQv7yMqK4VXo3SBhZPMkYibib22CQNIRv4pbuLb6xA4cf4A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<h2 id="四、事务的实现"><a href="#四、事务的实现" class="headerlink" title="四、事务的实现"></a>四、事务的实现</h2><p>前面讲的重做日志，回滚日志以及锁技术就是实现事务的基础。</p>
<ul>
<li><p>  事务的原子性是通过 undo log 来实现的</p>
</li>
<li><p>  事务的持久性性是通过 redo log 来实现的</p>
</li>
<li><p>  事务的隔离性是通过 (读写锁+MVCC)来实现的</p>
</li>
<li><p>  而事务的终极大 boss 一致性是通过原子性，持久性，隔离性来实现的！！！</p>
</li>
</ul>
<p>原子性，持久性，隔离性折腾半天的目的也是为了保障数据的一致性！</p>
<p>总之，ACID只是个概念，事务最终目的是要保障数据的可靠性，一致性。</p>
<h3 id="1-原子性的实现"><a href="#1-原子性的实现" class="headerlink" title="1.原子性的实现"></a>1.原子性的实现</h3><p>什么是原子性：</p>
<p>一个事务必须被视为不可分割的最小工作单位，一个事务中的所有操作要么全部成功提交，要么全部失败回滚，对于一个事务来说不可能只执行其中的部分操作，这就是事务的原子性。</p>
<p>上面这段话取自《高性能MySQL》这本书对原子性的定义，原子性可以概括为就是要实现要么全部失败，要么全部成功。</p>
<p>以上概念相信大家伙儿都了解，那么数据库是怎么实现的呢？就是通过回滚操作。</p>
<p>所谓回滚操作就是当发生错误异常或者显式的执行rollback语句时需要把数据还原到原先的模样，所以这时候就需要用到undo log来进行回滚，接下来看一下undo log在实现事务原子性时怎么发挥作用的</p>
<h4 id="1-1-undo-log-的生成"><a href="#1-1-undo-log-的生成" class="headerlink" title="1.1 undo log 的生成"></a>1.1 undo log 的生成</h4><p>假设有两个表 bank和finance，表中原始数据如图所示，当进行插入，删除以及更新操作时生成的undo log如下面图所示：</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p>
<p>从上图可以了解到数据的变更都伴随着回滚日志的产生：(1) 产生了被修改前数据(zhangsan,1000) 的回滚日志</p>
<p>(2) 产生了被修改前数据(zhangsan,0) 的回滚日志</p>
<p>根据上面流程可以得出如下结论：</p>
<ol>
<li><p> 每条数据变更(insert/update/delete)操作都伴随一条undo log的生成,并且回滚日志必须先于数据持久化到磁盘上</p>
</li>
<li><p> 所谓的回滚就是根据回滚日志做逆向操作，比如delete的逆向操作为insert，insert的逆向操作为delete，update的逆向为update等。</p>
</li>
</ol>
<blockquote>
<p>思考：为什么先写日志后写数据库？---稍后做解释</p>
</blockquote>
<h4 id="1-2-根据undo-log-进行回滚"><a href="#1-2-根据undo-log-进行回滚" class="headerlink" title="1.2 根据undo log 进行回滚"></a>1.2 根据undo log 进行回滚</h4><p>为了做到同时成功或者失败，当系统发生错误或者执行rollback操作时需要根据undo log 进行回滚</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLr6tmw6HRKC7OWyd8Ky7U6iaibS70E9GUdhul5xNTOU6C3IaeCs1Qgflxg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p>回滚操作就是要还原到原来的状态，undo log记录了数据被修改前的信息以及新增和被删除的数据信息，根据undo log生成回滚语句，比如：</p>
<ul>
<li><p>  如果在回滚日志里有新增数据记录，则生成删除该条的语句</p>
</li>
<li><p>  如果在回滚日志里有删除数据记录，则生成生成该条的语句</p>
</li>
<li><p>  如果在回滚日志里有修改数据记录，则生成修改到原先数据的语句</p>
</li>
</ul>
<h3 id="2-持久性的实现"><a href="#2-持久性的实现" class="headerlink" title="2.持久性的实现"></a>2.持久性的实现</h3><p>事务一旦提交，其所作做的修改会永久保存到数据库中，此时即使系统崩溃修改的数据也不会丢失。</p>
<p>先了解一下MySQL的数据存储机制，MySQL的表数据是存放在磁盘上的，因此想要存取的时候都要经历磁盘IO,然而即使是使用SSD磁盘IO也是非常消耗性能的。</p>
<p>为此，为了提升性能InnoDB提供了缓冲池(Buffer Pool)，Buffer Pool中包含了磁盘数据页的映射，可以当做缓存来使用：</p>
<ul>
<li><p>  读数据：会首先从缓冲池中读取，如果缓冲池中没有，则从磁盘读取在放入缓冲池；</p>
</li>
<li><p>  写数据：会首先写入缓冲池，缓冲池中的数据会定期同步到磁盘中；</p>
</li>
</ul>
<p>上面这种缓冲池的措施虽然在性能方面带来了质的飞跃，但是它也带来了新的问题，当MySQL系统宕机，断电的时候可能会丢数据！！！</p>
<p>因为我们的数据已经提交了，但此时是在缓冲池里头，还没来得及在磁盘持久化，所以我们急需一种机制需要存一下已提交事务的数据，为恢复数据使用。</p>
<p>于是 redo log就派上用场了。下面看下redo log是什么时候产生的。</p>
<p>事务开始之后就产生redo log，redo log的落盘并不是随着事务的提交才写入的，而是在事务的执行过程中，便开始写入redo log文件中。</p>
<p>既然redo log也需要存储，也涉及磁盘IO为啥还用它？</p>
<ul>
<li><p>  redo log 的存储是顺序存储，而缓存同步是随机操作。</p>
</li>
<li><p>  缓存同步是以数据页为单位的，每次传输的数据大小大于redo log。</p>
</li>
</ul>
<h3 id="3-隔离性实现"><a href="#3-隔离性实现" class="headerlink" title="3.隔离性实现"></a>3.隔离性实现</h3><p>隔离性是事务ACID特性里最复杂的一个。在SQL标准里定义了四种隔离级别，每一种级别都规定一个事务中的修改，哪些是事务之间可见的，哪些是不可见的。</p>
<p>级别越低的隔离级别可以执行越高的并发，但同时实现复杂度以及开销也越大。</p>
<p>Mysql 隔离级别有以下四种（级别由低到高）：</p>
<ul>
<li><p>  READ UNCOMMITED (未提交读)</p>
</li>
<li><p>  READ COMMITED (提交读)</p>
</li>
<li><p>  REPEATABLE READ (可重复读)</p>
</li>
<li><p>  SERIALIZABLE (可重复读)</p>
</li>
</ul>
<p>只要彻底理解了隔离级别以及他的实现原理就相当于理解了ACID里的隔离型。前面说过原子性，隔离性，持久性的目的都是为了要做到一致性，但隔离型跟其他两个有所区别，原子性和持久性是为了要实现数据的可性保障靠，比如要做到宕机后的恢复，以及错误后的回滚。</p>
<p>那么隔离性是要做到什么呢？隔离性是要管理多个并发读写请求的访问顺序。这种顺序包括串行或者是并行</p>
<p>说明一点，写请求不仅仅是指insert操作，又包括update操作。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLrV8Res2dxabzIB08TnRribvas5cCXzvTb7h5xibzk3dWoLowiaibasQrOnA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p>总之，从隔离性的实现可以看出这是一场数据的可靠性与性能之间的权衡。</p>
<ul>
<li><p>  可靠性性高的，并发性能低(比如 Serializable)</p>
</li>
<li><p>  可靠性低的，并发性能高(比如 Read Uncommited)</p>
</li>
</ul>
<h4 id="READ-UNCOMMITTED"><a href="#READ-UNCOMMITTED" class="headerlink" title="READ UNCOMMITTED"></a>READ UNCOMMITTED</h4><p>在READ UNCOMMITTED隔离级别下，事务中的修改即使还没提交，对其他事务是可见的。事务可以读取未提交的数据，造成脏读。</p>
<p>因为读不会加任何锁，所以写操作在读的过程中修改数据，所以会造成脏读。好处是可以提升并发处理性能，能做到读写并行。</p>
<p>换句话说，读的操作不能排斥写请求。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLrmVeibFxx7sKWVLYzWuRAITTDpvOSUunkumc8Bag73icgGa5V8iasCHUOQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<ul>
<li><p>  优点：读写并行，性能高</p>
</li>
<li><p>  缺点：造成脏读</p>
</li>
</ul>
<h4 id="READ-COMMITTED"><a href="#READ-COMMITTED" class="headerlink" title="READ COMMITTED"></a>READ COMMITTED</h4><p>一个事务的修改在他提交之前的所有修改，对其他事务都是不可见的。其他事务能读到已提交的修改变化。在很多场景下这种逻辑是可以接受的。</p>
<p>InnoDB在 READ COMMITTED，使用排它锁,读取数据不加锁而是使用了MVCC机制。或者换句话说他采用了读写分离机制。</p>
<p>但是该级别会产生不可重读以及幻读问题。往期： <a href="http://mp.weixin.qq.com/s?__biz=MzIyNDU2ODA4OQ==&mid=2247484532&idx=1&sn=1c243934507d79db4f76de8ed0e5727f&chksm=e80db202df7a3b14fe7077b0fe5ec4de4088ce96a2cde16cbac21214956bd6f2e8f51193ee2b&scene=21#wechat_redirect">100期面试题汇总</a></p>
<p><strong>什么是不可重读？</strong></p>
<p>在一个事务内多次读取的结果不一样。</p>
<p><strong>为什么会产生不可重复读？</strong></p>
<p>这跟 READ COMMITTED 级别下的MVCC机制有关系，在该隔离级别下每次 select的时候新生成一个版本号，所以每次select的时候读的不是一个副本而是不同的副本。</p>
<p>在每次select之间有其他事务更新了我们读取的数据并提交了，那就出现了不可重复读</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></p>
<h4 id="REPEATABLE-READ-Mysql默认隔离级别"><a href="#REPEATABLE-READ-Mysql默认隔离级别" class="headerlink" title="REPEATABLE READ(Mysql默认隔离级别)"></a>REPEATABLE READ(Mysql默认隔离级别)</h4><p>在一个事务内的多次读取的结果是一样的。这种级别下可以避免，脏读，不可重复读等查询问题。mysql 有两种机制可以达到这种隔离级别的效果，分别是采用读写锁以及MVCC。</p>
<p><strong>采用读写锁实现：</strong></p>
<p><strong><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></strong></p>
<p>为什么能可重复度？只要没释放读锁，在次读的时候还是可以读到第一次读的数据。</p>
<ul>
<li><p>  优点：实现起来简单</p>
</li>
<li><p>  缺点：无法做到读写并行</p>
</li>
</ul>
<p><strong>采用MVCC实现：</strong></p>
<p><strong><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLrRoGUuJibrOVgypbNRbeSEVcOTKzHcicFovgiahkd0ZqngS97lGgJrDSzw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></strong></p>
<p>为什么能可重复度？因为多次读取只生成一个版本，读到的自然是相同数据。</p>
<ul>
<li><p>  优点：读写并行</p>
</li>
<li><p>  缺点：实现的复杂度高</p>
</li>
</ul>
<p>但是在该隔离级别下仍会存在幻读的问题，关于幻读的解决我打算另开一篇来介绍。</p>
<h4 id="SERIALIZABLE"><a href="#SERIALIZABLE" class="headerlink" title="SERIALIZABLE"></a>SERIALIZABLE</h4><p>该隔离级别理解起来最简单，实现也最单。在隔离级别下除了不会造成数据不一致问题，没其他优点。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLra3XZVJIBicVXIaHZ8bxJgzw2SoWbJxSxdaymdWzxxLaAcbhgAn2Vtow/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXiaukvjR0RBbMiae11Spew98rFwaXwQLraZbzZfmPpjbNK5WDvMR8s6Scj10IdH75B2UhiaKp6jGOsP5icJ2CuCOA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<h3 id="4-一致性的实现"><a href="#4-一致性的实现" class="headerlink" title="4.一致性的实现"></a>4.一致性的实现</h3><p>数据库总是从一个一致性的状态转移到另一个一致性的状态.</p>
<p>下面举个例子:zhangsan 从银行卡转400到理财账户</p>
<p><code>start transaction; select balance from bank where name=&quot;zhangsan&quot;; // 生成 重做日志 balance=600 update bank set balance = balance - 400; // 生成 重做日志 amount=400 update finance set amount = amount + 400; commit; </code></p>
<p>1.假如执行完 update bank set balance = balance - 400;之发生异常了，银行卡的钱也不能平白无辜的减少，而是回滚到最初状态。</p>
<p>2.又或者事务提交之后，缓冲池还没同步到磁盘的时候宕机了，这也是不能接受的，应该在重启的时候恢复并持久化。</p>
<p>3.假如有并发事务请求的时候也应该做好事务之间的可见性问题，避免造成脏读，不可重复读，幻读等。在涉及并发的情况下往往在性能和一致性之间做平衡，做一定的取舍，所以隔离性也是对一致性的一种破坏。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文出发点是想讲一下Mysql的事务的实现原理。</p>
<p>实现事务采取了哪些技术以及思想？</p>
<ul>
<li><p>  原子性：使用 undo log ，从而达到回滚</p>
</li>
<li><p>  持久性：使用 redo log，从而达到故障后恢复</p>
</li>
<li><p>  隔离性：使用锁以及MVCC,运用的优化思想有读写分离，读读并行，读写并行</p>
</li>
<li><p>  一致性：通过回滚，以及恢复，和在并发环境下的隔离做到一致性。</p>
</li>
</ul>
<p><strong>·END·</strong></p>
<p><a href="https://mp.weixin.qq.com/s/79HhQsZRzzuskP5p5LNONA">原文</a></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>mySQL查询优化</title>
    <url>/2016/01/03/mySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>糟糕的SQL查询语句可对整个应用程序的运行产生严重的影响，其不仅消耗掉更多的数据库时间，且它将对其他应用组件产生影响。</p>
<p>　　如同其它学科，优化查询性能很大程度上决定于开发者的直觉。幸运的是，像MySQL这样的数据库自带有一些协助工具。本文简要讨论诸多工具之三种：使用索引，使用EXPLAIN分析查询以及调整MySQL的内部配置。</p>
<p>　　一、使用索引<br>　<br>　　MySQL允许对数据库表进行索引，以此能迅速查找记录，而无需一开始就扫描整个表，由此显著地加快查询速度。每个表最多可以做到16个索引，此外MySQL还支持多列索引及全文检索。</p>
<p>　　给表添加一个索引非常简单，只需调用一个CREATE INDEX命令并为索引指定它的域即可。列表A给出了一个例子：</p>
<p>mysql&gt; CREATE INDEX idx_username ON users(username);<br>Query OK， 1 row affected (0.15 sec)<br>Records: 1  Duplicates: 0  Warnings: 0</p>
<p>　　列表 A</p>
<p>　　这里，对users表的username域做索引，以确保在WHERE或者HAVING子句中引用这一域的SELECT查询语句运行速度比没有添加索引时要快。通过SHOW INDEX命令可以查看索引已被创建（列表B）。</p>
<p>　　 </p>
<p>　　列表 B</p>
<p>　　值得注意的是：索引就像一把双刃剑。对表的每一域做索引通常没有必要，且很可能导致运行速度减慢，因为向表中插入或修改数据时，MySQL不得不每次都为这些额外的工作重新建立索引。另一方面，避免对表的每一域做索引同样不是一个非常好的主意，因为在提高插入记录的速度时，导致查询操作的速度减慢。这就需要找到一个平衡点，比如在设计索引系统时，考虑表的主要功能（数据修复及编辑）不失为一种明智的选择。</p>
<p>　　二、优化查询性能</p>
<p>　　在分析查询性能时，考虑EXPLAIN关键字同样很管用。EXPLAIN关键字一般放在SELECT查询语句的前面，用于描述MySQL如何执行查询操作、以及MySQL成功返回结果集需要执行的行数。下面的一个简单例子可以说明（列表C）这一过程：</p>
<p>　　 </p>
<p>　　列表 C</p>
<p>　　这里查询是基于两个表连接。EXPLAIN关键字描述了MySQL是如何处理连接这两个表。必须清楚的是，当前设计要求MySQL处理的是 country表中的一条记录以及city表中的整个4019条记录。这就意味着，还可使用其他的优化技巧改进其查询方法。例如，给city表添加如下索引（列表D）：</p>
<p>mysql&gt; CREATE INDEX idx_ccode ON city(countrycode);<br>Query OK， 4079 rows affected (0.15 sec)<br>Records: 4079  Duplicates: 0  Warnings: 0</p>
<p>　　列表 D</p>
<p>　　现在，当我们重新使用EXPLAIN关键字进行查询时，我们可以看到一个显著的改进（列表E）：</p>
<p>　　</p>
<p>　　列表 E</p>
<p>　　在这个例子中，MySQL现在只需要扫描city表中的333条记录就可产生一个结果集，其扫描记录数几乎减少了90％！自然，数据库资源的查询速度更快，效率更高。</p>
<p>三、调整内部变量</p>
<p>　　MySQL是如此的开放，所以可轻松地进一步调整其缺省设置以获得更优的性能及稳定性。需要优化的一些关键变量如下：</p>
<p>　　改变索引缓冲区长度(key_buffer)</p>
<p>　　一般，该变量控制缓冲区的长度在处理索引表（读/写操作）时使用。MySQL使用手册指出该变量可以不断增加以确保索引表的最佳性能，并推荐使用与系统内存25％的大小作为该变量的值。这是MySQL十分重要的配置变量之一，如果你对优化和提高系统性能有兴趣，可以从改变 key_buffer_size变量的值开始。</p>
<p>　　改变表长(read_buffer_size)</p>
<p>　　当一个查询不断地扫描某一个表，MySQL会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。如果你认为连续扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。</p>
<p>　　设定打开表的数目的最大值(table_cache)</p>
<p>　　该变量控制MySQL在任何时候打开表的最大数目，由此能控制服务器响应输入请求的能力。它跟max_connections变量密切相关，增加 table_cache值可使MySQL打开更多的表，就如增加max_connections值可增加连接数一样。当收到大量不同数据库及表的请求时，可以考虑改变这一值的大小。</p>
<p>　　对缓长查询设定一个时间限制(long_query_time)</p>
<p>　　MySQL带有“慢查询日志”，它会自动地记录所有的在一个特定的时间范围内尚未结束的查询。这个日志对于跟踪那些低效率或者行为不端的查询以及寻找优化对象都非常有用。long_query_time变量控制这一最大时间限定，以秒为单位。</p>
<p>　　以上讨论并给出用于分析和优化SQL查询的三种工具的使用方法，以此提高你的应用程序性能。使用它们快乐地优化吧！</p>
<p>使用EXPLAIN语句检查SQL语句</p>
<p>　　当你在一条SELECT语句前放上关键词EXPLAIN，MySQL解释它将如何处理SELECT，提供有关表如何联结和以什么次序联结的信息。</p>
<p>　　借助于EXPLAIN，你可以知道你什么时候必须为表加入索引以得到一个使用索引找到记录的更快的SELECT。</p>
<p>EXPLAIN tbl_name</p>
<p>or  EXPLAIN SELECT select_options<br>EXPLAIN tbl_name是DESCRIBE tbl_name或SHOW COLUMNS FROM tbl_name的一个同义词。</p>
<p>　　从EXPLAIN的输出包括下面列：</p>
<p>　　·table<br>　　输出的行所引用的表。</p>
<p>　　· type<br>　　联结类型。各种类型的信息在下面给出。<br>　　不同的联结类型列在下面，以最好到最差类型的次序：<br>system const eq_ref ref range index ALL possible_keys</p>
<p>　　· key<br>　　key列显示MySQL实际决定使用的键。如果没有索引被选择，键是NULL。</p>
<p>　　· key_len<br>　　key_len列显示MySQL决定使用的键长度。如果键是NULL，长度是NULL。注意这告诉我们MySQL将实际使用一个多部键值的几个部分。</p>
<p>　　· ref<br>　　ref列显示哪个列或常数与key一起用于从表中选择行。</p>
<p>　　· rows<br>　　rows列显示MySQL相信它必须检验以执行查询的行数。</p>
<p>　　·Extra<br>　　如果Extra列包括文字Only index，这意味着信息只用索引树中的信息检索出的。通常，这比扫描整个表要快。如果Extra列包括文字where used，它意味着一个WHERE子句将被用来限制哪些行与下一个表匹配或发向客户。</p>
<p>　　通过相乘EXPLAIN输出的rows行的所有值，你能得到一个关于一个联结要多好的提示。这应该粗略地告诉你MySQL必须检验多少行以执行查询。</p>
<p>　　例如，下面一个全连接：</p>
<p>mysql&gt; EXPLAIN SELECT student.name From student，pet<br>-&gt; WHERE student.name=pet.owner;</p>
<p>　　其结论为：</p>
<p>+———+——+—————+——+———+——+——+————+<br>| table   | type | possible_keys | key  | key_len | ref  | rows | Extra      |<br>+———+——+—————+——+———+——+——+————+<br>| student | ALL  | NULL          | NULL |    NULL | NULL |   13 |            |<br>| pet     | ALL  | NULL          | NULL |    NULL | NULL |    9 | where used |<br>+———+——+—————+——+———+——+——+————+</p>
<p>　　SELECT 查询的速度</p>
<p>　　总的来说，当你想要使一个较慢的SELECT … WHERE更快，检查的第一件事情是你是否能增加一个索引。在不同表之间的所有引用通常应该用索引完成。你可以使用EXPLAIN来确定哪个索引用于一条SELECT语句。</p>
<p>　　一些一般的建议：</p>
<p>　　·为了帮助MySQL更好地优化查询，在它已经装载了相关数据后，在一个表上运行myisamchk –analyze。这为每一个更新一个值，指出有相同值地平均行数（当然，对唯一索引，这总是1。）</p>
<p>　　·为了根据一个索引排序一个索引和数据，使用myisamchk –sort-index –sort-records=1（如果你想要在索引1上排序）。如果你有一个唯一索引，你想要根据该索引地次序读取所有的记录，这是使它更快的一个好方法。然而注意，这个排序没有被最佳地编写，并且对一个大表将花很长时间！</p>
<p>　　MySQL怎样优化WHERE子句</p>
<p>　　where优化被放在SELECT中，因为他们最主要在那里使用里，但是同样的优化被用于DELETE和UPDATE语句。</p>
<p>　　也要注意，本节是不完全的。MySQL确实作了许多优化而我们没有时间全部记录他们。</p>
<p>　　由MySQL实施的一些优化列在下面：</p>
<p>　　1、删除不必要的括号：<br>((a AND b) AND c OR (((a AND b) AND (c AND d))))<br>-&gt; (a AND b AND c) OR (a AND b AND c AND d)</p>
<p>　　2、常数调入：<br>(a-&gt; b&gt;5 AND b=c AND a=5</p>
<p>　　3、删除常数条件(因常数调入所需)：<br>(B&gt;=5 AND B=5) OR (B=6 AND 5=5) OR (B=7 AND 5=6)<br>-&gt; B=5 OR B=6</p>
<p>　　4、索引使用的常数表达式仅计算一次。</p>
<p>　　5、在一个单个表上的没有一个WHERE的COUNT(*)直接从表中检索信息。当仅使用一个表时，对任何NOT NULL表达式也这样做。</p>
<p>　　6、无效常数表达式的早期检测。MySQL快速检测某些SELECT语句是不可能的并且不返回行。</p>
<p>　　7、如果你不使用GROUP BY或分组函数(COUNT()、MIN()……)，HAVING与WHERE合并。</p>
<p>　　8、为每个子联结(sub join)，构造一个更简单的WHERE以得到一个更快的WHERE计算并且也尽快跳过记录。</p>
<p>　　9、所有常数的表在查询中的任何其他表前被首先读出。一个常数的表是：</p>
<p>　　·一个空表或一个有1行的表。</p>
<p>　　·与在一个UNIQUE索引、或一个PRIMARY KEY的WHERE子句一起使用的表，这里所有的索引部分使用一个常数表达式并且索引部分被定义为NOT NULL。</p>
<p>　　所有下列的表用作常数表</p>
<p> mysql&gt; SELECT * FROM t WHERE primary_key=1;<br>mysql&gt; SELECT * FROM t1，t2<br>WHERE t1.primary_key=1 AND t2.primary_key=t1.id;</p>
<p>　　10、对联结表的最好联结组合是通过尝试所有可能性来找到:(。如果所有在ORDER BY和GROUP BY的列来自同一个表，那么当廉洁时，该表首先被选中。</p>
<p>　　11、如果有一个ORDER BY子句和一个不同的GROUP BY子句，或如果ORDER BY或GROUP BY包含不是来自联结队列中的第一个表的其他表的列，创建一个临时表。</p>
<p>　　12、如果你使用SQL_SMALL_RESULT，MySQL将使用一个在内存中的表。</p>
<p>　　13、因为DISTINCT被变换到在所有的列上的一个GROUP BY，DISTINCT与ORDER BY结合也将在许多情况下需要一张临时表。</p>
<p>　　14、每个表的索引被查询并且使用跨越少于30% 的行的索引。如果这样的索引没能找到，使用一个快速的表扫描。</p>
<p>　　15、在一些情况下，MySQL能从索引中读出行，甚至不咨询数据文件。如果索引使用的所有列是数字的，那么只有索引树被用来解答查询。</p>
<p>　　16、在每个记录被输出前，那些不匹配HAVING子句的行被跳过。</p>
<p>　　下面是一些很快的查询例子</p>
<p> mysql&gt; SELECT COUNT(*) FROM tbl_name;<br>mysql&gt; SELECT MIN(key_part1)，MAX(key_part1) FROM tbl_name;<br>mysql&gt; SELECT MAX(key_part2) FROM tbl_name<br>           WHERE key_part_1=constant;<br>mysql&gt; SELECT … FROM tbl_name<br>           ORDER BY key_part1，key_part2，… LIMIT 10;<br>mysql&gt; SELECT … FROM tbl_name<br>           ORDER BY key_part1 DESC，key_part2 DESC，… LIMIT 10;</p>
<p>　　下列查询仅使用索引树就可解决(假设索引列是数字的)：</p>
<p> mysql&gt; SELECT key_part1，key_part2 FROM tbl_name WHERE key_part1=val;<br>mysql&gt; SELECT COUNT(*) FROM tbl_name<br>           WHERE key_part1=val1 AND key_part2=val2;<br>mysql&gt; SELECT key_part2 FROM tbl_name GROUP BY key_part1;</p>
<p>　　下列查询使用索引以排序顺序检索，不用一次另外的排序：</p>
<p> mysql&gt; SELECT … FROM tbl_name ORDER BY key_part1，key_part2，…<br>mysql&gt; SELECT … FROM tbl_name ORDER BY key_part1 DESC，key_part2 DESC，…</p>
<p>MySQL怎样优化LEFT JOIN</p>
<p>在MySQL中，A LEFT JOIN B实现如下：</p>
<p>1、表B被设置为依赖于表A。</p>
<p>2、表A被设置为依赖于所有用在LEFT JOIN条件的表(除B外)。</p>
<p>3、所有LEFT JOIN条件被移到WHERE子句中。</p>
<p>4、进行所有标准的联结优化，除了一个表总是在所有它依赖的表之后被读取。如果有一个循环依赖，MySQL将发出一个错误。</p>
<p>5、进行所有标准的WHERE优化。</p>
<p>6、如果在A中有一行匹配WHERE子句，但是在B中没有任何行匹配LEFT JOIN条件，那么在B中生成所有列设置为NULL的一行。</p>
<p>7、如果你使用LEFT JOIN来找出在某些表中不存在的行并且在WHERE部分你有下列测试：column_name IS NULL，这里column_name 被声明为NOT NULL的列，那么MySQL在它已经找到了匹配LEFT JOIN条件的一行后，将停止在更多的行后寻找(对一特定的键组合)。</p>
<p>MySQL怎样优化LIMIT</p>
<p>在一些情况中，当你使用LIMIT #而不使用HAVING时，MySQL将以不同方式处理查询。</p>
<p>1、如果你用LIMIT只选择一些行，当MySQL一般比较喜欢做完整的表扫描时，它将在一些情况下使用索引。</p>
<p>2、如果你使用LIMIT #与ORDER BY，MySQL一旦找到了第一个 # 行，将结束排序而不是排序整个表。</p>
<p>3、当结合LIMIT #和DISTINCT时，MySQL一旦找到#个唯一的行，它将停止。</p>
<p>4、在一些情况下，一个GROUP BY能通过顺序读取键(或在键上做排序)来解决，并然后计算摘要直到键值改变。在这种情况下，LIMIT #将不计算任何不必要的GROUP。</p>
<p>5、只要MySQL已经发送了第一个#行到客户，它将放弃查询。</p>
<p>6、LIMIT 0将总是快速返回一个空集合。这对检查查询并且得到结果列的列类型是有用的。</p>
<p>7、临时表的大小使用LIMIT #计算需要多少空间来解决查询。</p>
<p>记录转载和修改的速度</p>
<p>很多时候关心的是优化 SELECT 查询，因为它们是最常用的查询，而且确定怎样优化它们并不总是直截了当。相对来说，将数据装入数据库是直截了当的。然而，也存在可用来改善数据装载操作效率的策略，其基本原理如下：</p>
<p>·成批装载较单行装载更快，因为在装载每个记录后，不需要刷新索引高速缓存；可在成批记录装入后才刷新。</p>
<p>·在表无索引时装载比索引后装载更快。如果有索引，不仅必须增加记录到数据文件，而且还要修改每个索引以反映增加了的新记录。</p>
<p>·较短的 SQL 语句比较长的 SQL 语句要快，因为它们涉及服务器方的分析较少，而且还因为将它们通过网络从客户机发送到服务器更快。</p>
<p>这些因素中有一些似乎微不足道（特别是最后一个因素），但如果要装载大量的数据，即使是很小的因素也会产生很大的不同结果。</p>
<p>INSERT查询的速度</p>
<p>插入一个记录的时间由下列组成：</p>
<p>·连接：(3)</p>
<p>·发送查询给服务器：(2)</p>
<p>·分析查询：(2)</p>
<p>·插入记录：（1 x 记录大小）</p>
<p>·插入索引：（1 x 索引）</p>
<p>·关闭：(1)</p>
<p>这里的数字有点与总体时间成正比。这不考虑打开表的初始开销(它为每个并发运行的查询做一次)。</p>
<p>表的大小以N log N (B 树)的速度减慢索引的插入。</p>
<p>加快插入的一些方法：</p>
<p>·如果你同时从同一客户插入很多行，使用多个值表的INSERT语句。这比使用分开INSERT语句快(在一些情况中几倍)。</p>
<p>·如果你从不同客户插入很多行，你能通过使用INSERT DELAYED语句得到更高的速度。</p>
<p>·注意，用MyISAM，如果在表中没有删除的行，能在SELECT:s正在运行的同时插入行。</p>
<p>·当从一个文本文件装载一个表时，使用LOAD DATA INFILE。这通常比使用很多INSERT语句快20倍。</p>
<p>·当表有很多索引时，有可能多做些工作使得LOAD DATA INFILE更快些。使用下列过程：</p>
<p>1、有选择地用CREATE TABLE创建表。例如使用mysql或Perl-DBI。</p>
<p>2、执行FLUSH TABLES，或外壳命令mysqladmin flush-tables。</p>
<p>3、使用myisamchk –keys-used=0 -rq /path/to/db/tbl_name。这将从表中删除所有索引的使用。</p>
<p>4、用LOAD DATA INFILE把数据插入到表中，这将不更新任何索引，因此很快。</p>
<p>5、如果你有myisampack并且想要压缩表，在它上面运行myisampack。</p>
<p>6、用myisamchk -r -q /path/to/db/tbl_name再创建索引。这将在将它写入磁盘前在内存中创建索引树，并且它更快，因为避免大量磁盘寻道。结果索引树也被完美地平衡。</p>
<p>7、执行FLUSH TABLES，或外壳命令mysqladmin flush-tables。</p>
<p>这个过程将被构造进在MySQL的某个未来版本的LOAD DATA INFILE。</p>
<p>·你可以锁定你的表以加速插入</p>
<p>mysql&gt; LOCK TABLES a WRITE;<br>mysql&gt; INSERT INTO a VALUES (1，23)，(2，34)，(4，33);<br>mysql&gt; INSERT INTO a VALUES (8，26)，(6，29);<br>mysql&gt; UNLOCK TABLES;</p>
<p>　　主要的速度差别是索引缓冲区仅被清洗到磁盘上一次，在所有INSERT语句完成后。一般有与有不同的INSERT语句那样夺的索引缓冲区清洗。如果你能用一个单个语句插入所有的行，锁定就不需要。锁定也将降低多连接测试的整体时间，但是对某些线程最大等待时间将上升(因为他们等待锁)。例如：</p>
<p>thread 1 does 1000 inserts<br>thread 2， 3， and 4 does 1 insert<br>thread 5 does 1000 inserts </p>
<p>如果你不使用锁定，2、3和4将在1和5前完成。如果你使用锁定，2、3和4将可能不在1或5前完成，但是整体时间应该快大约40%。因为INSERT， UPDATE和DELETE操作在MySQL中是很快的，通过为多于大约5次连续不断地插入或更新一行的东西加锁，你将获得更好的整体性能。如果你做很多一行的插入，你可以做一个LOCK TABLES，偶尔随后做一个UNLOCK TABLES(大约每1000行)以允许另外的线程存取表。这仍然将导致获得好的性能。当然，LOAD DATA INFILE对装载数据仍然是更快的。</p>
<p>为了对LOAD DATA INFILE和INSERT得到一些更快的速度，扩大关键字缓冲区。</p>
<p>UPDATE查询的速度</p>
<p>更改查询被优化为有一个写开销的一个SELECT查询。写速度依赖于被更新数据大小和被更新索引的数量。</p>
<p>使更改更快的另一个方法是推迟更改并且然后一行一行地做很多更改。如果你锁定表，做一行一行地很多更改比一次做一个快。</p>
<p>注意，动态记录格式的更改一个较长总长的记录，可能切开记录。因此如果你经常这样做，时不时地OPTIMIZE TABLE是非常重要的。</p>
<p>DELETE查询的速度</p>
<p>删除一个记录的时间精确地与索引数量成正比。为了更快速地删除记录，你可以增加索引缓存的大小。</p>
<p>从一个表删除所有行比删除行的一大部分也要得多。</p>
<p>索引对有效装载数据的影响</p>
<p>如果表是索引的，则可利用批量插入（LOAD DATA 或多行的 INSERT 语句）来减少索引的开销。这样会最小化索引更新的影响，因为索引只需要在所有行处理过时才进行刷新，而不是在每行处理后就刷新。</p>
<p>·如果需要将大量数据装入一个新表，应该创建该表且在未索引时装载，装载数据后才创建索引，这样做较快。一次创建索引（而不是每行修改一次索引）较快。</p>
<p>·如果在装载之前删除或禁用索引，装入数据后再重新创建或启用索引可能使装载更快。<br>·如果想对数据装载使用删除或禁用策略，一定要做一些实验，看这样做是否值得（如果将少量数据装入一个大表中，重建和索引所花费的时间可能比装载数据的时间还要长）。</p>
<p>可用DROP INDEX和CREATE INDEX 来删除和重建索引。</p>
<p>另一种可供选择的方法是利用 myisamchk 或 isamchk 禁用和启用索引。这需要在 MySQL 服务器主机上有一个帐户，并对表文件有写入权。为了禁用表索引，可进入相应的数据库目录，执行下列命令之一：</p>
<p>shell&gt;myisamchk –keys-used=0 tbl_name<br>shell&gt;isamchk –keys-used=0 tbl_name </p>
<p>　　对具有 .MYI 扩展名的索引文件的 MyISAM 表使用 myisamchk，对具有 .ISM 扩展名的索引文件的 ISAM 表使用 isamchk。在向表中装入数据后，按如下激活索引：</p>
<p>shell&gt;myisamchk –recover –quick –keys-used=0 tbl_name<br>shell&gt;isamchk –recover –quick –keys-used=0 tbl_name</p>
<p>　　n 为表具有的索引数目。可用 –description 选项调用相应的实用程序得出这个值：</p>
<p>shell&gt;myisamchk –discription tbl_name<br>$isamchk –discription tbl_name</p>
<p>　　如果决定使用索引禁用和激活，应该使用第13章中介绍的表修复锁定协议以阻止服务器同时更改锁（虽然此时不对表进行修复，但要对它像表修复过程一样进行修改，因此需要使用相同的锁定协议）。</p>
<p>上述数据装载原理也适用于与需要执行不同操作的客户机有关的固定查询。例如，一般希望避免在频繁更新的表上长时间运行 SELECT 查询。长时间运行 SELECT 查询会产生大量争用，并降低写入程序的性能。一种可能的解决方法为，如果执行写入的主要是 INSERT 操作，那么先将记录存入一个临时表，然后定期地将这些记录加入主表中。如果需要立即访问新记录，这不是一个可行的方法。但只要能在一个较短的时间内不访问它们，就可以使用这个方法。使用临时表有两个方面的好处。首先，它减少了与主表上 SELECT 查询语句的争用，因此，执行更快。其次，从临时表将记录装入主表的总时间较分别装载记录的总时间少；相应的索引高速缓存只需在每个批量装载结束时进行刷新，而不是在每行装载后刷新。</p>
<p>这个策略的一个应用是进入 Web 服务器的Web 页访问 MySQL 数据库。在此情形下，可能没有保证记录立即进入主表的较高权限。</p>
<p>如果数据并不完全是那种在系统非正常关闭事件中插入的单个记录，那么减少索引刷新的另一策略是使用 MyISAM 表的 DELAYED_KEY_WRITE 表创建选项（如果将 MySQL 用于某些数据录入工作时可能会出现这种情况）。此选项使索引高速缓存只偶尔刷新，而不是在每次插入后都要刷新。</p>
<p>如果希望在服务器范围内利用延迟索引刷新，只要利用 –delayed-key-write 选项启动 mysqld 即可。在此情形下，索引块写操作延迟到必须刷新块以便为其他索引值腾出空间为止，或延迟到执行了一个 flush-tables 命令后，或延迟到该索引表关闭。</p>
]]></content>
      <categories>
        <category>数据库</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>又能扯皮了！没内存了还能看片？</title>
    <url>/2020/03/08/%E5%8F%88%E8%83%BD%E6%89%AF%E7%9A%AE%E4%BA%86%EF%BC%81%E6%B2%A1%E5%86%85%E5%AD%98%E4%BA%86%E8%BF%98%E8%83%BD%E7%9C%8B%E7%89%87%EF%BC%9F/</url>
    <content><![CDATA[<h2 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h2><p>尽管基址寄存器和变址寄存器用来创建地址空间的抽象，但是这有一个其他的问题需要解决：<code>管理软件的膨胀(managing bloatware)</code>。虽然内存的大小增长迅速，但是软件的大小增长的要比内存还要快。在 1980 年的时候，许多大学用一台 4 MB 的 VAX 计算机运行分时操作系统，供十几个用户同时运行。现在微软公司推荐的 64 位 Windows 8 系统至少需要 2 GB 内存，而许多多媒体的潮流则进一步推动了对内存的需求。</p>
<p>这一发展的结果是，需要运行的程序往往大到内存无法容纳，而且必然需要系统能够支持多个程序同时运行，即使内存可以满足其中单独一个程序的需求，但是从总体上来看内存仍然满足不了日益增长的软件的需求（感觉和xxx和xxx 的矛盾很相似）。而交换技术并不是一个很有效的方案，在一些中小应用程序尚可使用交换，如果应用程序过大，难道还要每次交换几 GB 的内存？这显然是不合适的，一个典型的 <code>SATA</code> 磁盘的峰值传输速度高达几百兆/秒，这意味着需要好几秒才能换出或者换入一个 1 GB 的程序。</p>
<blockquote>
<p>SATA（Serial ATA）硬盘，又称串口硬盘，是未来 PC 机硬盘的趋势，已基本取代了传统的 PATA 硬盘。</p>
</blockquote>
<p>那么还有没有一种有效的方式来应对呢？有，那就是使用 <code>虚拟内存(virtual memory)</code>，虚拟内存的基本思想是，每个程序都有自己的地址空间，这个地址空间被划分为多个称为<code>页面(page)</code>的块。每一页都是连续的地址范围。这些页被映射到物理内存，但并不是所有的页都必须在内存中才能运行程序。当程序引用到一部分在物理内存中的地址空间时，硬件会立刻执行必要的映射。当程序引用到一部分不在物理内存中的地址空间时，由操作系统负责将缺失的部分装入物理内存并重新执行失败的指令。</p>
<p>在某种意义上来说，虚拟地址是对基址寄存器和变址寄存器的一种概述。8088 有分离的基址寄存器（但不是变址寄存器）用于放入 text 和 data 。</p>
<p>使用虚拟内存，可以将整个地址空间以很小的单位映射到物理内存中，而不是仅仅针对 text 和 data 区进行重定位。下面我们会探讨虚拟内存是如何实现的。</p>
<p>虚拟内存很适合在多道程序设计系统中使用，许多程序的片段同时保存在内存中，当一个程序等待它的一部分读入内存时，可以把 CPU 交给另一个进程使用。</p>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>大部分使用虚拟内存的系统中都会使用一种 <code>分页(paging)</code> 技术。在任何一台计算机上，程序会引用使用一组内存地址。当程序执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MOV REG,1000</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这条指令时，它会把内存地址为 1000 的内存单元的内容复制到 REG 中（或者相反，这取决于计算机）。地址可以通过索引、基址寄存器、段寄存器或其他方式产生。</p>
<p>这些程序生成的地址被称为 <code>虚拟地址(virtual addresses)</code> 并形成<code>虚拟地址空间(virtual address space)</code>，在没有虚拟内存的计算机上，系统直接将虚拟地址送到内存中线上，读写操作都使用同样地址的物理内存。<strong>在使用虚拟内存时，虚拟地址不会直接发送到内存总线上</strong>。相反，会使用 <code>MMU(Memory Management Unit)</code> 内存管理单元把<strong>虚拟地址映射为物理内存地址</strong>，像下图这样</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de9842f303?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>下面这幅图展示了这种映射是如何工作的</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de98a4a283?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>页表给出虚拟地址与物理内存地址之间的映射关系。每一页起始于 4096 的倍数位置，结束于 4095 的位置，所以 4K 到 8K 实际为 4096 - 8191 ，8K - 12K 就是 8192 - 12287</p>
<p>在这个例子中，我们可能有一个 16 位地址的计算机，地址从 0 - 64 K - 1，这些是<code>虚拟地址</code>。然而只有 32 KB 的物理地址。所以虽然可以编写 64 KB 的程序，但是程序无法全部调入内存运行，在磁盘上必须有一个最多 64 KB 的程序核心映像的完整副本，以保证程序片段在需要时被调入内存。</p>
<h4 id="存在映射的页如何映射"><a href="#存在映射的页如何映射" class="headerlink" title="存在映射的页如何映射"></a>存在映射的页如何映射</h4><p>虚拟地址空间由固定大小的单元组成，这种固定大小的单元称为 <code>页(pages)</code>。而相对的，物理内存中也有固定大小的物理单元，称为 <code>页框(page frames)</code>。页和页框的大小一样。在上面这个例子中，页的大小为 4KB ，但是实际的使用过程中页的大小范围可能是 512 字节 - 1G 字节的大小。对应于 64 KB 的虚拟地址空间和 32 KB 的物理内存，可得到 16 个虚拟页面和 8 个页框。RAM 和磁盘之间的交换总是以整个页为单元进行交换的。</p>
<p>程序试图访问地址时，例如执行下面这条指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MOV REG, 0</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>会将虚拟地址 0 送到 MMU。MMU 看到虚拟地址落在页面 0 （0 - 4095），根据其映射结果，这一页面对应的页框 2 （8192 - 12287），因此 MMU 把地址变换为 8192 ，并把地址 8192 送到总线上。内存对 MMU 一无所知，它只看到一个对 8192 地址的读写请求并执行它。MMU 从而有效的把所有虚拟地址 0 - 4095 映射到了 8192 - 12287 的物理地址。同样的，指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MOV REG, 8192</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>也被有效的转换为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MOV REG, 24576</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>虚拟地址 8192（在虚拟页 2 中）被映射到物理地址 24576（在物理页框 6 中）上。</p>
<p>通过恰当的设置 MMU，可以把 16 个虚拟页面映射到 8 个页框中的任何一个。但是这并没有解决虚拟地址空间比物理内存大的问题。</p>
<p>上图中有 8 个物理页框，于是只有 8 个虚拟页被映射到了物理内存中，在上图中用 <code>X</code> 号表示的其他页面没有被映射。在实际的硬件中，会使用一个 <code>在/不在(Present/absent bit)</code>位记录页面在内存中的实际存在情况。</p>
<h4 id="未映射的页如何映射"><a href="#未映射的页如何映射" class="headerlink" title="未映射的页如何映射"></a>未映射的页如何映射</h4><p>当程序访问一个未映射的页面，如执行指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MOV REG, 32780</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>将会发生什么情况呢？虚拟页面 8 （从 32768 开始）的第 12 个字节所对应的物理地址是什么？MMU 注意到该页面没有被映射（在图中用 X 号表示），于是 CPU 会<code>陷入(trap)</code>到操作系统中。这个陷入称为 <code>缺页中断(page fault)</code> 或者是 <code>缺页错误</code>。操作系统会选择一个很少使用的页并把它的内容写入磁盘（如果它不在磁盘上）。随后把需要访问的页面读到刚才回收的页框中，修改映射关系，然后重新启动引起陷入的指令。有点不太好理解，举个例子来看一下。</p>
<p>例如，如果操作系统决定放弃页框 1，那么它将把虚拟机页面 8 装入物理地址 4096，并对 MMU 映射做两处修改。首先，它要将虚拟页中的 1 表项标记为未映射，使以后任何对虚拟地址 4096 - 8191 的访问都将导致陷入。随后把虚拟页面 8 的表项的叉号改为 1，因此在引起陷阱的指令重新启动时，它将把虚拟地址 32780 映射为物理地址（4096 + 12）。</p>
<p>下面查看一下 MMU 的内部构造以便了解它们是如何工作的，以及了解为什么我们选用的页大小都是 2 的整数次幂。下图我们可以看到一个虚拟地址的例子</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de9b517a4b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>虚拟地址 8196 （二进制 0010000000000100）用上面的页表映射图所示的 MMU 映射机制进行映射，输入的 16 位虚拟地址被分为 4 位的页号和 12 位的偏移量。4 位的页号可以表示 16 个页面，12 位的偏移可以为一页内的全部 4096 个字节。</p>
<p>可用页号作为<code>页表(page table)</code> 的索引，以得出对应于该虚拟页面的页框号。如果<code>在/不在</code>位则是 0 ，则引起一个操作系统陷入。如果该位是 1，则将在页表中查到的页框号复制到输出寄存器的高 3 位中，再加上输入虚拟地址中的低 12 位偏移量。如此就构成了 15 位的物理地址。输出寄存器的内容随即被作为物理地址送到总线。</p>
<h3 id="页表"><a href="#页表" class="headerlink" title="页表"></a>页表</h3><p>在上面这个简单的例子中，虚拟地址到物理地址的映射可以总结如下：虚拟地址被分为<code>虚拟页号（高位部分）</code>和<code>偏移量（低位部分）</code>。例如，对于 16 位地址和 4 KB 的页面大小，高 4 位可以指定 16 个虚拟页面中的一页，而低 12 位接着确定了所选页面中的偏移量（0-4095）。</p>
<p>虚拟页号可作为页表的索引用来找到虚拟页中的内容。由页表项可以找到页框号（如果有的话）。然后把页框号拼接到偏移量的高位端，以替换掉虚拟页号，形成物理地址。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de9a1afbd9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>因此，页表的目的是把虚拟页映射到页框中。从数学上说，页表是一个函数，它的参数是虚拟页号，结果是物理页框号。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de986cd905?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>通过这个函数可以把虚拟地址中的虚拟页转换为页框，从而形成物理地址。</p>
<h4 id="页表项的结构"><a href="#页表项的结构" class="headerlink" title="页表项的结构"></a>页表项的结构</h4><p>下面我们探讨一下页表项的具体结构，上面你知道了页表项的大致构成，是由页框号和在/不在位构成的，现在我们来具体探讨一下页表项的构成</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7de999e819e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>页表项的结构是与机器相关的，但是不同机器上的页表项大致相同。上面是一个页表项的构成，不同计算机的页表项可能不同，但是一般来说都是 32 位的。页表项中最重要的字段就是<code>页框号(Page frame number)</code>。毕竟，页表到页框最重要的一步操作就是要把此值映射过去。下一个比较重要的就是<code>在/不在</code>位，如果此位上的值是 1，那么页表项是有效的并且能够被<code>使用</code>。如果此值是 0 的话，则表示该页表项对应的虚拟页面<code>不在</code>内存中，访问该页面会引起一个<code>缺页异常(page fault)</code>。</p>
<p><code>保护位(Protection)</code> 告诉我们哪一种访问是允许的，啥意思呢？最简单的表示形式是这个域只有一位，<strong>0 表示可读可写，1 表示的是只读</strong>。</p>
<p><code>修改位(Modified)</code> 和 <code>访问位(Referenced)</code> 会跟踪页面的使用情况。当一个页面被写入时，硬件会自动的设置修改位。修改位在页面重新分配页框时很有用。如果一个页面已经被修改过（即它是 <code>脏</code> 的），则必须把它写回磁盘。如果一个页面没有被修改过（即它是 <code>干净</code>的），那么重新分配时这个页框会被直接丢弃，因为磁盘上的副本仍然是有效的。这个位有时也叫做 <code>脏位(dirty bit)</code>，因为它反映了页面的状态。</p>
<p><code>访问位(Referenced)</code> 在页面被访问时被设置，不管是读还是写。这个值能够帮助操作系统在发生缺页中断时选择要淘汰的页。不再使用的页要比正在使用的页更适合被淘汰。这个位在后面要讨论的<code>页面置换</code>算法中作用很大。</p>
<p>最后一位用于禁止该页面被高速缓存，这个功能对于映射到设备寄存器还是内存中起到了关键作用。通过这一位可以禁用高速缓存。具有独立的 I/O 空间而不是用内存映射 I/O 的机器来说，并不需要这一位。</p>
<p>在深入讨论下面问题之前，需要强调一下：虚拟内存本质上是用来创造一个地址空间的抽象，可以把它理解成为进程是对 CPU 的抽象，虚拟内存的实现，本质是将虚拟地址空间分解成页，并将每一项映射到物理内存的某个页框。因为我们的重点是如何管理这个虚拟内存的抽象。</p>
<h3 id="加速分页过程"><a href="#加速分页过程" class="headerlink" title="加速分页过程"></a>加速分页过程</h3><p>到现在我们已经<code>虚拟内存(virtual memory)</code> 和 <code>分页(paging)</code> 的基础，现在我们可以把目光放在具体的实现上面了。在任何带有分页的系统中，都会需要面临下面这两个主要问题：</p>
<ul>
<li>  虚拟地址到物理地址的映射速度必须要快</li>
<li>  如果虚拟地址空间足够大，那么页表也会足够大</li>
</ul>
<p>第一个问题是<strong>由于每次访问内存都需要进行虚拟地址到物理地址的映射</strong>，所有的指令最终都来自于内存，并且很多指令也会访问内存中的操作数。</p>
<blockquote>
<p>操作数：操作数是计算机指令中的一个组成部分，它规定了指令中进行数字运算的量 。操作数指出指令执行的操作所需要数据的来源。操作数是汇编指令的一个字段。比如，MOV、ADD 等。</p>
</blockquote>
<p>因此，每条指令可能会多次访问页表，如果执行一条指令需要 1 ns，那么页表查询需要在 0.2 ns 之内完成，以避免映射成为一个主要性能瓶颈。</p>
<p>第二个问题是所有的现代操作系统都会使用至少 32 位的虚拟地址，并且 64 位正在变得越来越普遍。假设页大小为 4 KB，32 位的地址空间将近有 100 万页，而 64 位地址空间简直多到无法想象。</p>
<p>对大而且快速的页映射的需要成为构建计算机的一个非常重要的约束。就像上面页表中的图一样，<strong>每一个表项对应一个虚拟页面，虚拟页号作为索引</strong>。在启动一个进程时，操作系统会把保存在内存中进程页表读副本放入寄存器中。</p>
<blockquote>
<p>最后一句话是不是不好理解？还记得页表是什么吗？它是虚拟地址到内存地址的映射页表。页表是虚拟地址转换的关键组成部分，它是访问内存中数据所必需的。在进程启动时，执行很多次虚拟地址到物理地址的转换，会把物理地址的副本从内存中读入到寄存器中，再执行这一转换过程。</p>
</blockquote>
<p>所以，在进程的运行过程中，不必再为页表而访问内存。使用这种方法的优势是<code>简单而且映射过程中不需要访问内存</code>。缺点是 <code>页表太大时，代价高昂</code>，而且每次上下文切换的时候都必须<code>装载整个页表</code>，这样会造成性能的降低。鉴于此，我们讨论一下加速分页机制和处理大的虚拟地址空间的实现方案</p>
<h4 id="转换检测缓冲区"><a href="#转换检测缓冲区" class="headerlink" title="转换检测缓冲区"></a>转换检测缓冲区</h4><p>我们首先先来一起探讨一下加速分页的问题。大部分优化方案都是从内存中的页表开始的。这种设计对效率有着巨大的影响。考虑一下，例如，假设一条 1 字节的指令要把一个寄存器中的数据复制到另一个寄存器。在不分页的情况下，这条指令只访问一次内存，即从内存取出指令。有了分页机制后，会因为要访问页表而需要更多的内存访问。由于执行速度通常被 CPU 从内存中取指令和数据的速度所限制，这样的话，两次访问才能实现一次的访问效果，所以内存访问的性能会下降一半。在这种情况下，根本不会采用分页机制。</p>
<blockquote>
<p>什么是 1 字节的指令？我们以 8085 微处理器为例来说明一下，在 8085 微处理中，一共有 3 种字节指令，它们分别是 <code>1-byte(1 字节)</code>、<code>2-byte(2 字节)</code>、<code>3-byte(3 字节)</code>，我们分别来说一下</p>
<p>1-byte：1 字节的操作数和操作码共同以 1 字节表示；操作数是内部寄存器，并被编码到指令中；指令需要一个存储位置来将单个寄存器存储在存储位置中。没有操作数的指令也是 1-byte 指令。</p>
<p>例如：MOV B,C 、LDAX B、NOP、HLT（这块不明白的读者可以自行查阅）</p>
<p>2-byte: 2 字节包括：第一个字节指定的操作码；第二个字节指定操作数；指令需要两个存储器位置才能存储在存储器中。</p>
<p>例如 MVI B, 26 H、IN 56 H</p>
<p>3-byte: 在 3 字节指令中，第一个字节指定操作码；后面两个字节指定 16 位的地址；第二个字节保存<code>低位</code>地址；第三个字节保存 <code>高位</code>地址。指令需要三个存储器位置才能将单个字节存储在存储器中。</p>
<p>例如 LDA 2050 H、JMP 2085 H</p>
</blockquote>
<p>大多数程序总是对少量页面进行多次访问，而不是对大量页面进行少量访问。因此，只有很少的页面能够被再次访问，而其他的页表项很少被访问。</p>
<blockquote>
<p>页表项一般也被称为 <code>Page Table Entry(PTE)</code>。</p>
</blockquote>
<p>基于这种设想，提出了一种方案，即从硬件方面来解决这个问题，为计算机设置一个小型的硬件设备，能够将虚拟地址直接映射到物理地址，而不必再访问页表。这种设备被称为<code>转换检测缓冲区(Translation Lookaside Buffer, TLB)</code>，有时又被称为 <code>相联存储器(associate memory)</code> 。</p>
<table>
<thead>
<tr>
<th>有效位</th>
<th>虚拟页面号</th>
<th>修改位</th>
<th>保护位</th>
<th>页框号</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>140</td>
<td>1</td>
<td>RW</td>
<td>31</td>
</tr>
<tr>
<td>1</td>
<td>20</td>
<td>0</td>
<td>R X</td>
<td>38</td>
</tr>
<tr>
<td>1</td>
<td>130</td>
<td>1</td>
<td>RW</td>
<td>29</td>
</tr>
<tr>
<td>1</td>
<td>129</td>
<td>1</td>
<td>RW</td>
<td>62</td>
</tr>
<tr>
<td>1</td>
<td>19</td>
<td>0</td>
<td>R X</td>
<td>50</td>
</tr>
<tr>
<td>1</td>
<td>21</td>
<td>0</td>
<td>R X</td>
<td>45</td>
</tr>
<tr>
<td>1</td>
<td>860</td>
<td>1</td>
<td>RW</td>
<td>14</td>
</tr>
<tr>
<td>1</td>
<td>861</td>
<td>1</td>
<td>RW</td>
<td>75</td>
</tr>
</tbody></table>
<p>​ TLB 加速分页</p>
<p>TLB 通常位于 MMU 中，包含少量的表项，每个表项都记录了页面的相关信息，除了虚拟页号外，其他表项都和页表是一一对应的</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7dec60a3ecd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>是不是你到现在还是有点不理解什么是 TLB，TLB 其实就是一种内存缓存，用于减少访问内存所需要的时间，它就是 MMU 的一部分，TLB 会将虚拟地址到物理地址的转换存储起来，通常可以称为<code>地址翻译缓存(address-translation cache)</code>。TLB 通常位于 CPU 和 CPU 缓存之间，它与 CPU 缓存是不同的缓存级别。下面我们来看一下 TLB 是如何工作的。</p>
<p>当一个 MMU 中的虚拟地址需要进行转换时，硬件首先检查虚拟页号与 TLB 中所有表项进行并行匹配，判断虚拟页是否在 TLB 中。如果找到了有效匹配项，并且要进行的访问操作没有违反保护位的话，则将页框号直接从 TLB 中取出而不用再直接访问页表。如果虚拟页在 TLB 中但是违反了保护位的权限的话（比如只允许读但是是一个写指令），则会生成一个<code>保护错误(protection fault)</code> 返回。</p>
<p>上面探讨的是虚拟地址在 TLB 中的情况，那么如果虚拟地址不再 TLB 中该怎么办？如果 MMU 检测到没有有效的匹配项，就会进行正常的页表查找，然后从 TLB 中逐出一个表项然后把从页表中找到的项放在 TLB 中。当一个表项被从 TLB 中清除出，将修改位复制到内存中页表项，除了访问位之外，其他位保持不变。当页表项从页表装入 TLB 中时，所有的值都来自于内存。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7dee8c45b87?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<h4 id="软件-TLB-管理"><a href="#软件-TLB-管理" class="headerlink" title="软件 TLB 管理"></a>软件 TLB 管理</h4><p>直到现在，我们假设每台电脑都有可以被硬件识别的页表，外加一个 TLB。在这个设计中，TLB 管理和处理 TLB 错误完全由硬件来完成。仅仅当页面不在内存中时，才会发生操作系统的<code>陷入(trap)</code>。</p>
<p>在以前，我们上面的假设通常是正确的。但是，许多现代的 <code>RISC</code> 机器，包括 SPARC、MIPS 和 HP PA，几乎所有的页面管理都是在软件中完成的。</p>
<blockquote>
<p>精简指令集计算机或 RISC 是一种计算机指令集，它使计算机的微处理器的每条指令（CPI）周期比复杂指令集计算机（CISC）少</p>
</blockquote>
<p>在这些计算机上，TLB 条目由操作系统显示加载。当发生 TLB 访问丢失时，<strong>不再是由 MMU 到页表中查找并取出需要的页表项，而是生成一个 TLB 失效并将问题交给操作系统解决</strong>。操作系统必须找到该页，把它从 TLB 中移除（移除页表中的一项），然后把新找到的页放在 TLB 中，最后再执行先前出错的指令。然而，所有这些操作都必须通过少量指令完成，因为 TLB 丢失的发生率要比出错率高很多。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df00142510?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>无论是用硬件还是用软件来处理 TLB 失效，常见的方式都是找到页表并执行索引操作以定位到将要访问的页面，在软件中进行搜索的问题是保存页表的页可能不在 TLB 中，这将在处理过程中导致其他 TLB 错误。改善方法是可以在内存中的固定位置维护一个大的 TLB 表项的高速缓存来减少 TLB 失效。通过首先检查软件的高速缓存，<code>操作系统</code> 能够有效的减少 TLB 失效问题。</p>
<p>TLB 软件管理会有两种 TLB 失效问题，当一个页访问在内存中而不在 TLB 中时，将产生 <code>软失效(soft miss)</code>，那么此时要做的就是把页表更新到 TLB 中（我们上面探讨的过程），而不会产生磁盘 I/O，处理仅仅需要一些机器指令在几纳秒的时间内完成。然而，当页本身不在内存中时，将会产生<code>硬失效(hard miss)</code>，那么此时就需要从磁盘中进行页表提取，硬失效的处理时间通常是软失效的百万倍。在页表结构中查找映射的过程称为 <code>页表遍历(page table walk)</code>。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df1855c112?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>上面的这两种情况都是理想情况下出现的现象，但是在实际应用过程中情况会更加复杂，未命中的情况可能既不是硬失效又不是软失效。一些未命中可能更<code>软</code>或更<code>硬</code>（偷笑）。比如，如果页表遍历的过程中没有找到所需要的页，那么此时会出现三种情况：</p>
<ul>
<li>  所需的页面就在内存中，但是却没有记录在进程的页表中，这种情况可能是由其他进程从磁盘掉入内存，这种情况只需要把页正确映射就可以了，而不需要在从硬盘调入，这是一种软失效，称为 <code>次要缺页错误(minor page fault)</code>。</li>
<li>  基于上述情况，如果需要从硬盘直接调入页面，这就是<code>严重缺页错误(major page falut)</code>。</li>
<li>  还有一种情况是，程序可能访问了一个非法地址，根本无需向 TLB 中增加映射。此时，操作系统会报告一个 <code>段错误(segmentation fault)</code> 来终止程序。只有第三种缺页属于程序错误，其他缺页情况都会被硬件或操作系统以降低程序性能为代价来修复</li>
</ul>
<h3 id="针对大内存的页表"><a href="#针对大内存的页表" class="headerlink" title="针对大内存的页表"></a>针对大内存的页表</h3><p>还记得我们讨论的是什么问题吗？（捂脸），可能讨论的太多你有所不知道了，我再提醒你一下，上面<code>加速分页</code>过程讨论的是<strong>虚拟地址到物理地址的映射速度必须要快</strong>的问题，还有一个问题是 <strong>如果虚拟地址空间足够大，那么页表也会足够大</strong>的问题，如何处理巨大的虚拟地址空间，下面展开我们的讨论。</p>
<h4 id="多级页表"><a href="#多级页表" class="headerlink" title="多级页表"></a>多级页表</h4><p>第一种方案是使用<code>多级页表(multi)</code>，下面是一个例子</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df15cc2753?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>32 位的虚拟地址被划分为 10 位的 PT1 域，10 位的 PT2 域，还有 12 位的 Offset 域。因为偏移量是 12 位，所以页面大小是 4KB，公有 2^20 次方个页面。</p>
<p><strong>引入多级页表的原因是避免把全部页表一直保存在内存中。不需要的页表就不应该保留</strong>。</p>
<p>多级页表是一种分页方案，它由两个或多个层次的分页表组成，也称为分层分页。级别1（level 1）页面表的条目是指向级别 2（level 2） 页面表的指针，级别2页面表的条目是指向级别 3（level 3） 页面表的指针，依此类推。最后一级页表存储的是实际的信息。</p>
<p>下面是一个二级页表的工作过程</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df1d7f2703?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>在最左边是顶级页表，它有 1024 个表项，对应于 10 位的 PT1 域。当一个虚拟地址被送到 MMU 时，MMU 首先提取 PT1 域并把该值作为访问顶级页表的索引。因为整个 4 GB （即 32 位）虚拟地址已经按 4 KB 大小分块，所以顶级页表中的 1024 个表项的每一个都表示 4M 的块地址范围。</p>
<p>由索引顶级页表得到的表项中含有二级页表的地址或页框号。顶级页表的表项 0 指向程序正文的页表，表项 1 指向含有数据的页表，表项 1023 指向堆栈的页表，其他的<code>项（用阴影表示）</code>表示没有使用。现在把 PT2 域作为访问选定的二级页表的索引，以便找到虚拟页面的对应页框号。</p>
<h4 id="倒排页表"><a href="#倒排页表" class="headerlink" title="倒排页表"></a>倒排页表</h4><p>针对分页层级结构中不断增加的替代方法是使用 <code>倒排页表(inverted page tables)</code>。采用这种解决方案的有 PowerPC、UltraSPARC 和 Itanium。在这种设计中，实际内存中的每个页框对应一个表项，而不是每个虚拟页面对应一个表项。</p>
<p>虽然倒排页表节省了大量的空间，但是它也有自己的缺陷：那就是从虚拟地址到物理地址的转换会变得很困难。当进程 n 访问虚拟页面 p 时，硬件不能再通过把 p 当作指向页表的一个索引来查找物理页。而是必须搜索整个倒排表来查找某个表项。另外，搜索必须对每一个内存访问操作都执行一次，而不是在发生缺页中断时执行。</p>
<p>解决这一问题的方式时使用 TLB。当发生 TLB 失效时，需要用软件搜索整个倒排页表。一个可行的方式是建立一个散列表，用虚拟地址来散列。当前所有内存中的具有相同散列值的虚拟页面被链接在一起。如下图所示</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df20c0bac4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>如果散列表中的槽数与机器中物理页面数一样多，那么散列表的冲突链的长度将会是 1 个表项的长度，这将会大大提高映射速度。一旦页框被找到，新的（虚拟页号，物理页框号）就会被装在到 TLB 中。</p>
<h2 id="刊误"><a href="#刊误" class="headerlink" title="刊误"></a>刊误</h2><p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ae7df30ab2ada?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>P115 页，两条线位置画反，根据下面的描述很容易误导他人，望修正。</p>
<p>文章参考：</p>
<p><a href="https://en.wikipedia.org/wiki/Page_replacement_algorithm">en.wikipedia.org/wiki/Page_r…</a></p>
<p><a href="http://faculty.salina.k-state.edu/tim/ossg/Memory/virt_mem/page_replace.html">faculty.salina.k-state.edu/tim/ossg/Me…</a></p>
<p><a href="https://www.geeksforgeeks.org/page-replacement-algorithms-in-operating-systems/">www.geeksforgeeks.org/page-replac…</a></p>
<p><a href="https://www.geeksforgeeks.org/multilevel-paging-in-operating-system/">www.geeksforgeeks.org/multilevel-…</a></p>
<p><a href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">en.wikipedia.org/wiki/Transl…</a></p>
<p><a href="https://electricalvoice.com/instruction-word-size-8085-microprocessor/">electricalvoice.com/instruction…</a></p>
<p><a href="https://en.wikipedia.org/wiki/Page_table">en.wikipedia.org/wiki/Page_t…</a></p>
<p><a href="https://www.javatpoint.com/os-page-table">www.javatpoint.com/os-page-tab…</a></p>
<p><a href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98/103614?fr=aladdin">baike.baidu.com/item/内存/103…</a></p>
<p><a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E6%AE%B5/5136260?fromtitle=data%20segment&fromid=18082638&fr=aladdin">baike.baidu.com/item/数据段/51…</a></p>
<p><a href="https://blog.csdn.net/One_L_Star/article/details/81901186">blog.csdn.net/One_L_Star/…</a></p>
<p>《现代操作系统》第四版</p>
<p>《Modern Operation System》fourth</p>
<p><a href="https://baike.baidu.com/item/SATA%E7%A1%AC%E7%9B%98/3947233?fr=aladdin">baike.baidu.com/item/SATA硬盘…</a></p>
<p><a href="https://baike.baidu.com/item/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80/1329947?fr=aladdin">baike.baidu.com/item/虚拟地址/1…</a></p>
<p><a href="https://juejin.im/post/5e61eafff265da574c5683db?utm_source=gold_browser_extension">原文</a></p>
]]></content>
      <categories>
        <category>操作系统</category>
        <category>通用</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>大家都在哪里找数据?</title>
    <url>/2021/06/20/%E5%A4%A7%E5%AE%B6%E9%83%BD%E5%9C%A8%E5%93%AA%E9%87%8C%E6%89%BE%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<h2 id="金融财经数据"><a href="#金融财经数据" class="headerlink" title="金融财经数据"></a>金融财经数据</h2><ol>
<li> <a href="https://link.zhihu.com/?target=http://data.10jqka.com.cn/">同花顺数据中心</a>：提供股票债券等金融数据</li>
<li> <a href="https://link.zhihu.com/?target=http://data.hexun.com/">和讯数据</a>：提供各种股票、基金、外汇、债券等实时数据，有付费，有免费</li>
<li> <a href="https://link.zhihu.com/?target=https://www.01caijing.com/data/index.htm">零壹财经</a>：大大小小的网贷数据、排行榜等</li>
<li> <a href="https://link.zhihu.com/?target=http://dc.xinhua08.com/">金融数据网</a>：提供每日的黄金、汇率、农产品、汽油价格的相关数据</li>
<li> <a href="https://link.zhihu.com/?target=https://robo.datayes.com/v2/home">萝卜投研</a>：提供股市、证券等数据，多以数据研究报告形式展示</li>
<li> <a href="https://link.zhihu.com/?target=http://www.jrj.com.cn/">金融界</a>：提供股市、融资等各种资金流向数据，以及丰富的财报和研报</li>
<li> <a href="https://link.zhihu.com/?target=http://www.eastmoney.com/">东方财富网</a>：提供多国的股票、财税、行业、消费等大量丰富的经济数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.51test.net/jinrong/jilin/jilin/">吉林金融网</a>：提供吉林的融资、市场数据</li>
<li> <a href="https://link.zhihu.com/?target=http://q.stock.sohu.com/zs/000001/index.shtml">搜狐证券</a>：提供货币、外汇、行业、市场等宏观数据</li>
<li> <a href="https://link.zhihu.com/?target=http://www.wisers.com.cn/finance">CCER经济金融数据库</a>：提供企业财务年度数据、股票收益数据等数据库下载</li>
<li> <a href="https://link.zhihu.com/?target=https://www.hkma.gov.hk/chi/">香港金融管理局</a>：提供香港的各种经济及金融数据，以宏观数据为主</li>
<li> <a href="https://link.zhihu.com/?target=http://www.wefore.com/show-model3-7.html">世纪未来</a>：数据服务平台，提供银行业务研究、金融大数据等各种付费数据</li>
<li> <a href="https://link.zhihu.com/?target=http://finance.sina.com.cn/mac/">新浪财经</a>：提供国内国民经济、行业信息、对外经贸、居民收入等各种宏观的经济数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.ceicdata.com/zh-hans">司尔亚司数据信息有限公司</a>：覆盖超过195+个国家的经济数据库，数据全面但收费</li>
<li> <a href="https://link.zhihu.com/?target=https://www.insee.fr/en/accueil">INSEE数据</a>：法国统计与经济研究院公开数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.chinaventure.com.cn/cmsmodel/report/list.shtml">投中研究院</a>：提供投资领域的分析报告，网站更新频率较高</li>
</ol>
<h2 id="互联网数据"><a href="#互联网数据" class="headerlink" title="互联网数据"></a>互联网数据</h2><p>新增加一个数据搜索平台</p>
<p><a href="https://link.zhihu.com/?target=http://t.cn/A6V68bED">镝数聚—全行业数据聚合</a></p>
<p>网站提供12大领域、100+行业、6000+权威数据源，基本覆盖了所有的细分行业。首页就有全面又详细的数据分类，可以直接点击分类查看也可以通过关键词查询。</p>
<p><img src="https://pic1.zhimg.com/50/v2-cd62c16c472488eb1fd1e0b1170971bf_hd.jpg?source=1940ef5c"></p>
<p><img src="https://pic1.zhimg.com/80/v2-cd62c16c472488eb1fd1e0b1170971bf_720w.jpg?source=1940ef5c"></p>
<p>绝大部分数据都可以免费下载，每日数据更新，数据的结构性好，既可下载原始数据，也可查看可视化效果。收藏夹安排起来~</p>
<p><img src="https://pic2.zhimg.com/50/v2-dd64e4834336c107e4bf0909471afe38_hd.jpg?source=1940ef5c"></p>
<p><img src="https://pic2.zhimg.com/80/v2-dd64e4834336c107e4bf0909471afe38_720w.jpg?source=1940ef5c"></p>
<p><strong>营销查询：</strong></p>
<ol>
<li> <a href="https://link.zhihu.com/?target=https://www.5118.com/">5118</a> / <a href="https://link.zhihu.com/?target=http://tool.chinaz.com/">chinaz</a>：支持查询网站排名及发展趋势、百度收录情况等信息</li>
<li> <a href="https://link.zhihu.com/?target=http://index.baidu.com/v2/index.html%23/">百度指数</a>：百度旗下/以百度网民行为数据为基础的数据分享平台，支持查询需求图谱</li>
<li> 微信指数：微信旗下/基于微信大数据分析的移动端指数，打开微信→搜索“微信指数”可用</li>
<li> <a href="https://link.zhihu.com/?target=http://mi.talkingdata.com/">移动观象台</a>：基于移动设备用户的操作行为，提供应用、公众号排行等，以及大量数据报告</li>
<li> <a href="https://link.zhihu.com/?target=https://www.newrank.cn/public/info/list.html?period=week&type=data">新榜</a>/<a href="https://link.zhihu.com/?target=https://data.wxb.com/rank">微小宝</a>/易赞：几款工具比较类似，支持查看公众号排行、看公众号人群画像等功能</li>
<li> <a href="https://link.zhihu.com/?target=http://index.1688.com/">阿里指数</a>：阿里旗下/反映淘宝平台市场动向的数据分析平台</li>
</ol>
<p><strong>报告分析：</strong></p>
<ol>
<li> <a href="https://link.zhihu.com/?target=http://www.199it.com/archives/tag/%25E6%2598%2593%25E8%25A7%2582%25E6%2599%25BA%25E5%25BA%2593">易观智库</a>：199IT导航的母网站，权威的互联网数据平台，涵盖战略新兴产业、电商互联网、共享经济、社交营销、移动互联网以及其他互联网服务的数据及分析报告</li>
<li> <a href="https://link.zhihu.com/?target=http://www.iresearch.cn/">艾瑞网</a>：高频率更新互联网前沿的新闻资讯、分析报告，旗下包括艾瑞指数、艾瑞咨询等</li>
<li> <a href="https://link.zhihu.com/?target=https://www.iimedia.cn/%23shuju">艾媒网</a>：艾媒与艾瑞无关，艾媒网发布的研究报告多偏向移动互联网方向</li>
<li> <a href="https://link.zhihu.com/?target=https://www.cbndata.com/report">CBNDdata</a>：以阿里巴巴的商业数据库为基础，输出产业经济分析报告</li>
<li> <a href="https://link.zhihu.com/?target=http://www.questmobile.com.cn/blog.html">QuestMobile</a>：周期性地发布一些关于APP的研究报告</li>
<li> <a href="https://link.zhihu.com/?target=http://www.aliresearch.com/blog/index/lists/tag/3831.html">阿里研究院</a>：阿里旗下/发布研究电商等方向趋势的数据报告，内容多与阿里相关</li>
<li> <a href="https://link.zhihu.com/?target=http://zt.360.cn/report/">360研究报告</a>：360旗下/移动、PC、网站、企业、诈骗等安全领域的研究，以及大数据等非安全领域的研究</li>
<li> <a href="https://link.zhihu.com/?target=http://www.cnnic.net.cn/hlwfzyj/">中国互联网信息研究中心</a>：经国家主管部门批准组建的管理和服务机构，经常发布一些有价值的互联网信息报告</li>
<li> <a href="https://link.zhihu.com/?target=http://www.caict.ac.cn/kxyj/qwfb/bps/">中国信通院</a>：针对互联网多个行业的发展趋势，发布白皮书，角度较为宏观</li>
<li> <a href="https://link.zhihu.com/?target=http://www.cnidp.cn/">中国互联网数据平台</a>：提供全国各地区互联网发展报告、基础数据及研究分析报告，数据及报告偏向学术性研究</li>
<li> <a href="https://link.zhihu.com/?target=http://www.gsdata.cn/">清博大数据</a>：提供微信、微博、头条榜单数据，各种研究报告、数据报告、舆情报告及行业热点</li>
<li> <a href="https://link.zhihu.com/?target=http://www.cbdio.com/">数据观</a>：丰富的前沿行业资讯，及部分研究报告下载</li>
<li> <a href="https://link.zhihu.com/?target=https://data.qq.com/">腾讯大数据</a>：数据服务平台，提供调查研究、移动互联网及特色数据报告，质量较高</li>
<li> <a href="https://link.zhihu.com/?target=http://www.thebigdata.cn/">大数据世界</a>：提供大数据相关资讯、应用案例、技术方案及资料下载</li>
</ol>
<h2 id="地理数据"><a href="#地理数据" class="headerlink" title="地理数据"></a><strong>地理数据</strong></h2><p><strong>水土气候数据：</strong></p>
<ol>
<li> 水土保持生态建设网<a href="https://link.zhihu.com/?target=http://www.swcc.org.cn/">http://www.swcc.org.cn/</a></li>
<li> 黄河风情<a href="https://link.zhihu.com/?target=http://www.yellowriver.org/">http://www.yellowriver.org/</a></li>
<li> 黄河流域数据中心<a href="https://link.zhihu.com/?target=http://henu.geodata.cn/index.jsp">http://henu.geodata.cn/index.jsp</a></li>
<li> 黄土高原水土保护数据库<a href="https://link.zhihu.com/?target=http://www.loess.csdb.cn/">http://www.loess.csdb.cn/</a></li>
<li> 数字黑河<a href="https://link.zhihu.com/?target=http://heihe.westgis.ac.cn/Default.aspx?tabid=106">http://heihe.westgis.ac.cn/Default.aspx?tabid=106</a></li>
<li> 大气科学数据库<a href="https://link.zhihu.com/?target=http://data.iap.ac.cn/">http://data.iap.ac.cn/</a></li>
<li> 中国气象科学数据<a href="https://link.zhihu.com/?target=http://cdc.cma.gov.cn/">http://cdc.cma.gov.cn/</a></li>
<li> 中国气象科学数据共享服务网<a href="https://link.zhihu.com/?target=http://cdc.cma.gov.cn/">http://cdc.cma.gov.cn/</a></li>
<li> 全球森林土地覆盖动态<a href="https://link.zhihu.com/?target=http://www.fao.org/gtos/gofc-gold/">http://www.fao.org/gtos/gofc-gold/</a></li>
<li> FRA 2000<a href="https://link.zhihu.com/?target=http://edcsns17.cr.usgs.gov/glcc/fao/index.html">http://edcsns17.cr.usgs.gov/glcc/fao/index.html</a>全球森林资源</li>
<li> NOAA<a href="https://link.zhihu.com/?target=http://www.noaa.gov/">http://www.noaa.gov/</a>美国国家海洋和大气管理局</li>
<li> NCDC <a href="https://link.zhihu.com/?target=http://lwf.ncdc.noaa.gov/oa/ncdc.html%25E7%25BE%258E%25E5%259B%25BD%25E5%259B%25BD%25E5%25AE%25B6%25E6%25B0%2594%25E5%2580%2599%25E6%2595%25B0%25E6%258D%25AE%25E4%25B8%25AD%25E5%25BF%2583">http://lwf.ncdc.noaa.gov/oa/ncdc.html美国国家气候数据中心</a></li>
<li> 国际水管理研究所<a href="https://link.zhihu.com/?target=http://www.iwmidsp.org/iwmi/info/main.asp">http://www.iwmidsp.org/iwmi/info/main.asp</a></li>
<li> 气候研究所<a href="https://link.zhihu.com/?target=http://www.cru.uea.ac.uk/">http://www.cru.uea.ac.uk/</a></li>
<li> 植被覆盖数据<a href="https://link.zhihu.com/?target=http://www.vgt.vito.be/">http://www.vgt.vito.be/</a></li>
</ol>
<p><strong>环境数据：</strong></p>
<ol>
<li> 黄土区农业与生态环境数据分中心<a href="https://link.zhihu.com/?target=http://loess.geodata.cn/">http://loess.geodata.cn/</a></li>
<li> 东北黑土农业生态数据库<a href="https://link.zhihu.com/?target=http://www.blackland.csdb.cn/default.asp">http://www.blackland.csdb.cn/default.asp</a></li>
<li> 中国西部环境与生态科学数据中心<a href="https://link.zhihu.com/?target=http://westdc.westgis.ac.cn/">http://westdc.westgis.ac.cn/</a></li>
<li> 西部数据中心<a href="https://link.zhihu.com/?target=http://westdc.westgis.ac.cn/data">http://westdc.westgis.ac.cn/data</a></li>
<li> 黄土高原区域数据共享运行服务中心<a href="https://link.zhihu.com/?target=http://loess.geodata.cn/Portal/?isCookieChecked=true">http://loess.geodata.cn/Portal/?isCookieChecked=true</a></li>
</ol>
<p><strong>遥感数据：</strong></p>
<ol>
<li> 地面站RS地图查询<a href="https://link.zhihu.com/?target=http://cs.rsgs.ac.cn/cs_cn/query/query_map.asp">http://cs.rsgs.ac.cn/cs_cn/query/query_map.asp</a></li>
<li> 甘肃省基础地理信息中心<a href="https://link.zhihu.com/?target=http://www.cehuiju.gansu.gov.cn/5chcg/giscenter.asp">http://www.cehuiju.gansu.gov.cn/5chcg/giscenter.asp</a></li>
<li> 遥感数据网络资源<a href="https://link.zhihu.com/?target=http://ecology.bnu.edu.cn/gejp/student/zhj/webresource.htm">http://ecology.bnu.edu.cn/gejp/student/zhj/webresource.htm</a></li>
<li> 中国遥感数据网<a href="https://link.zhihu.com/?target=http://ids.ceode.ac.cn/">http://ids.ceode.ac.cn/</a></li>
<li> GLCF <a href="https://link.zhihu.com/?target=http://glcf.geodata.cn/etm/Welcome.do">http://glcf.geodata.cn/etm/Welcome.do</a></li>
<li> GIS FORUM <a href="https://link.zhihu.com/?target=http://www.gisforum.net/%25E5%2585%25A8%25E7%2590%2583%25E6%259C%2580%25E5%25A4%25A7%25E7%259A%2584GIS%25E4%25B8%25AD%25E6%2596%2587%25E9%2597%25A8%25E6%2588%25B7%25E7%25BD%2591%25E7%25AB%2599">http://www.gisforum.net/全球最大的GIS中文门户网站</a></li>
<li> 遥感数据共享<a href="https://link.zhihu.com/?target=http://ids.ceode.ac.cn/">http://ids.ceode.ac.cn/</a></li>
</ol>
<p><strong>其他自然人文数据：</strong></p>
<ol>
<li> 地理国情监测云平台 <a href="https://link.zhihu.com/?target=http://www.dsac.cn/">http://www.dsac.cn/</a></li>
<li> 中国资源卫星应用中心 <a href="https://link.zhihu.com/?target=http://www.cresda.com/cn/profile.htm">http://www.cresda.com/cn/profile.htm</a></li>
<li> 中国自然资源数据库 <a href="https://link.zhihu.com/?target=http://www.data.ac.cn/index.asp">http://www.data.ac.cn/index.asp</a></li>
<li> 中国科学院资源环境科学数据中心 <a href="https://link.zhihu.com/?target=http://www.resdc.cn/resdc/first.asp">http://www.resdc.cn/resdc/first.asp</a></li>
<li> 中国地球系统科学数据共享网 <a href="https://link.zhihu.com/?target=http://www.geodata.cn:8086/Metadata/index.jsp">http://www.geodata.cn:8086/Metadata/index.jsp</a></li>
<li> 国家地球系统科学数据共享服务平台 <a href="https://link.zhihu.com/?target=http://www.geodata.cn/">http://www.geodata.cn/</a></li>
<li> <a href="https://link.zhihu.com/?target=http://pm25.in/">PM25.in | PM2.5(细颗粒物)及空气质量指数(AQI)实时查询！</a>：中国空气质量监测实时数据<a href="https://link.zhihu.com/?target=http://pm25.in/">http://pm25.in/</a></li>
<li> 国际科学数据服务平台 <a href="https://link.zhihu.com/?target=http://datamirror.csdb.cn/index.jsp">http://datamirror.csdb.cn/index.jsp</a></li>
<li> 原始数据搜索 <a href="https://link.zhihu.com/?target=https://wist.echo.nasa.gov/api">https://wist.echo.nasa.gov/api</a></li>
<li> 中国科学院资源环境科学数据中心 <a href="https://link.zhihu.com/?target=http://www.resdc.cn/resdc/first.asp">http://www.resdc.cn/resdc/first.asp</a></li>
<li> 世界聚集人口数据 <a href="https://link.zhihu.com/?target=http://beta.sedac.ciesin.columbia.edu/gpw/index.jsp">http://beta.sedac.ciesin.columbia.edu/gpw/index.jsp</a></li>
<li> 光谱数据分析网站 <a href="https://link.zhihu.com/?target=http://modis.gsfc.nasa.gov/">http://modis.gsfc.nasa.gov/</a></li>
<li> 美国航空航天局NASA <a href="https://link.zhihu.com/?target=http://daac.gsfc.nasa.gov/">http://daac.gsfc.nasa.gov/</a></li>
<li> 城市轨道交通<a href="https://link.zhihu.com/?target=http://www.ntsg.umt.edu/">http://www.ntsg.umt.edu/</a></li>
<li> 人地系统主题数据库<a href="https://link.zhihu.com/?target=http://webpanda.iis.u-tokyo.ac.jp/">http://webpanda.iis.u-tokyo.ac.jp/</a></li>
</ol>
<p><strong>影像数据：</strong></p>
<ol>
<li> <a href="https://link.zhihu.com/?target=https://earthexplorer.usgs.gov/">USGS Earth Explorer</a>：提供Landsat、MODIS等数据</li>
<li> <a href="https://link.zhihu.com/?target=https://scihub.copernicus.eu/dhus/%23/home">ESA’s Sentinel Mission</a>：提供Sentinel系列卫星数据，可以下载欧洲航天局所属的影像数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.avl.class.noaa.gov/saa/products/welcome;jsessionid=FFC5D89936910E14B9D9220EC684138C">NOAA CLASS</a>：提供高品质大气数据集，包括美国国防部（DoD）、极地作战环境卫星（POES）、NOAA的地球静止环境卫星（GOES）以及其他派生数据</li>
<li> <a href="https://link.zhihu.com/?target=https://reverb.echo.nasa.gov/reverb/%23utf8=%25E2%259C%2593&spatial_map=satellite&spatial_type=rectangle">NASA Reverb</a>：提供多种类数据，包括：Aqua, Terra, Aura, TRMM, Calipso, NASA DC, JASON, ENVISAT等</li>
<li> <a href="https://link.zhihu.com/?target=https://earth.esa.int/web/guest/eoli-sa-dismissed;jsessionid=40706D0F248CFB22BEFC95C0839A693C.jvm2">EOLi</a>：欧洲航天局的地球观测目录和订购服务的客户，通过Java 程序下载数据，支持的数据包括：Envisat, ERS, IKONOS, DMC, ALOS, SPOT, Kompsat, Proba, IRS, SCISAT.</li>
<li> <a href="https://link.zhihu.com/?target=http://www.dgi.inpe.br/CDSR/">INPE</a>：提供中巴资源卫星数据</li>
<li> <a href="https://link.zhihu.com/?target=https://bhuvan-app3.nrsc.gov.in/data/download/index.php">Bhuvan Indian Geo-Platform of ISRO</a>：提供印度境内的MS-1， Cartosat,，OceanSat and ResourceSat数据以及全球的NVDI数据、南亚国家的CartoDem Version -3R1数据和北印度洋的气候数据</li>
</ol>
<p><strong>政府数据</strong></p>
<ol>
<li> <a href="https://link.zhihu.com/?target=https://data.gov.sg/">新加坡政府公开数据</a>：提供新加坡各类数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.data.gov/">美国政府公开数据</a>：提供美国全国各类数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.data.gouv.fr/en/">法国政府公开数据</a>：法国政府开放数据平台</li>
<li> <a href="https://link.zhihu.com/?target=https://data.gov.uk/">英国政府公开数据</a>：提供英国各类数据</li>
<li> <a href="https://link.zhihu.com/?target=http://data.stats.gov.cn/">国家数据</a>：中国国家统计局权威数据</li>
<li> <a href="https://link.zhihu.com/?target=http://www.stats.gov.cn/tjsj/ndsj/">中国统计年鉴</a>：1999年至今中国统计年鉴，国家统计局官网，提供单页Excel文件下载</li>
<li> <a href="https://link.zhihu.com/?target=http://www.tjcn.org/">中国统计信息网</a>：全国及各级政府各年度统计公报、年鉴等，为收费数据</li>
<li> <a href="https://link.zhihu.com/?target=https://www.nianjianwang.com/">年鉴汪</a>：全国城市统计数据搜索引擎，浏览免费，下载收费</li>
<li> <a href="https://link.zhihu.com/?target=https://data.london.gov.uk/">伦敦市公开数据</a>：提供伦敦人口、就业、环境等各类数据</li>
<li> <a href="https://link.zhihu.com/?target=http://data.mlr.gov.cn/">国土资源部</a>：国土资源部对外公开的信息报告</li>
</ol>
<p><strong>其他细分行业数据</strong></p>
<ol>
<li> <a href="https://link.zhihu.com/?target=http://www.chinairn.com/data/">中研网数据</a>：提供医疗、房产、制造业、服务业、零售消费、车辆等全行业数据</li>
<li> <a href="https://link.zhihu.com/?target=http://www.chinabgao.com/stat">中国报告大厅</a>：提供各行各业的基础数据、调查报告、分析报告、预测报告，种类丰富</li>
<li> <a href="https://link.zhihu.com/?target=https://cadmapper.com/">CADMAPPER</a>：世界各大城市的DXF文件，原始数据源为OSM，NASA，USGS</li>
<li> <a href="https://link.zhihu.com/?target=https://registry.opendata.aws/">亚马逊网络服务公共数据集</a>：跨科学云数据平台，包含化学、生物、经济等多个领域的数据集</li>
<li> <a href="https://link.zhihu.com/?target=https://github.com/awesomedata/awesome-public-datasets">Awesome Public Datasets</a>：Github公共数据搜集项目，自然科学、社会科学覆盖较面，包含各个细分领域的数据库资源。</li>
<li> <a href="https://link.zhihu.com/?target=https://figshare.com/">figshare</a>：数据分析与研究成果共享平台。</li>
<li> <a href="https://link.zhihu.com/?target=https://ukdataexplorer.com/">英国公开数据浏览工具</a>：James Trimble制作的英国数据可视化浏览工具集；</li>
<li> <a href="https://link.zhihu.com/?target=https://datafrance.info/">数据法国</a>：法国各类数据的可视化呈现；</li>
<li> <a href="https://link.zhihu.com/?target=https://www.dataeye.com/report">DataEye</a>：基于国内游戏、汽车行业数据，进行多角度的行业调查报告撰写发布</li>
<li> <a href="https://link.zhihu.com/?target=http://www.cbooo.cn/">CBO中国票房</a>：基于国内票房数据，统计票房排行、上座率等信息。</li>
<li> <a href="https://link.zhihu.com/?target=http://index.bitauto.com/login">易车指数</a>：反映国内汽车销售市场，为购车者或汽车从业者提供参考的数据指数</li>
<li> <a href="https://link.zhihu.com/?target=https://report.amap.com/detail.do?city=110000">高德地图</a>：支持实时查看国内交通情况，此外高德周期性提供一系列数据报告</li>
<li> <a href="https://link.zhihu.com/?target=https://fdc.fang.com/index/">房天下</a>：提供中国指数研究院和CREIS中指数据，展示国内房地产数据情况</li>
<li> <a href="https://link.zhihu.com/?target=http://www.entgroup.com.cn/bg.aspx">艺恩</a>：CBO中国票房数据的提供方，提供一些行业数据报告，如动漫IP价值研究报告</li>
</ol>
]]></content>
      <categories>
        <category>大数据</category>
        <category>数据分析</category>
      </categories>
      <tags>
        <tag>数据分析</tag>
      </tags>
  </entry>
  <entry>
    <title>详解 Kubernetes DaemonSet 的实现原理</title>
    <url>/2020/05/24/%E8%AF%A6%E8%A7%A3-Kubernetes-DaemonSet-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p><a href="https://draveness.me/kubernetes-deployment">Deployment</a> 是 Kubernetes 中用于处理无状态服务的资源，而 <a href="https://draveness.me/kubernetes-statefulset">StatefulSet</a> 是用于支持有状态服务的资源，这两种不同的资源从状态的角度对服务进行了划分，而 DaemonSet 从不同的维度解决了集群中的问题 — 如何同时在集群中的所有节点上提供基础服务和守护进程。</p>
<p>我们在这里将介绍 DaemonSet 如何进行状态的同步、Pod 与节点（Node）之间的调度方式和滚动更新的过程以及实现原理。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>DaemonSet 可以保证集群中所有的或者部分的节点都能够运行同一份 Pod 副本，每当有新的节点被加入到集群时，Pod 就会在目标的节点上启动，如果节点被从集群中剔除，节点上的 Pod 也会被垃圾收集器清除；DaemonSet 的作用就像是计算机中的守护进程，它能够运行集群存储、日志收集和监控等『守护进程』，这些服务一般是集群中必备的基础服务。</p>
<p>Google Cloud 的 Kubernetes 集群就会在所有的节点上启动 fluentd 和 Prometheus 来收集节点上的日志和监控数据，想要创建用于日志收集的守护进程其实非常简单，我们可以使用如下所示的代码：</p>
<p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/fluentd-elasticsearch:1.20</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当我们使用 <code>kubectl apply -f</code> 创建上述的 DaemonSet 时，它会在 Kubernetes 集群的 <code>kube-system</code> 命名空间中创建 DaemonSet 资源并在所有的节点上创建新的 Pod：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ kubectl get daemonsets.apps fluentd-elasticsearch --namespace kube-system</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">fluentd-elasticsearch   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">1</span>            <span class="number">1</span>           &lt;none&gt;          <span class="number">19</span>h</span><br><span class="line"></span><br><span class="line">$ kubectl get pods --namespace kube-system --label name=fluentd-elasticsearch</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">fluentd-elasticsearch-kvtwj   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">19</span>h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于集群中只存在一个 Pod，所以 Kubernetes 只会在该节点上创建一个 Pod，如果我们向当前的集群中增加新的节点时，Kubernetes 就会创建在新节点上创建新的副本，总的来说，我们能够得到以下的拓扑结构：</p>
<p><img src="https://img.draveness.me/2019-03-01-DaemonSet-Topology.png" alt="DaemonSet-Topology"></p>
<p>集群中的 Pod 和 Node 一一对应，而 DaemonSet 会管理全部机器上的 Pod 副本，负责对它们进行更新和删除。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>所有的 DaemonSet 都是由控制器负责管理的，与其他的资源一样，用于管理 DaemonSet 的控制器是 <code>DaemonSetsController</code>，该控制器会监听 DaemonSet、ControllerRevision、Pod 和 Node 资源的变动。</p>
<p><img src="https://img.draveness.me/2019-03-01-DaemonSet-FlowChart.png" alt="DaemonSet-FlowChart"></p>
<p>大多数的触发事件最终都会将一个待处理的 DaemonSet 资源入栈，下游 <code>DaemonSetsController</code> 持有的多个工作协程就会从队列里面取出资源进行消费和同步。</p>
<h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p><code>DaemonSetsController</code> 同步 DaemonSet 资源使用的方法就是 <code>syncDaemonSet</code>，这个方法从队列中拿到 DaemonSet 的名字时，会先从集群中获取最新的 DaemonSet 对象并通过 <code>constructHistory</code> 方法查找当前 DaemonSet 全部的历史版本：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsc *DaemonSetsController)</span> <span class="title">syncDaemonSet</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	namespace, name, _ := cache.SplitMetaNamespaceKey(key)</span><br><span class="line">	ds, _ := dsc.dsLister.DaemonSets(namespace).Get(name)</span><br><span class="line">	dsKey, _ := controller.KeyFunc(ds)</span><br><span class="line"></span><br><span class="line">	cur, old, _ := dsc.constructHistory(ds)</span><br><span class="line">	hash := cur.Labels[apps.DefaultDaemonSetUniqueLabelKey]</span><br><span class="line"></span><br><span class="line">	dsc.manage(ds, hash)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> ds.Spec.UpdateStrategy.Type &#123;</span><br><span class="line">	<span class="keyword">case</span> apps.OnDeleteDaemonSetStrategyType:</span><br><span class="line">	<span class="keyword">case</span> apps.RollingUpdateDaemonSetStrategyType:</span><br><span class="line">		dsc.rollingUpdate(ds, hash)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dsc.cleanupHistory(ds, old)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dsc.updateDaemonSetStatus(ds, hash, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后调用的 <code>manage</code> 方法会负责管理 DaemonSet 在节点上 Pod 的调度和运行，<code>rollingUpdate</code> 会负责 DaemonSet 的滚动更新；前者会先找出找出需要运行 Pod 和不需要运行 Pod 的节点，并调用 <code>syncNodes</code> 对这些需要创建和删除的 Pod 进行同步：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsc *DaemonSetsController)</span> <span class="title">syncNodes</span><span class="params">(ds *apps.DaemonSet, podsToDelete, nodesNeedingDaemonPods []<span class="keyword">string</span>, hash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	dsKey, _ := controller.KeyFunc(ds)</span><br><span class="line">	generation, err := util.GetTemplateGeneration(ds)</span><br><span class="line">	template := util.CreatePodTemplate(ds.Spec.Template, generation, hash)</span><br><span class="line"></span><br><span class="line">	createDiff := <span class="built_in">len</span>(nodesNeedingDaemonPods)</span><br><span class="line">	createWait := sync.WaitGroup&#123;&#125;</span><br><span class="line">	createWait.Add(createDiff)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; createDiff; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> createWait.Done()</span><br><span class="line"></span><br><span class="line">			podTemplate := template.DeepCopy()</span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ScheduleDaemonSetPods) &#123;</span><br><span class="line">				podTemplate.Spec.Affinity = util.ReplaceDaemonSetPodNodeNameNodeAffinity(podTemplate.Spec.Affinity, nodesNeedingDaemonPods[ix])</span><br><span class="line">				dsc.podControl.CreatePodsWithControllerRef(ds.Namespace, podTemplate, ds, metav1.NewControllerRef(ds, controllerKind))</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				podTemplate.Spec.SchedulerName = <span class="string">&quot;kubernetes.io/daemonset-controller&quot;</span></span><br><span class="line">				dsc.podControl.CreatePodsOnNode(nodesNeedingDaemonPods[ix], ds.Namespace, podTemplate, ds, metav1.NewControllerRef(ds, controllerKind))</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">	createWait.Wait()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>获取了 DaemonSet 中的模板之之后，就会开始并行地为节点创建 Pod 副本，并发创建的过程使用了 for 循环、Goroutine 和 <code>WaitGroup</code> 保证程序运行的正确，然而这里使用了特性开关来对调度新 Pod 的方式进行了控制，我们会在接下来的调度一节介绍 DaemonSet 调度方式的变迁和具体的执行过程。</p>
<p>当 Kubernetes 创建了需要创建的 Pod 之后，就需要删除所有节点上不必要的 Pod 了，这里使用同样地方式并发地对 Pod 进行删除：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">	deleteDiff := <span class="built_in">len</span>(podsToDelete)</span><br><span class="line">	deleteWait := sync.WaitGroup&#123;&#125;</span><br><span class="line">	deleteWait.Add(deleteDiff)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; deleteDiff; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> deleteWait.Done()</span><br><span class="line">			dsc.podControl.DeletePod(ds.Namespace, podsToDelete[ix], ds)</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">	deleteWait.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到了这里我们就完成了节点上 Pod 的调度和运行，为一些节点创建 Pod 副本的同时删除另一部分节点上的副本，<code>manage</code> 方法执行完成之后就会调用 <code>rollingUpdate</code> 方法对 DaemonSet 的节点进行滚动更新并对控制器版本进行清理并更新 DaemonSet 的状态，文章后面的部分会介绍滚动更新的过程和实现。</p>
<h3 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h3><p>在早期的 Kubernetes 版本中，所有 DaemonSet Pod 的创建都是由 <code>DaemonSetsController</code> 负责的，而其他的资源都是由 kube-scheduler 进行调度，这就导致了如下的一些问题：</p>
<ol>
<li> <code>DaemonSetsController</code> 没有办法在节点资源变更时收到通知 (<a href="https://github.com/kubernetes/kubernetes/issues/46935">#46935</a>, <a href="https://github.com/kubernetes/kubernetes/issues/58868">#58868</a>)；</li>
<li> <code>DaemonSetsController</code> 没有办法遵循 Pod 的亲和性和反亲和性设置 (<a href="https://github.com/kubernetes/kubernetes/issues/29276">#29276</a>)；</li>
<li> <code>DaemonSetsController</code> 可能需要二次实现 Pod 调度的重要逻辑，造成了重复的代码逻辑 (<a href="https://github.com/kubernetes/kubernetes/issues/42028">#42028</a>)；</li>
<li> 多个组件负责调度会导致 Debug 和抢占等功能的实现非常困难；</li>
</ol>
<p>设计文档 <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/schedule-DS-pod-by-scheduler.md">Schedule DaemonSet Pods by default scheduler, not DaemonSet controller</a> 中包含了使用 <code>DaemonSetsController</code> 调度时遇到的问题以及新设计给出的解决方案。</p>
<p>如果我们选择使用过去的调度方式，<code>DeamonSetsController</code> 就会负责在节点上创建 Pod，通过这种方式创建的 Pod 的 <code>schedulerName</code> 都会被设置成 <code>kubernetes.io/daemonset-controller</code>，但是在默认情况下这个字段一般为 <code>default-scheduler</code>，也就是使用 Kubernetes 默认的调度器 kube-scheduler 进行调度：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsc *DaemonSetsController)</span> <span class="title">syncNodes</span><span class="params">(ds *apps.DaemonSet, podsToDelete, nodesNeedingDaemonPods []<span class="keyword">string</span>, hash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; createDiff; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			podTemplate := template.DeepCopy()</span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ScheduleDaemonSetPods) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				podTemplate.Spec.SchedulerName = <span class="string">&quot;kubernetes.io/daemonset-controller&quot;</span></span><br><span class="line">				dsc.podControl.CreatePodsOnNode(nodesNeedingDaemonPods[ix], ds.Namespace, podTemplate, ds, metav1.NewControllerRef(ds, controllerKind))</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>DaemonSetsController</code> 在调度 Pod 时都会使用 <code>CreatePodsOnNode</code> 方法，这个方法的实现非常简单，它会先对 Pod 模板进行验证，随后调用 <code>createPods</code> 方法通过 Kubernetes 提供的 API 创建新的副本：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r RealPodControl)</span> <span class="title">CreatePodsWithControllerRef</span><span class="params">(namespace <span class="keyword">string</span>, template *v1.PodTemplateSpec, controllerObject runtime.Object, controllerRef *metav1.OwnerReference)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := validateControllerRef(controllerRef); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r.createPods(<span class="string">&quot;&quot;</span>, namespace, template, controllerObject, controllerRef)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>DaemonSetsController</code> 通过节点选择器和调度器的谓词对节点进行过滤，<code>createPods</code> 会直接为当前的 Pod 设置 <code>spec.NodeName</code> 属性，最后得到的 Pod 就会被目标节点上的 kubelet 创建。</p>
<p>除了这种使用 <code>DaemonSetsController</code> 管理和调度 DaemonSet 的方法之外，我们还可以使用 Kubernetes 默认的方式 kube-scheduler 创建新的 Pod 副本：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsc *DaemonSetsController)</span> <span class="title">syncNodes</span><span class="params">(ds *apps.DaemonSet, podsToDelete, nodesNeedingDaemonPods []<span class="keyword">string</span>, hash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; createDiff; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			podTemplate := template.DeepCopy()</span><br><span class="line">			<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ScheduleDaemonSetPods) &#123;</span><br><span class="line">				podTemplate.Spec.Affinity = util.ReplaceDaemonSetPodNodeNameNodeAffinity(podTemplate.Spec.Affinity, nodesNeedingDaemonPods[ix])</span><br><span class="line">				dsc.podControl.CreatePodsWithControllerRef(ds.Namespace, podTemplate, ds, metav1.NewControllerRef(ds, controllerKind))</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种情况会使用 NodeAffinity 特性来避免发生在 <code>DaemonSetsController</code> 中的调度：</p>
<ol>
<li><p> <code>DaemonSetsController</code> 会在 <code>podsShouldBeOnNode</code> 方法中根据节点选择器过滤所有的节点；</p>
</li>
<li><p>对于每一个节点，控制器都会创建一个遵循以下节点亲和的 Pod；</p>
<p> YAML</p>
 <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">nodeAffinity:</span></span><br><span class="line">  <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">      <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">in</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dest_hostname</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p> 当节点进行同步时，DaemonSetsController 会根据节点亲和的设置来验证节点和 Pod 的关系；</p>
</li>
<li><p> 如果调度的谓词失败了，DaemonSet 持有的 Pod 就会保持在 Pending 的状态，所以可以通过修改 Pod 的优先级和抢占保证集群在高负载下也能正常运行 DaemonSet 的副本；</p>
</li>
</ol>
<p>Pod 的优先级和抢占功能在 Kubernetes 1.8 版本引入，1.11 时转变成 beta 版本，在目前最新的 1.13 中依然是 beta 版本，感兴趣的读者可以阅读 <a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/">Pod Priority and Preemption</a> 文档了解相关的内容。</p>
<h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><p><code>DaemonSetsController</code> 对滚动更新的实现其实比较简单，它其实就是根据 DaemonSet 规格中的配置，删除集群中的 Pod 并保证同时不可用的副本数不会超过 <code>spec.updateStrategy.rollingUpdate.maxUnavailable</code>，这个参数也是 DaemonSet 滚动更新可以配置的唯一参数：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dsc *DaemonSetsController)</span> <span class="title">rollingUpdate</span><span class="params">(ds *apps.DaemonSet, hash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	nodeToDaemonPods, err := dsc.getNodesToDaemonPods(ds)</span><br><span class="line"></span><br><span class="line">	_, oldPods := dsc.getAllDaemonSetPods(ds, nodeToDaemonPods, hash)</span><br><span class="line">	maxUnavailable, numUnavailable, err := dsc.getUnavailableNumbers(ds, nodeToDaemonPods)</span><br><span class="line">	oldAvailablePods, oldUnavailablePods := util.SplitByAvailablePods(ds.Spec.MinReadySeconds, oldPods)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> oldPodsToDelete []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> oldUnavailablePods &#123;</span><br><span class="line">		<span class="keyword">if</span> pod.DeletionTimestamp != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		oldPodsToDelete = <span class="built_in">append</span>(oldPodsToDelete, pod.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> oldAvailablePods &#123;</span><br><span class="line">		<span class="keyword">if</span> numUnavailable &gt;= maxUnavailable &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		oldPodsToDelete = <span class="built_in">append</span>(oldPodsToDelete, pod.Name)</span><br><span class="line">		numUnavailable++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dsc.syncNodes(ds, oldPodsToDelete, []<span class="keyword">string</span>&#123;&#125;, hash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除 Pod 的顺序其实也非常简单并且符合直觉，上述代码会将不可用的 Pod 先加入到待删除的数组中，随后将历史版本的可用 Pod 加入待删除数组 <code>oldPodsToDelete</code>，最后调用 <code>syncNodes</code> 完成对副本的删除。</p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>与 <a href="https://draveness.me/kubernetes-deployment">Deployment</a>、<a href="https://draveness.me/kubernetes-replicaset">ReplicaSet</a> 和 <a href="https://draveness.me/kubernetes-statefulset">StatefulSet</a> 一样，DaemonSet 的删除也会导致它持有的 Pod 的删除，如果我们使用如下的命令删除该对象，我们能观察到如下的现象：</p>
<p>Bash</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete daemonsets.apps fluentd-elasticsearch --namespace kube-system</span><br><span class="line">daemonset.apps <span class="string">&quot;fluentd-elasticsearch&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pods --watch --namespace kube-system</span><br><span class="line">fluentd-elasticsearch-wvffx   1/1   Terminating   0     14s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这部分的工作就都是由 Kuberentes 中的垃圾收集器完成的，读者可以阅读 <a href="https://draveness.me/kubernetes-garbage-collector">垃圾收集器</a> 一文了解集群中的不同对象是如何进行关联的以及在删除单一对象时如何触发级联删除的原理。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>DaemonSet 其实就是 Kubernetes 中的守护进程，它会在每一个节点上创建能够提供服务的副本，很多云服务商都会使用 DaemonSet 在所有的节点上内置一些用于提供日志收集、统计分析和安全策略的服务。</p>
<p>在研究 DaemonSet 的调度策略的过程中，我们其实能够通过一些历史的 issue 和 PR 了解到 DaemonSet 调度策略改动的原因，也能让我们对于 Kubernetes 的演进过程和设计决策有一个比较清楚的认识。</p>
<h2 id="Referenece"><a href="#Referenece" class="headerlink" title="Referenece"></a>Referenece</h2><ul>
<li>  <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">DaemonSet · Kubernetes</a></li>
<li>  <a href="https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/">Perform a Rolling Update on a DaemonSet</a></li>
<li>  <a href="https://kubernetes.io/docs/tasks/manage-daemon/rollback-daemon-set/">Perform a Rollback on a DaemonSet</a></li>
<li>  <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/schedule-DS-pod-by-scheduler.md">Schedule DaemonSet Pods by default scheduler, not DaemonSet controller</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/issues/46935">DaemonsetController can’t feel it when node has more resources, e.g. other Pod exits</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/issues/45628">DaemonsetController can’t feel it when node recovered from outofdisk state</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/issues/42002">DaemonSet pods should be scheduled by default scheduler, not DaemonSet controller</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/issues/42001">NodeController should add NoSchedule taints and we should get rid of getNodeConditionPredicate()</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/issues/29276">DaemonSet should respect Pod Affinity and Pod AntiAffinity</a></li>
<li>  <a href="https://github.com/kubernetes/kubernetes/pull/42028">Make DaemonSet respect critical pods annotation when scheduling</a></li>
</ul>
]]></content>
      <categories>
        <category>虚拟化</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
</search>
